<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />
    <meta name="theme-color" content="#4f9dff" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="RAVIS-冰箱助手" />
    <link rel="manifest" href="./manifest.webmanifest" />
    <link rel="icon" href="./icon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="./icon.svg" />
    <title>RAVIS-冰箱助手</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <style>
@import url("https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap");

:root {
  --bg: #eff6ff;
  --bg-soft: #dbeafe;
  --surface: rgba(255, 255, 255, 0.7);
  --surface-strong: rgba(255, 255, 255, 0.82);
  --surface-border: rgba(255, 255, 255, 0.62);
  --surface-border-strong: rgba(191, 219, 254, 0.72);

  --ink-900: #102a43;
  --ink-700: #1f4066;
  --ink-600: #355b85;
  --ink-500: #4f7299;

  --primary: #4f9dff;
  --primary-soft: #bfdbfe;
  --mint: #3f8ff0;
  --amber: #f59e0b;
  --danger: #dc5174;

  --ring: rgba(79, 157, 255, 0.3);
  --radius-xl: 32px;
  --radius-lg: 24px;
  --radius-md: 18px;
  --radius-sm: 14px;

  --shadow-xs: 0 3px 10px rgba(58, 125, 214, 0.11);
  --shadow-sm: 0 10px 30px rgba(79, 157, 255, 0.12);
  --shadow-md: 0 20px 42px rgba(79, 157, 255, 0.16);
  --shadow-lg: 0 32px 62px rgba(21, 56, 94, 0.18);

  --glass-base: rgba(255, 255, 255, 0.72);
  --glass-core: rgba(255, 255, 255, 0.82);
  --glass-edge: rgba(255, 255, 255, 0.6);

  --fridge-shell-1: #fbfdff;
  --fridge-shell-2: #dbe9ff;
  --fridge-shell-3: #c9defc;
  --fridge-shell-border: rgba(79, 157, 255, 0.32);
  --fridge-core-1: rgba(249, 253, 255, 0.97);
  --fridge-core-2: rgba(229, 240, 255, 0.94);
  --fridge-core-border: rgba(85, 153, 235, 0.3);
  --fridge-door-1: rgba(240, 248, 255, 0.94);
  --fridge-door-2: rgba(184, 215, 250, 0.88);
  --fridge-door-border: rgba(84, 146, 225, 0.34);
  --fridge-handle-1: #9dbce2;
  --fridge-handle-2: #6288b7;

  --speed-fast: 170ms;
  --speed-mid: 240ms;
  --space-1: 0.5rem;
  --space-2: 0.75rem;
  --space-3: 1rem;
  --space-4: 1.25rem;
  --space-5: 1.5rem;
  --viewport-h: 100vh;
}

@supports (height: 100dvh) {
  :root {
    --viewport-h: 100dvh;
  }
}

* {
  box-sizing: border-box;
}

html {
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
}

html,
body {
  margin: 0;
  min-height: 100%;
}

body {
  min-height: var(--viewport-h);
  color: var(--ink-900);
  font-family: "Manrope", "Noto Sans SC", sans-serif;
  line-height: 1.62;
  background:
    radial-gradient(circle at 8% 8%, rgba(191, 219, 254, 0.52) 0, transparent 38%),
    radial-gradient(circle at 92% 7%, rgba(79, 157, 255, 0.28) 0, transparent 32%),
    linear-gradient(162deg, #f8fbff 0%, #eff6ff 44%, #eaf3ff 100%);
  overscroll-behavior: contain;
  overflow-x: hidden;
  padding-top: env(safe-area-inset-top);
  padding-right: env(safe-area-inset-right);
  padding-bottom: env(safe-area-inset-bottom);
  padding-left: env(safe-area-inset-left);
}

.skip-link {
  position: fixed;
  top: 0.6rem;
  left: 0.75rem;
  transform: translateY(-160%);
  z-index: 999;
  background: #173e66;
  color: #ffffff;
  border-radius: 10px;
  padding: 0.55rem 0.8rem;
  font-weight: 700;
  text-decoration: none;
  transition: transform var(--speed-fast) ease-out;
}

.skip-link:focus-visible {
  transform: translateY(0);
}

.bg-halo,
.bg-grain {
  position: fixed;
  inset: 0;
  pointer-events: none;
}

.bg-halo {
  background:
    radial-gradient(circle at 8% 10%, rgba(191, 219, 254, 0.48), transparent 42%),
    radial-gradient(circle at 90% 8%, rgba(79, 157, 255, 0.26), transparent 38%),
    radial-gradient(circle at 76% 88%, rgba(224, 238, 255, 0.34), transparent 34%);
  z-index: -2;
  animation: spring-float 6s ease-in-out infinite alternate;
  will-change: transform;
}

.bg-grain {
  background-image: radial-gradient(rgba(18, 56, 95, 0.035) 0.82px, transparent 0.82px);
  background-size: 3px 3px;
  z-index: -1;
  opacity: 0.09;
}

.nova-app {
  width: min(1520px, calc(100% - 2rem));
  margin: 1.2rem auto 1.6rem;
  padding-bottom: max(0.24rem, env(safe-area-inset-bottom));
}

.hero-head {
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
  gap: var(--space-4);
  margin-bottom: 1.05rem;
}

h1,
h2,
h3,
h4 {
  margin: 0;
  font-family: "Manrope", "Noto Sans SC", sans-serif;
  letter-spacing: 0.005em;
  line-height: 1.3;
}

h1 {
  font-size: clamp(2rem, 2.45vw, 2.9rem);
  font-weight: 800;
  letter-spacing: 0.005em;
  color: var(--ink-900);
}

.hero-head p {
  margin: 0.3rem 0 0;
  color: var(--ink-600);
  max-width: 62ch;
  font-size: 0.95rem;
}

.kpi-strip {
  display: grid;
  grid-auto-flow: column;
  gap: var(--space-2);
}

.hero-tools {
  display: inline-grid;
  justify-items: end;
  gap: 0.48rem;
}

.locale-switch-wrap {
  display: inline-flex;
  align-items: center;
  gap: 0.42rem;
  border-radius: 999px;
  border: 1px solid var(--surface-border-strong);
  background: var(--glass-base);
  backdrop-filter: blur(24px);
  -webkit-backdrop-filter: blur(24px);
  padding: 0.22rem 0.28rem 0.22rem 0.54rem;
}

.locale-switch-wrap label {
  color: var(--ink-600);
  font-size: 0.74rem;
  font-weight: 700;
}

.locale-switch-wrap select {
  width: auto;
  min-height: 36px;
  border-radius: 999px;
  border: 1px solid rgba(137, 184, 241, 0.5);
  padding: 0.24rem 0.62rem;
  background: rgba(255, 255, 255, 0.92);
  font-size: 0.78rem;
  font-weight: 700;
}

.kpi-pill {
  border-radius: 999px;
  padding: 0.42rem 0.72rem;
  background: rgba(255, 255, 255, 0.68);
  border: 1px solid rgba(191, 219, 254, 0.78);
  color: var(--ink-700);
  font-size: 0.79rem;
  font-weight: 600;
  white-space: nowrap;
  box-shadow: 0 6px 18px rgba(79, 157, 255, 0.08);
}

.section-nav {
  position: sticky;
  top: 0.48rem;
  z-index: 60;
  margin-bottom: 0.82rem;
  padding: 0.5rem;
}

.nav-track {
  display: grid;
  gap: 0.48rem;
  grid-template-columns: repeat(5, minmax(0, 1fr));
}

.nav-chip {
  min-height: 48px;
  border-radius: 15px;
  border: 1px solid rgba(137, 184, 241, 0.58);
  background: rgba(255, 255, 255, 0.76);
  color: var(--ink-700);
  font-weight: 700;
  font-size: 0.78rem;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.36rem;
  cursor: pointer;
  transition: transform var(--speed-fast) ease-out, background var(--speed-fast) ease-out, box-shadow var(--speed-fast) ease-out;
}

.nav-chip:hover {
  transform: translateY(-1px);
  background: rgba(238, 245, 255, 0.88);
  box-shadow: var(--shadow-xs);
}

.nav-chip.active {
  border-color: var(--primary);
  background: rgba(231, 243, 255, 0.95);
  box-shadow: 0 0 0 3px rgba(79, 157, 255, 0.18);
}

.nav-chip:active {
  transform: scale(0.96);
}

.nav-chip-action {
  color: #1f4f80;
}

.nav-chip-icon {
  width: 16px;
  height: 16px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.nav-chip-icon svg {
  width: 16px;
  height: 16px;
  fill: currentColor;
}

.layout {
  display: grid;
  gap: 0.88rem;
  grid-template-columns: minmax(0, 1fr) 360px;
  align-items: start;
}

.panel {
  background: var(--surface);
  border: 1px solid var(--surface-border);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-sm);
  backdrop-filter: blur(26px) saturate(124%);
  -webkit-backdrop-filter: blur(26px) saturate(124%);
}

.left-panel,
.right-panel {
  display: grid;
  align-content: start;
  gap: 0.78rem;
  padding: 1rem;
  max-height: calc(var(--viewport-h) - 3.2rem);
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}

.center-col {
  grid-column: 1;
  grid-row: 1;
}

.left-panel {
  grid-column: 1;
  grid-row: 2;
}

.right-panel {
  grid-column: 2;
  grid-row: 1 / span 2;
  grid-template-rows: auto minmax(420px, 1fr) auto;
  align-self: start;
  position: sticky;
  top: 0.5rem;
  max-height: calc(var(--viewport-h) - 1.25rem);
}

.center-col {
  display: grid;
  gap: 0.78rem;
}

.center-col > .panel {
  padding: 0.3rem;
}

.center-bottom {
  display: grid;
  gap: 0.78rem;
  grid-template-columns: 1fr 1fr;
}

.panel-section {
  padding: 0.96rem;
  border-radius: var(--radius-lg);
  background: linear-gradient(148deg, var(--glass-core), var(--glass-base));
  border: 1px solid var(--surface-border-strong);
}

#overviewSection,
#fridgeSection,
#rescueSection,
#fleetSection,
#zoneItemsPanel,
#operationsSection {
  scroll-margin-top: 6.6rem;
}

.fleet-list,
.risk-grid,
.zone-grid,
.rescue-list,
.idea-list,
.item-list,
.library-list,
.ledger-list {
  contain: layout paint style;
}

.fleet-card,
.zone-card,
.rescue-card,
.idea-card,
.item-card,
.library-card,
.ledger-entry {
  content-visibility: auto;
  contain-intrinsic-size: 90px;
}

.lite-disclosure {
  padding-top: 0.7rem;
}

.lite-disclosure > summary {
  list-style: none;
  cursor: pointer;
  font-family: "Manrope", "Noto Sans SC", sans-serif;
  font-weight: 700;
  color: var(--ink-700);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
}

.lite-disclosure > summary::-webkit-details-marker {
  display: none;
}

.lite-disclosure > summary::after {
  content: "展开";
  font-family: "Manrope", "Noto Sans SC", sans-serif;
  font-size: 0.76rem;
  color: var(--ink-500);
  border: 1px solid rgba(147, 195, 248, 0.58);
  border-radius: 999px;
  padding: 0.08rem 0.45rem;
  background: rgba(255, 255, 255, 0.58);
}

.lite-disclosure[open] > summary::after {
  content: "收起";
}

.lite-disclosure > summary + * {
  margin-top: 0.65rem;
}

.panel-head {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 0.7rem;
}

.section-head-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.7rem;
}

.op-inline {
  display: inline-flex;
  align-items: center;
  gap: 0.42rem;
}

.operation-grid {
  margin-top: 0.65rem;
  display: grid;
  gap: 0.56rem;
  grid-template-columns: 1fr;
}

.op-btn {
  min-height: 44px;
  border: 1px solid rgba(147, 195, 248, 0.62);
  border-radius: 16px;
  background: rgba(255, 255, 255, 0.68);
  color: #1f5f99;
  font-weight: 700;
  padding: 0.45rem 0.58rem;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.42rem;
  cursor: pointer;
  transition: background var(--speed-fast) ease-out, transform var(--speed-fast) ease-out, box-shadow var(--speed-fast) ease-out;
}

.op-btn:hover {
  transform: translateY(-1px);
  background: rgba(239, 247, 255, 0.94);
  box-shadow: 0 8px 18px rgba(79, 157, 255, 0.16);
}

.op-btn:active {
  transform: scale(0.96);
}

.op-btn:disabled {
  opacity: 0.45;
  cursor: not-allowed;
  transform: none;
}

.op-btn-large {
  justify-content: flex-start;
  min-height: 44px;
}

.op-icon {
  width: 17px;
  height: 17px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.op-icon svg {
  width: 17px;
  height: 17px;
  fill: currentColor;
}

.panel-head p {
  margin: 0.22rem 0 0;
  font-size: 0.9rem;
  color: var(--ink-500);
}

.form-grid {
  display: grid;
  gap: 0.62rem;
}

.split-top {
  margin-top: 0.78rem;
  padding-top: 0.78rem;
  border-top: 1px dashed rgba(137, 184, 241, 0.56);
}

.grid-2 {
  display: grid;
  gap: 0.52rem;
  grid-template-columns: 1fr 1fr;
}

.field {
  display: grid;
  gap: 0.3rem;
}

.theme-picker {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 0.42rem;
}

.theme-chip {
  min-height: 44px;
  border-radius: 14px;
  border: 1px solid rgba(147, 195, 248, 0.62);
  background: rgba(255, 255, 255, 0.68);
  color: var(--ink-700);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.34rem;
  cursor: pointer;
  font-size: 0.78rem;
  font-weight: 700;
  padding: 0.3rem 0.4rem;
  transition: transform var(--speed-fast) ease-out, background var(--speed-fast) ease-out, border-color var(--speed-fast) ease-out;
}

.theme-chip:hover {
  transform: translateY(-1px);
  background: rgba(239, 247, 255, 0.94);
}

.theme-chip.active {
  border-color: var(--primary);
  background: rgba(237, 244, 255, 0.95);
  box-shadow: 0 0 0 3px rgba(79, 157, 255, 0.2);
}

.theme-dot {
  width: 14px;
  height: 14px;
  border-radius: 999px;
  background: var(--theme-color, #8bbcf7);
  border: 1px solid rgba(84, 145, 224, 0.28);
}

label {
  color: var(--ink-700);
  font-size: 0.81rem;
  font-weight: 700;
}

input,
select,
textarea,
button,
output {
  font: inherit;
}

button,
[role="button"],
input,
select,
textarea {
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}

input,
select,
textarea {
  width: 100%;
  min-height: 44px;
  border-radius: 14px;
  border: 1px solid rgba(147, 195, 248, 0.58);
  background: rgba(255, 255, 255, 0.82);
  color: var(--ink-900);
  padding: 0.55rem 0.72rem;
  transition:
    border-color var(--speed-fast) ease-out,
    box-shadow var(--speed-fast) ease-out,
    background var(--speed-fast) ease-out;
}

textarea {
  resize: vertical;
  min-height: 74px;
}

input::placeholder,
textarea::placeholder {
  color: #4f7299;
}

input:focus-visible,
select:focus-visible,
textarea:focus-visible,
button:focus-visible {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px var(--ring);
}

.voice-wrap {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 0.44rem;
}

.search-row {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 0.44rem;
  align-items: stretch;
}

.search-row .btn {
  min-width: 82px;
}

.chip-suggestions {
  margin-top: 0.32rem;
  display: flex;
  flex-wrap: wrap;
  gap: 0.38rem;
}

.chip-suggestion-btn {
  min-height: 40px;
  border-radius: 14px;
  border: 1px solid rgba(147, 195, 248, 0.58);
  background: rgba(255, 255, 255, 0.68);
  color: #1f5f99;
  padding: 0.24rem 0.56rem;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 0.38rem;
  transition: background var(--speed-fast) ease-out, transform var(--speed-fast) ease-out;
}

.chip-suggestion-btn:hover {
  transform: translateY(-1px);
  background: rgba(236, 246, 255, 0.9);
}

.chip-name {
  font-weight: 800;
  font-size: 0.78rem;
}

.chip-meta {
  font-size: 0.7rem;
  color: var(--ink-500);
}

.chip-suggestion-tip {
  font-size: 0.77rem;
  color: var(--ink-500);
}

.voice-btn {
  min-width: 44px;
  min-height: 44px;
  border-radius: 14px;
  border: 1px solid rgba(137, 184, 241, 0.62);
  background: linear-gradient(140deg, rgba(255, 255, 255, 0.92) 0%, rgba(232, 244, 255, 0.88) 100%);
  color: #1f5f99;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: transform var(--speed-fast) ease-out, box-shadow var(--speed-fast) ease-out;
}

.voice-btn svg {
  width: 18px;
  height: 18px;
  fill: currentColor;
}

.voice-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 22px rgba(67, 140, 235, 0.18);
}

.voice-btn.recording {
  background: linear-gradient(140deg, #d84b5e, #aa223a);
  border-color: #8b1e30;
  color: #ffffff;
}

.action-row {
  display: grid;
  gap: 0.52rem;
  grid-template-columns: repeat(2, minmax(0, 1fr));
}

.btn {
  min-height: 44px;
  border: 0;
  border-radius: 14px;
  padding: 0.56rem 0.84rem;
  font-weight: 800;
  letter-spacing: 0.01em;
  cursor: pointer;
  transition: transform var(--speed-fast) ease-out, box-shadow var(--speed-fast) ease-out, opacity var(--speed-fast) ease-out;
}

.btn:hover {
  transform: translateY(-1px);
}

.btn:active {
  transform: scale(0.95);
}

.btn:disabled {
  opacity: 0.48;
  cursor: not-allowed;
  transform: none;
}

.btn-primary {
  color: #ffffff;
  background: linear-gradient(132deg, #4f9dff 0%, #3f89ea 100%);
  box-shadow: 0 14px 28px rgba(79, 157, 255, 0.22);
}

.btn-secondary {
  color: #1f5f99;
  background: linear-gradient(140deg, rgba(255, 255, 255, 0.88), rgba(229, 242, 255, 0.86));
  border: 1px solid rgba(137, 184, 241, 0.52);
}

.btn-danger {
  color: #ffffff;
  background: linear-gradient(132deg, #ec7090, #d6476d);
  box-shadow: 0 12px 24px rgba(194, 44, 89, 0.24);
}

.btn-ghost {
  color: var(--ink-700);
  background: rgba(255, 255, 255, 0.7);
  border: 1px solid rgba(147, 195, 248, 0.58);
}

.hidden {
  display: none !important;
}

.output-box {
  min-height: 44px;
  border-radius: 14px;
  border: 1px dashed rgba(137, 184, 241, 0.66);
  background: rgba(246, 250, 255, 0.9);
  color: var(--ink-700);
  display: flex;
  align-items: center;
  padding: 0.56rem 0.72rem;
  font-weight: 700;
}

.fleet-list {
  margin-top: 0.72rem;
  display: grid;
  gap: 0.58rem;
}

.fleet-card {
  text-align: left;
  border-radius: var(--radius-md);
  border: 1px solid rgba(137, 184, 241, 0.56);
  background: linear-gradient(140deg, rgba(255, 255, 255, 0.76), rgba(238, 245, 255, 0.72));
  padding: 0.62rem;
  cursor: pointer;
  transition:
    transform var(--speed-fast) ease-out,
    box-shadow var(--speed-fast) ease-out,
    border-color var(--speed-fast) ease-out;
}

.fleet-card:hover {
  transform: translateY(-1px);
  box-shadow: 0 14px 28px rgba(67, 140, 235, 0.16);
}

.fleet-card.active {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(79, 157, 255, 0.24), 0 12px 24px rgba(67, 140, 235, 0.18);
}

.fleet-card .name {
  font-family: "Manrope", "Noto Sans SC", sans-serif;
  font-size: 0.98rem;
  color: var(--ink-900);
}

.fleet-card .meta {
  margin-top: 0.14rem;
  font-size: 0.83rem;
  color: var(--ink-500);
}

.badge-row {
  margin-top: 0.42rem;
  display: flex;
  flex-wrap: wrap;
  gap: 0.28rem;
}

.badge {
  display: inline-flex;
  align-items: center;
  border-radius: 999px;
  padding: 0.15rem 0.5rem;
  font-size: 0.71rem;
  font-weight: 700;
  color: #1f4b7a;
  background: rgba(191, 219, 254, 0.52);
}

.audit-card {
  margin-top: 0.56rem;
  border-radius: var(--radius-md);
  border: 1px solid rgba(137, 184, 241, 0.54);
  background: linear-gradient(140deg, rgba(255, 255, 255, 0.76), rgba(232, 244, 255, 0.76));
  padding: 0.66rem;
}

.audit-main {
  color: var(--ink-900);
  font-weight: 800;
  font-size: 1rem;
}

.audit-sub {
  margin-top: 0.26rem;
  color: var(--ink-600);
  font-size: 0.84rem;
}

.risk-grid {
  margin-top: 0.7rem;
  display: grid;
  gap: 0.58rem;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
}

.risk-card {
  border-radius: 18px;
  border: 1px solid rgba(137, 184, 241, 0.52);
  background: linear-gradient(145deg, rgba(255, 255, 255, 0.76), rgba(238, 245, 255, 0.72));
  padding: 0.62rem;
}

.risk-card .label {
  color: var(--ink-600);
  font-size: 0.77rem;
  font-weight: 700;
}

.risk-card .value {
  margin-top: 0.14rem;
  color: var(--ink-900);
  font-size: 1.32rem;
  font-weight: 900;
  font-family: "Manrope", "Noto Sans SC", sans-serif;
}

.risk-card .desc {
  margin-top: 0.2rem;
  color: var(--ink-500);
  font-size: 0.73rem;
}

.risk-card.critical {
  border-color: rgba(190, 62, 86, 0.34);
  background: linear-gradient(145deg, rgba(255, 247, 250, 0.95), rgba(255, 233, 239, 0.9));
}

.risk-card.rescue {
  border-color: rgba(245, 158, 11, 0.44);
  background: linear-gradient(145deg, rgba(255, 253, 245, 0.84), rgba(254, 243, 199, 0.68));
}

.risk-card.fresh {
  border-color: rgba(67, 140, 235, 0.44);
  background: linear-gradient(145deg, rgba(245, 250, 255, 0.84), rgba(191, 219, 254, 0.54));
}

.risk-card.value {
  border-color: rgba(79, 157, 255, 0.48);
}

.fridge-stage {
  margin-top: 0.66rem;
  border-radius: var(--radius-lg);
  border: 1px solid rgba(147, 195, 248, 0.58);
  background:
    radial-gradient(circle at 14% 10%, rgba(191, 219, 254, 0.48) 0 26%, transparent 50%),
    linear-gradient(140deg, rgba(249, 253, 255, 0.82), rgba(235, 244, 255, 0.76));
  padding: 0.92rem;
  position: relative;
  overflow: hidden;
  box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.55);
  backdrop-filter: blur(22px) saturate(122%);
  -webkit-backdrop-filter: blur(22px) saturate(122%);
}

.fridge-stage::before {
  content: "";
  position: absolute;
  inset: -24% -10% auto;
  height: 66%;
  background: radial-gradient(circle at 52% 34%, rgba(79, 157, 255, 0.24), transparent 64%);
  pointer-events: none;
  animation: spring-float 6s ease-in-out infinite alternate;
}

.fridge-stage::after {
  content: "";
  position: absolute;
  left: 22%;
  right: 22%;
  bottom: -28%;
  height: 56%;
  border-radius: 999px;
  background: radial-gradient(circle, rgba(191, 219, 254, 0.42), transparent 72%);
  filter: blur(18px);
  pointer-events: none;
  animation: spring-breath 4s ease-in-out infinite;
}

.fridge-stage > * {
  position: relative;
  z-index: 1;
}

.fridge-cabinet {
  width: min(100%, 920px);
  margin: 0 auto;
  min-height: 500px;
  border-radius: 38px;
  padding: 0.82rem;
  position: relative;
  perspective: 1200px;
  border: 1px solid var(--fridge-shell-border);
  background: linear-gradient(170deg, var(--fridge-shell-1) 0%, var(--fridge-shell-2) 42%, var(--fridge-shell-3) 100%);
  box-shadow: var(--shadow-lg), inset 0 0 0 1px rgba(255, 255, 255, 0.76);
  overflow: hidden;
}

.fridge-cabinet::before {
  content: "";
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0));
  pointer-events: none;
}

.fridge-core {
  min-height: 464px;
  padding: 0.8rem;
  border-radius: 30px;
  border: 1px solid var(--fridge-core-border);
  background: linear-gradient(180deg, var(--fridge-core-1), var(--fridge-core-2));
  backdrop-filter: blur(26px);
  -webkit-backdrop-filter: blur(26px);
}

.fridge-door {
  position: absolute;
  inset: 0;
  border-radius: 35px;
  border: 1px solid var(--fridge-door-border);
  background: linear-gradient(138deg, var(--fridge-door-1), var(--fridge-door-2));
  box-shadow: -16px 0 30px rgba(26, 73, 132, 0.18) inset;
  transform-origin: left center;
  transition: transform 420ms ease, opacity var(--speed-mid) ease;
  z-index: 3;
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
}

.fridge-handle {
  position: absolute;
  top: 18%;
  right: 6%;
  width: 12px;
  height: 40%;
  border-radius: 9px;
  background: linear-gradient(180deg, var(--fridge-handle-1), var(--fridge-handle-2));
  box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.6);
}

.fridge-cabinet.theme-arctic {
  --fridge-shell-1: #fbfdff;
  --fridge-shell-2: #dce9ff;
  --fridge-shell-3: #c7defd;
  --fridge-shell-border: rgba(88, 155, 239, 0.36);
  --fridge-core-1: rgba(247, 252, 255, 0.97);
  --fridge-core-2: rgba(220, 236, 255, 0.93);
  --fridge-core-border: rgba(95, 159, 238, 0.34);
  --fridge-door-1: rgba(238, 246, 255, 0.92);
  --fridge-door-2: rgba(174, 207, 248, 0.84);
  --fridge-door-border: rgba(84, 145, 224, 0.38);
  --fridge-handle-1: #99bce8;
  --fridge-handle-2: #658ab9;
}

.fridge-cabinet.theme-mint {
  --fridge-shell-1: #f5f9ff;
  --fridge-shell-2: #dce9fb;
  --fridge-shell-3: #cadcf3;
  --fridge-shell-border: rgba(97, 146, 212, 0.4);
  --fridge-core-1: rgba(247, 251, 255, 0.97);
  --fridge-core-2: rgba(221, 233, 249, 0.93);
  --fridge-core-border: rgba(102, 146, 207, 0.36);
  --fridge-door-1: rgba(238, 245, 255, 0.92);
  --fridge-door-2: rgba(170, 197, 233, 0.84);
  --fridge-door-border: rgba(88, 130, 188, 0.4);
  --fridge-handle-1: #96b4d8;
  --fridge-handle-2: #607da4;
}

.fridge-cabinet.theme-pearl {
  --fridge-shell-1: #ffffff;
  --fridge-shell-2: #edf6f3;
  --fridge-shell-3: #e4efe9;
  --fridge-shell-border: rgba(121, 162, 150, 0.32);
  --fridge-core-1: rgba(255, 255, 255, 0.97);
  --fridge-core-2: rgba(237, 248, 243, 0.93);
  --fridge-core-border: rgba(130, 166, 155, 0.34);
  --fridge-door-1: rgba(251, 255, 253, 0.92);
  --fridge-door-2: rgba(202, 223, 214, 0.84);
  --fridge-door-border: rgba(124, 164, 152, 0.36);
  --fridge-handle-1: #a1b8b0;
  --fridge-handle-2: #6d8d83;
}

.fridge-cabinet.theme-sunset {
  --fridge-shell-1: #fffaf4;
  --fridge-shell-2: #f8e8d6;
  --fridge-shell-3: #efd7be;
  --fridge-shell-border: rgba(204, 152, 103, 0.38);
  --fridge-core-1: rgba(255, 250, 245, 0.96);
  --fridge-core-2: rgba(247, 232, 214, 0.92);
  --fridge-core-border: rgba(198, 146, 97, 0.36);
  --fridge-door-1: rgba(255, 244, 230, 0.9);
  --fridge-door-2: rgba(236, 194, 153, 0.82);
  --fridge-door-border: rgba(194, 139, 92, 0.38);
  --fridge-handle-1: #d8a773;
  --fridge-handle-2: #a77a4f;
}

.fridge-cabinet.theme-rose {
  --fridge-shell-1: #fff8fc;
  --fridge-shell-2: #f5dfea;
  --fridge-shell-3: #edd0dd;
  --fridge-shell-border: rgba(190, 131, 158, 0.4);
  --fridge-core-1: rgba(255, 248, 252, 0.96);
  --fridge-core-2: rgba(244, 223, 234, 0.92);
  --fridge-core-border: rgba(182, 123, 149, 0.36);
  --fridge-door-1: rgba(253, 238, 247, 0.9);
  --fridge-door-2: rgba(226, 180, 204, 0.82);
  --fridge-door-border: rgba(181, 118, 146, 0.38);
  --fridge-handle-1: #d39ab6;
  --fridge-handle-2: #9e6b86;
}

.fridge-cabinet.theme-graphite {
  --fridge-shell-1: #f5faf8;
  --fridge-shell-2: #d8e6e1;
  --fridge-shell-3: #ccdcd7;
  --fridge-shell-border: rgba(101, 137, 127, 0.42);
  --fridge-core-1: rgba(245, 250, 248, 0.96);
  --fridge-core-2: rgba(214, 228, 223, 0.92);
  --fridge-core-border: rgba(98, 130, 120, 0.38);
  --fridge-door-1: rgba(235, 244, 240, 0.9);
  --fridge-door-2: rgba(156, 178, 170, 0.82);
  --fridge-door-border: rgba(91, 119, 109, 0.4);
  --fridge-handle-1: #8da8a0;
  --fridge-handle-2: #5f776f;
}

.fridge-cabinet.door-open .fridge-door {
  transform: rotateY(-72deg);
  opacity: 0.78;
  pointer-events: none;
}

.fridge-cabinet:not(.door-open) .zone-grid {
  filter: blur(1px);
  opacity: 0.54;
  pointer-events: none;
}

.zone-grid {
  display: grid;
  gap: 0.66rem;
  grid-template-columns: repeat(auto-fit, minmax(205px, 1fr));
  align-content: start;
  min-height: 100%;
  transition: opacity var(--speed-mid) ease, filter var(--speed-mid) ease;
}

.zone-card {
  text-align: left;
  border-radius: 20px;
  border: 1px solid rgba(137, 184, 241, 0.58);
  background: linear-gradient(145deg, rgba(255, 255, 255, 0.76), rgba(233, 244, 255, 0.68));
  padding: 0.62rem;
  cursor: pointer;
  display: grid;
  gap: 0.42rem;
  transition:
    transform var(--speed-fast) ease-out,
    box-shadow var(--speed-fast) ease-out,
    border-color var(--speed-fast) ease-out;
}

.zone-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 14px 26px rgba(67, 140, 235, 0.16);
}

.zone-card.selected {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(79, 157, 255, 0.24), 0 16px 30px rgba(67, 140, 235, 0.16);
}

.zone-head {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 0.44rem;
}

.zone-name {
  color: #1f4b7a;
  font-family: "Manrope", "Noto Sans SC", sans-serif;
  font-size: 0.96rem;
}

.zone-type {
  border-radius: 999px;
  padding: 0.12rem 0.44rem;
  font-size: 0.71rem;
  font-weight: 700;
  color: #1f4b7a;
  background: rgba(191, 219, 254, 0.56);
}

.zone-meta {
  color: #3f6c99;
  font-size: 0.79rem;
}

.capacity-track {
  width: 100%;
  height: 8px;
  border-radius: 999px;
  background: rgba(147, 195, 248, 0.3);
  overflow: hidden;
}

.capacity-fill {
  height: 100%;
  border-radius: 999px;
  background: linear-gradient(90deg, #3f8ff0, #4f9dff);
}

.zone-foot {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 0.4rem;
  font-size: 0.74rem;
  color: #355b85;
}

.zone-card.risk-expired {
  border-color: rgba(190, 62, 86, 0.36);
  background: linear-gradient(145deg, rgba(255, 247, 250, 0.95), rgba(255, 230, 236, 0.88));
}

.zone-card.risk-rescue {
  border-color: rgba(245, 158, 11, 0.4);
  background: linear-gradient(145deg, rgba(255, 253, 245, 0.84), rgba(254, 243, 199, 0.7));
}

.zone-card.risk-fresh {
  border-color: rgba(67, 140, 235, 0.42);
  background: linear-gradient(145deg, rgba(246, 250, 255, 0.84), rgba(191, 219, 254, 0.58));
}

.rescue-list,
.idea-list,
.item-list,
.ledger-list {
  display: grid;
  gap: 0.56rem;
}

.rescue-list,
.ledger-list {
  max-height: 340px;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}

.item-list {
  max-height: clamp(420px, 58vh, 860px);
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}

#zoneItemsPanel[open] {
  display: grid;
  grid-template-rows: auto minmax(0, 1fr);
}

.library-meta-row {
  margin-top: 0.76rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.52rem;
}

.library-list {
  margin-top: 0.52rem;
  display: grid;
  gap: 0.52rem;
  max-height: 320px;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}

.manual-toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.56rem;
  margin-bottom: 0.58rem;
}

.manual-intro {
  margin: 0;
  color: var(--ink-600);
  font-size: 0.82rem;
}

.manual-lang-switch {
  display: inline-grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 0.32rem;
  border-radius: 14px;
  border: 1px solid rgba(137, 184, 241, 0.54);
  background: rgba(246, 250, 255, 0.78);
  padding: 0.26rem;
}

.manual-lang-btn {
  min-height: 40px;
  border-radius: 10px;
  border: 1px solid transparent;
  background: transparent;
  color: var(--ink-600);
  font-size: 0.78rem;
  font-weight: 800;
  cursor: pointer;
  padding: 0.22rem 0.54rem;
  transition: background var(--speed-fast) ease-out, border-color var(--speed-fast) ease-out, color var(--speed-fast) ease-out;
}

.manual-lang-btn.active {
  border-color: rgba(137, 184, 241, 0.62);
  background: rgba(255, 255, 255, 0.9);
  color: #1f5f99;
}

.manual-content {
  display: grid;
  gap: 0.48rem;
}

.manual-card {
  border-radius: 16px;
  border: 1px solid rgba(137, 184, 241, 0.54);
  background: linear-gradient(145deg, rgba(255, 255, 255, 0.78), rgba(238, 245, 255, 0.72));
  padding: 0.58rem;
}

.manual-card h4 {
  margin: 0;
  font-size: 0.89rem;
  color: var(--ink-900);
}

.manual-list {
  margin: 0.36rem 0 0;
  padding-left: 1.1rem;
  display: grid;
  gap: 0.28rem;
  color: var(--ink-600);
  font-size: 0.79rem;
}

.manual-note {
  margin: 0.12rem 0 0;
  color: var(--ink-500);
  font-size: 0.75rem;
}

.library-card {
  border-radius: 18px;
  border: 1px solid rgba(137, 184, 241, 0.56);
  background: rgba(255, 255, 255, 0.74);
  padding: 0.58rem;
  display: grid;
  gap: 0.38rem;
}

.library-card.locked {
  border-color: rgba(67, 140, 235, 0.44);
  background: linear-gradient(145deg, rgba(246, 250, 255, 0.82), rgba(224, 239, 255, 0.76));
}

.library-head-row {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 0.56rem;
}

.library-name-row {
  display: inline-flex;
  align-items: center;
  gap: 0.34rem;
}

.library-name-row strong {
  color: var(--ink-900);
  font-size: 0.9rem;
}

.library-base-meta {
  margin-top: 0.14rem;
  font-size: 0.76rem;
  color: var(--ink-600);
}

.library-actions {
  display: inline-flex;
  align-items: center;
  gap: 0.32rem;
}

.library-extra {
  border-radius: 12px;
  border: 1px dashed rgba(137, 184, 241, 0.58);
  background: rgba(246, 250, 255, 0.78);
  color: var(--ink-600);
  font-size: 0.75rem;
  padding: 0.26rem 0.42rem;
}

.rescue-list {
  margin-top: 0.64rem;
}

.rescue-card {
  border-radius: var(--radius-md);
  border: 1px solid rgba(137, 184, 241, 0.56);
  background: linear-gradient(145deg, rgba(255, 255, 255, 0.76), rgba(238, 245, 255, 0.72));
  padding: 0.58rem;
  display: grid;
  gap: 0.42rem;
}

.rescue-head {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 0.42rem;
}

.rescue-item {
  font-weight: 800;
  color: var(--ink-900);
}

.rescue-meta {
  font-size: 0.79rem;
  color: var(--ink-600);
}

.severity-chip {
  border-radius: 999px;
  padding: 0.16rem 0.46rem;
  font-size: 0.7rem;
  font-weight: 800;
}

.severity-critical {
  color: #8f2742;
  background: rgba(220, 81, 116, 0.2);
}

.severity-rescue {
  color: #7b5a14;
  background: rgba(245, 158, 11, 0.24);
}

.severity-watch {
  color: #1f5f99;
  background: rgba(79, 157, 255, 0.2);
}

.severity-fresh {
  color: #1f5f99;
  background: rgba(79, 157, 255, 0.16);
}

.recommend {
  border-radius: var(--radius-sm);
  border: 1px dashed rgba(137, 184, 241, 0.58);
  background: rgba(244, 249, 255, 0.82);
  color: var(--ink-700);
  font-size: 0.76rem;
  padding: 0.3rem 0.44rem;
}

.mini-actions {
  display: grid;
  gap: 0.46rem;
  grid-template-columns: repeat(auto-fit, minmax(86px, 1fr));
}

.mini-btn {
  min-height: 40px;
  border-radius: var(--radius-sm);
  border: 1px solid rgba(137, 184, 241, 0.58);
  background: rgba(255, 255, 255, 0.74);
  color: #1f5f99;
  font-weight: 800;
  font-size: 0.76rem;
  padding: 0.2rem 0.45rem;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.28rem;
  transition: transform var(--speed-fast) ease-out, background var(--speed-fast) ease-out;
}

.mini-btn-compact {
  min-height: 38px;
  min-width: 58px;
  padding-inline: 0.38rem;
}

.mini-btn:hover {
  transform: translateY(-1px);
  background: rgba(238, 245, 255, 0.86);
}

.mini-btn:active {
  transform: scale(0.95);
}

.mini-btn.danger {
  color: #8d2f43;
  border-color: rgba(190, 62, 86, 0.38);
}

.mini-icon {
  width: 14px;
  height: 14px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.mini-icon svg {
  width: 14px;
  height: 14px;
  fill: currentColor;
}

.idea-list {
  margin-top: 0.64rem;
}

.idea-card {
  border-radius: var(--radius-md);
  border: 1px solid rgba(137, 184, 241, 0.54);
  background: linear-gradient(145deg, rgba(246, 250, 255, 0.8), rgba(221, 238, 255, 0.72));
  padding: 0.6rem;
}

.idea-title {
  color: #1f4b7a;
  font-weight: 800;
  font-size: 0.93rem;
}

.idea-desc {
  margin-top: 0.24rem;
  color: #355b85;
  font-size: 0.81rem;
}

.item-card {
  border-radius: 16px;
  border: 1px solid rgba(137, 184, 241, 0.56);
  background: linear-gradient(145deg, rgba(255, 255, 255, 0.74), rgba(238, 245, 255, 0.7));
  padding: 0.58rem;
  display: grid;
  gap: 0.42rem;
}

.item-head {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 0.42rem;
}

.item-name {
  color: var(--ink-900);
  font-weight: 900;
  font-size: 0.93rem;
}

.item-meta {
  color: var(--ink-600);
  font-size: 0.78rem;
}

.item-grid {
  display: grid;
  gap: 0.24rem 0.5rem;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  font-size: 0.76rem;
  color: var(--ink-600);
}

.ledger-summary {
  border-radius: 14px;
  border: 1px solid rgba(137, 184, 241, 0.54);
  background: rgba(246, 250, 255, 0.78);
  color: var(--ink-700);
  font-size: 0.81rem;
  padding: 0.58rem;
}

.ledger-entry {
  border-radius: 14px;
  border: 1px solid rgba(137, 184, 241, 0.52);
  background: rgba(255, 255, 255, 0.74);
  padding: 0.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 0.6rem;
  font-size: 0.78rem;
}

.ledger-entry .left {
  color: var(--ink-700);
}

.ledger-entry .right {
  color: var(--ink-600);
  text-align: right;
  font-weight: 700;
}

.empty-state {
  border-radius: 14px;
  border: 1px dashed rgba(137, 184, 241, 0.64);
  background: rgba(247, 251, 255, 0.8);
  color: var(--ink-600);
  padding: 0.72rem;
  font-size: 0.84rem;
}

body.modal-open {
  overflow: hidden;
}

.modal-root {
  position: fixed;
  inset: 0;
  z-index: 280;
  display: grid;
  place-items: center;
}

.modal-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(22, 69, 120, 0.24);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
}

.modal-stack {
  position: relative;
  width: min(680px, calc(100% - 1rem));
  max-height: calc(var(--viewport-h) - 1rem);
  overflow: auto;
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
}

.modal-card {
  background: rgba(255, 255, 255, 0.74);
  border: 1px solid rgba(137, 184, 241, 0.6);
  border-radius: 24px;
  box-shadow: var(--shadow-lg);
  padding: 0.85rem;
  backdrop-filter: blur(24px) saturate(118%);
  -webkit-backdrop-filter: blur(24px) saturate(118%);
}

.modal-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.6rem;
  margin-bottom: 0.65rem;
}

.modal-close {
  width: 36px;
  height: 36px;
  border-radius: 12px;
  border: 1px solid rgba(137, 184, 241, 0.58);
  background: rgba(255, 255, 255, 0.78);
  color: #1f5f99;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.modal-close svg {
  width: 17px;
  height: 17px;
  fill: currentColor;
}

.toast {
  position: fixed;
  left: 50%;
  bottom: 1rem;
  transform: translateX(-50%) translateY(10px);
  border-radius: 14px;
  padding: 0.64rem 0.92rem;
  background: rgba(23, 62, 102, 0.92);
  color: #ffffff;
  box-shadow: 0 18px 34px rgba(23, 62, 102, 0.34);
  opacity: 0;
  pointer-events: none;
  transition: opacity var(--speed-mid) ease, transform var(--speed-mid) ease;
  z-index: 220;
}

.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

.mobile-dock {
  display: none;
}

@keyframes fade-rise {
  from {
    opacity: 0;
    transform: translateY(6px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes spring-float {
  0% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-10px);
  }
  100% {
    transform: translateY(6px);
  }
}

@keyframes spring-breath {
  0% {
    opacity: 0.5;
    transform: scale(0.98);
  }
  50% {
    opacity: 0.75;
    transform: scale(1.04);
  }
  100% {
    opacity: 0.5;
    transform: scale(0.98);
  }
}

@media (max-width: 1480px) {
  .layout {
    grid-template-columns: minmax(0, 1fr) 340px;
  }
}

@media (max-width: 1080px) {
  .nova-app {
    width: min(100%, calc(100% - 0.8rem));
    margin: 0.52rem auto 0.9rem;
  }

  .layout {
    grid-template-columns: 1fr;
  }

  .left-panel,
  .right-panel {
    max-height: none;
    position: static;
  }

  .center-col,
  .left-panel,
  .right-panel {
    grid-column: auto;
    grid-row: auto;
  }

  .center-col {
    order: 1;
  }

  .right-panel {
    order: 2;
  }

  .left-panel {
    order: 3;
  }

  .hero-head {
    flex-direction: column;
    align-items: flex-start;
  }

  .hero-head p {
    max-width: none;
  }

  .kpi-strip {
    width: 100%;
    grid-auto-flow: row;
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .hero-tools {
    width: 100%;
    justify-items: stretch;
  }

  .locale-switch-wrap {
    width: fit-content;
  }

  .section-nav {
    position: static;
    top: auto;
  }

  .nav-track {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }

  .risk-grid {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .center-bottom {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .fridge-cabinet {
    min-height: 460px;
  }

  .fridge-core {
    min-height: 424px;
  }
}

@media (max-width: 820px) {
  .panel,
  .fridge-stage,
  .modal-card,
  .locale-switch-wrap {
    backdrop-filter: blur(14px) saturate(112%);
    -webkit-backdrop-filter: blur(14px) saturate(112%);
  }

  .center-bottom {
    grid-template-columns: 1fr;
  }

  .modal-stack {
    width: min(100%, calc(100% - 0.6rem));
    max-height: calc(var(--viewport-h) - 0.6rem);
  }

  .modal-card {
    padding: 0.7rem;
  }

  .theme-picker {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .manual-toolbar {
    align-items: flex-start;
    flex-direction: column;
  }

  .manual-lang-switch {
    width: 100%;
  }

  .item-list {
    max-height: clamp(360px, 52vh, 660px);
  }

  .section-nav {
    display: none;
  }

  .mobile-dock {
    position: fixed;
    left: max(0.5rem, env(safe-area-inset-left));
    right: max(0.5rem, env(safe-area-inset-right));
    bottom: max(0.45rem, env(safe-area-inset-bottom));
    z-index: 180;
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 0.4rem;
    border-radius: 20px;
    border: 1px solid rgba(137, 184, 241, 0.6);
    background: rgba(255, 255, 255, 0.82);
    backdrop-filter: blur(20px) saturate(112%);
    -webkit-backdrop-filter: blur(20px) saturate(112%);
    padding: 0.36rem;
  }

  .mobile-dock-btn {
    min-height: 48px;
    border-radius: 14px;
    border: 1px solid rgba(137, 184, 241, 0.46);
    background: rgba(255, 255, 255, 0.86);
    color: var(--ink-700);
    font-size: 0.67rem;
    font-weight: 700;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 0.16rem;
    cursor: pointer;
    padding: 0.25rem 0.2rem;
    transition: transform var(--speed-fast) ease-out, background var(--speed-fast) ease-out;
  }

  .mobile-dock-btn.active {
    border-color: var(--primary);
    background: rgba(228, 241, 255, 0.94);
  }

  .mobile-dock-btn:active {
    transform: scale(0.95);
  }

  .mobile-dock-btn-action {
    color: #1f4f80;
  }

  .mobile-dock-icon {
    width: 15px;
    height: 15px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .mobile-dock-icon svg {
    width: 15px;
    height: 15px;
    fill: currentColor;
  }

  .nova-app {
    padding-bottom: calc(5rem + env(safe-area-inset-bottom));
  }

  .toast {
    bottom: calc(5.2rem + env(safe-area-inset-bottom));
  }
}

@media (max-width: 720px) {
  .nova-app {
    width: calc(100% - 0.5rem);
    margin: 0.4rem auto 0.7rem;
  }

  h1 {
    font-size: clamp(1.58rem, 7.9vw, 1.98rem);
  }

  .hero-head {
    gap: 0.56rem;
    margin-bottom: 0.85rem;
  }

  .hero-head p {
    font-size: 0.84rem;
    line-height: 1.52;
  }

  .kpi-pill {
    font-size: 0.74rem;
    padding: 0.34rem 0.6rem;
  }

  .locale-switch-wrap {
    width: 100%;
    justify-content: space-between;
    border-radius: 12px;
    padding-inline: 0.52rem;
  }

  .locale-switch-wrap select {
    min-height: 40px;
    max-width: 58%;
  }

  .panel,
  .panel-section {
    border-radius: 14px;
  }

  .mobile-dock {
    left: max(0.35rem, env(safe-area-inset-left));
    right: max(0.35rem, env(safe-area-inset-right));
    gap: 0.28rem;
    border-radius: 16px;
  }

  .left-panel,
  .right-panel {
    padding: 0.72rem;
    gap: 0.7rem;
  }

  .operation-grid {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .op-btn-large {
    justify-content: center;
  }

  .modal-stack {
    width: 100%;
    max-height: var(--viewport-h);
  }

  .modal-root {
    place-items: end center;
  }

  .modal-card {
    border-radius: 16px 16px 0 0;
    padding: 0.64rem max(0.62rem, env(safe-area-inset-right)) calc(0.72rem + env(safe-area-inset-bottom))
      max(0.62rem, env(safe-area-inset-left));
  }

  .theme-picker {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }

  .grid-2,
  .action-row,
  .mini-actions,
  .item-grid,
  .search-row {
    grid-template-columns: 1fr;
  }

  .library-head-row {
    flex-direction: column;
  }

  .library-actions {
    width: 100%;
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }

  .manual-intro {
    font-size: 0.78rem;
  }

  .risk-grid {
    grid-template-columns: 1fr;
  }

  .item-list {
    max-height: 52vh;
  }

  .zone-grid {
    grid-template-columns: 1fr;
  }

  .fridge-cabinet {
    min-height: clamp(308px, 58vh, 368px);
    border-radius: 22px;
    padding: 0.68rem;
  }

  .fridge-core {
    min-height: clamp(272px, 52vh, 332px);
    border-radius: 18px;
    padding: 0.62rem;
  }
}

@media (max-width: 430px) {
  .bg-halo,
  .bg-grain {
    opacity: 0.05;
  }

  .kpi-strip {
    grid-template-columns: 1fr;
  }

  .hero-head p {
    display: none;
  }

  .section-head-row {
    align-items: flex-start;
    gap: 0.52rem;
  }

  .op-inline {
    width: 100%;
    justify-content: flex-end;
  }

  .operation-grid {
    grid-template-columns: 1fr;
  }

  .theme-picker {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .library-actions {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .item-list {
    max-height: 48vh;
  }

  .mobile-dock-btn span:last-child {
    font-size: 0.63rem;
  }
}

@media (hover: none) and (pointer: coarse) {
  .op-btn:hover,
  .btn:hover,
  .nav-chip:hover,
  .mobile-dock-btn:hover,
  .voice-btn:hover,
  .mini-btn:hover,
  .theme-chip:hover,
  .chip-suggestion-btn:hover,
  .fleet-card:hover,
  .zone-card:hover {
    transform: none;
    box-shadow: none;
  }
}

@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 1ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 1ms !important;
    scroll-behavior: auto !important;
  }
}

    </style>
  </head>
  <body>
    <a class="skip-link" href="#mainContent">跳到主要内容</a>
    <div class="bg-halo" aria-hidden="true"></div>
    <div class="bg-grain" aria-hidden="true"></div>

    <div class="nova-app">
      <header class="hero-head">
        <div>
          <h1 id="appTitle">RAVIS-冰箱助手</h1>
          <p id="appSubtitle">图标化操作 + 弹出式编辑卡片，减少界面噪音，专注“先处理临期食材”。</p>
        </div>
        <div class="hero-tools">
          <div id="globalKpi" class="kpi-strip" aria-live="polite"></div>
          <div class="locale-switch-wrap">
            <label id="localeLabel" for="localeSwitcher">语言</label>
            <select id="localeSwitcher" aria-label="切换语言">
              <option value="zh">简体中文</option>
              <option value="en">English</option>
              <option value="ja">日本語</option>
              <option value="de">Deutsch</option>
              <option value="fr">Français</option>
              <option value="es">Español</option>
              <option value="it">Italiano</option>
            </select>
          </div>
        </div>
      </header>

      <nav id="sectionNavigator" class="section-nav panel" aria-label="页面导航">
        <div class="nav-track">
          <button type="button" class="nav-chip active" data-nav-target="overviewSection" aria-label="跳转到保鲜概览">
            <span class="nav-chip-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M4 4h7v7H4V4Zm9 0h7v4h-7V4ZM4 13h4v7H4v-7Zm6 0h10v7H10v-7Z"/></svg>
            </span>
            <span>Overview</span>
          </button>
          <button type="button" class="nav-chip" data-nav-target="fridgeSection" aria-label="跳转到冰箱可视区">
            <span class="nav-chip-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M7 2a3 3 0 0 0-3 3v14a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V5a3 3 0 0 0-3-3H7Zm0 2h10a1 1 0 0 1 1 1v6H6V5a1 1 0 0 1 1-1Zm-1 9h12v6a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1v-6Z"/></svg>
            </span>
            <span>Fridge</span>
          </button>
          <button type="button" class="nav-chip" data-nav-target="rescueSection" aria-label="跳转到优先食材">
            <span class="nav-chip-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M12 3 2.3 8.4v7.2L12 21l9.7-5.4V8.4L12 3Zm-7.7 6.5L12 13.9l7.7-4.4L12 5.2 4.3 9.5Zm15.4 1.8L13 15.2v4.3l6.7-3.8v-4.4Zm-9.4 8.2v-4.3l-6.7-3.9v4.4l6.7 3.8Z"/></svg>
            </span>
            <span>Priority</span>
          </button>
          <button type="button" class="nav-chip" data-nav-target="zoneItemsPanel" aria-label="跳转到分区食材列表">
            <span class="nav-chip-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M4 4h16a2 2 0 0 1 2 2v3H2V6a2 2 0 0 1 2-2Zm-2 7h20v7a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-7Zm5 2a1 1 0 1 0 0 2h10a1 1 0 1 0 0-2H7Z"/></svg>
            </span>
            <span>Zones</span>
          </button>
          <button type="button" class="nav-chip nav-chip-action" data-nav-action="open-item-modal" aria-label="快速添加食材">
            <span class="nav-chip-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M6 2a3 3 0 0 0-3 3v2a3 3 0 0 0 3 3h1v9a3 3 0 0 0 3 3h4a3 3 0 0 0 3-3v-9h1a3 3 0 0 0 3-3V5a3 3 0 0 0-3-3H6Zm6 10a1 1 0 0 0-1 1v1h-1a1 1 0 1 0 0 2h1v1a1 1 0 1 0 2 0v-1h1a1 1 0 1 0 0-2h-1v-1a1 1 0 0 0-1-1Z"/></svg>
            </span>
            <span>Add Item</span>
          </button>
        </div>
      </nav>

      <main id="mainContent" class="layout">
        <aside id="fleetSection" class="panel left-panel" aria-label="Fridge fleet and routine">
          <section class="panel-section">
            <div class="section-head-row">
              <h2 id="fleetTitle">我的冰箱</h2>
              <div class="op-inline">
                <button id="openCreateFridgeModalBtn" type="button" class="op-btn" aria-label="新增冰箱">
                  <span class="op-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24"><path d="M7 2a3 3 0 0 0-3 3v14a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V5a3 3 0 0 0-3-3H7Zm0 2h10a1 1 0 0 1 1 1v6H6V5a1 1 0 0 1 1-1Zm-1 9h12v6a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1v-6Zm6-9a1 1 0 0 0-1 1v2H9a1 1 0 1 0 0 2h2v2a1 1 0 1 0 2 0V9h2a1 1 0 1 0 0-2h-2V5a1 1 0 0 0-1-1Z"/></svg>
                  </span>
                  <span id="openCreateFridgeLabel">新增</span>
                </button>
                <button id="openEditFridgeModalBtn" type="button" class="op-btn" aria-label="编辑当前冰箱">
                  <span class="op-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24"><path d="M15.73 3.15a3 3 0 0 1 4.24 4.24l-9.7 9.7a1 1 0 0 1-.45.26l-4 1a1 1 0 0 1-1.21-1.21l1-4a1 1 0 0 1 .26-.45l9.86-9.54ZM6.1 14.6l-.54 2.15 2.15-.54 8.9-8.9-1.6-1.6-8.9 8.9Z"/></svg>
                  </span>
                  <span id="openEditFridgeLabel">编辑</span>
                </button>
              </div>
            </div>
            <div id="fridgeFleet" class="fleet-list"></div>
          </section>

          <section class="panel-section">
            <h3 id="auditTitle">每日检查</h3>
            <div id="auditCard" class="audit-card"></div>
            <button id="completeAuditBtn" type="button" class="btn btn-secondary">完成今日检查</button>
          </section>
        </aside>

        <section class="center-col">
          <section id="overviewSection" class="panel panel-section risk-panel">
            <h2 id="riskTitle">保鲜概览</h2>
            <div id="riskOverview" class="risk-grid"></div>
          </section>

          <section id="fridgeSection" class="panel panel-section fridge-visual-panel">
            <div class="panel-head">
              <div>
                <h2 id="fridgeTitle">我的冰箱</h2>
                <p id="fridgeSubtitle">选择分区，优先处理即将过期食材。</p>
              </div>
              <button id="toggleDoorBtn" type="button" class="btn btn-secondary">关闭冰箱门</button>
            </div>

            <div class="fridge-stage">
              <div id="fridgeCabinet" class="fridge-cabinet door-open" aria-live="polite">
                <div class="fridge-door" aria-hidden="true">
                  <div class="fridge-handle"></div>
                </div>
                <div class="fridge-core">
                  <div id="zoneGrid" class="zone-grid"></div>
                </div>
              </div>
            </div>
          </section>

          <div class="center-bottom">
            <section id="rescueSection" class="panel panel-section">
              <h2 id="rescueTitle">近期优先食材</h2>
              <div id="rescueList" class="rescue-list"></div>
            </section>
            <section class="panel panel-section">
              <h2 id="ideasTitle">用餐建议</h2>
              <div id="ideaList" class="idea-list"></div>
            </section>
          </div>
        </section>

        <aside id="operationsSection" class="panel right-panel" aria-label="Execution panel">
          <section class="panel-section">
            <h2 id="quickActionsTitle">快捷操作</h2>
            <div class="operation-grid">
              <button id="openCreateZoneModalBtn" type="button" class="op-btn op-btn-large" aria-label="新增分区">
                <span class="op-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24"><path d="M3 6a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v4a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3V6Zm2 0v4a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1V6a1 1 0 0 0-1-1H6a1 1 0 0 0-1 1Zm8 0a3 3 0 0 1 3-3h2a1 1 0 1 1 0 2h-2a1 1 0 0 0-1 1v2a1 1 0 1 1-2 0V6Zm8 9a1 1 0 0 1-1 1h-2v2a1 1 0 1 1-2 0v-2h-2a1 1 0 1 1 0-2h2v-2a1 1 0 1 1 2 0v2h2a1 1 0 0 1 1 1ZM3 16a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v2a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3v-2Zm2 0v2a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1H6a1 1 0 0 0-1 1Z"/></svg>
                </span>
                <span id="openCreateZoneLabel">新增分区</span>
              </button>

              <button id="openEditZoneModalBtn" type="button" class="op-btn op-btn-large" aria-label="编辑当前分区">
                <span class="op-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24"><path d="M4 5a3 3 0 0 1 3-3h7a1 1 0 1 1 0 2H7a1 1 0 0 0-1 1v3h3a1 1 0 1 1 0 2H6v3h3a1 1 0 1 1 0 2H6v4a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-7a1 1 0 1 1 2 0v7a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V5Zm11.32 1.9a3 3 0 0 1 4.24 0l.54.54a3 3 0 0 1 0 4.24l-4.68 4.68a1 1 0 0 1-.45.26l-2.46.62a1 1 0 0 1-1.21-1.21l.62-2.46a1 1 0 0 1 .26-.45l4.68-4.68Zm2.83 1.41a1 1 0 0 0-1.42 0l-4.48 4.48-.31 1.24 1.24-.31 4.48-4.48a1 1 0 0 0 0-1.42l-.51-.51Z"/></svg>
                </span>
                <span id="openEditZoneLabel">编辑分区</span>
              </button>

              <button id="openAddItemModalBtn" type="button" class="op-btn op-btn-large" aria-label="新增食材">
                <span class="op-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24"><path d="M6 2a3 3 0 0 0-3 3v2a3 3 0 0 0 3 3h1v9a3 3 0 0 0 3 3h4a3 3 0 0 0 3-3v-9h1a3 3 0 0 0 3-3V5a3 3 0 0 0-3-3H6Zm0 2h12a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1Zm3 6h6v9a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1v-9Zm3 2a1 1 0 0 0-1 1v1h-1a1 1 0 1 0 0 2h1v1a1 1 0 1 0 2 0v-1h1a1 1 0 1 0 0-2h-1v-1a1 1 0 0 0-1-1Z"/></svg>
                </span>
                <span id="openAddItemLabel">新增食材</span>
              </button>

              <button id="openLibraryModalBtn" type="button" class="op-btn op-btn-large" aria-label="管理食材库">
                <span class="op-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24"><path d="M4 4a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v2h3a2 2 0 0 1 2 2v10a4 4 0 0 1-4 4H8a4 4 0 0 1-4-4V4Zm2 0v14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V8h-3v1a1 1 0 1 1-2 0V4H6Zm14 9a1 1 0 0 1-1 1h-2v2a1 1 0 1 1-2 0v-2h-2a1 1 0 1 1 0-2h2V10a1 1 0 1 1 2 0v2h2a1 1 0 0 1 1 1Z"/></svg>
                </span>
                <span id="openLibraryLabel">食材库</span>
              </button>

              <button id="openManualModalBtn" type="button" class="op-btn op-btn-large" aria-label="打开使用手册">
                <span class="op-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24"><path d="M4 5a3 3 0 0 1 3-3h10a3 3 0 0 1 3 3v14.5a.5.5 0 0 1-.8.4A4.98 4.98 0 0 0 16 18.5H7a3 3 0 0 1-3-3V5Zm3-1a1 1 0 0 0-1 1v10.5a1 1 0 0 0 1 1h9a7.02 7.02 0 0 1 2 .29V5a1 1 0 0 0-1-1H7Zm2 3a1 1 0 1 1 0-2h6a1 1 0 1 1 0 2H9Zm0 4a1 1 0 1 1 0-2h6a1 1 0 1 1 0 2H9Z"/></svg>
                </span>
                <span id="openManualLabel">使用手册</span>
              </button>

              <button id="openExportTxtBtn" type="button" class="op-btn op-btn-large" aria-label="导出可打印TXT清单">
                <span class="op-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24"><path d="M12 3a1 1 0 0 1 1 1v8.59l2.3-2.3a1 1 0 1 1 1.4 1.42l-4 3.95a1 1 0 0 1-1.4 0l-4-3.95a1 1 0 0 1 1.4-1.42l2.3 2.3V4a1 1 0 0 1 1-1Zm-7 14a1 1 0 0 1 1 1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-1a1 1 0 1 1 2 0v1a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3v-1a1 1 0 0 1 1-1Z"/></svg>
                </span>
                <span id="openExportTxtLabel">导出TXT清单</span>
              </button>
            </div>
          </section>

          <details id="zoneItemsPanel" class="panel-section lite-disclosure" open>
            <summary id="zoneItemsTitle">当前分区食材</summary>
            <div id="zoneItemsList" class="item-list"></div>
          </details>

          <details id="ledgerPanel" class="panel-section lite-disclosure">
            <summary id="ledgerTitle">使用记录（近30天）</summary>
            <div id="ledgerSummary" class="ledger-summary"></div>
            <div id="ledgerList" class="ledger-list"></div>
          </details>
        </aside>
      </main>

      <nav id="mobileDock" class="mobile-dock" aria-label="移动快捷导航">
        <button type="button" class="mobile-dock-btn active" data-nav-target="overviewSection" aria-label="保鲜概览">
          <span class="mobile-dock-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24"><path d="M4 4h7v7H4V4Zm9 0h7v4h-7V4ZM4 13h4v7H4v-7Zm6 0h10v7H10v-7Z"/></svg>
          </span>
          <span>Overview</span>
        </button>
        <button type="button" class="mobile-dock-btn" data-nav-target="fridgeSection" aria-label="冰箱可视区">
          <span class="mobile-dock-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24"><path d="M7 2a3 3 0 0 0-3 3v14a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V5a3 3 0 0 0-3-3H7Zm-1 3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6H6V5Zm0 8h12v6a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1v-6Z"/></svg>
          </span>
          <span>Fridge</span>
        </button>
        <button type="button" class="mobile-dock-btn" data-nav-target="zoneItemsPanel" aria-label="分区食材">
          <span class="mobile-dock-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24"><path d="M4 4h16a2 2 0 0 1 2 2v3H2V6a2 2 0 0 1 2-2Zm-2 7h20v7a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-7Z"/></svg>
          </span>
          <span>Zones</span>
        </button>
        <button type="button" class="mobile-dock-btn mobile-dock-btn-action" data-nav-action="open-item-modal" aria-label="添加食材">
          <span class="mobile-dock-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24"><path d="M12 3a1 1 0 0 1 1 1v7h7a1 1 0 1 1 0 2h-7v7a1 1 0 1 1-2 0v-7H4a1 1 0 1 1 0-2h7V4a1 1 0 0 1 1-1Z"/></svg>
          </span>
          <span>Add</span>
        </button>
      </nav>
    </div>

    <div id="modalRoot" class="modal-root hidden" aria-hidden="true">
      <div class="modal-backdrop" data-modal-close></div>
      <div class="modal-stack" role="dialog" aria-modal="true" aria-label="编辑卡片">
        <section id="modalCreateFridge" class="modal-card hidden">
          <header class="modal-head">
            <h3 id="modalCreateFridgeTitle">新增冰箱</h3>
            <button type="button" class="modal-close" data-modal-close aria-label="关闭">
              <svg viewBox="0 0 24 24"><path d="M6.7 5.3a1 1 0 0 0-1.4 1.4L10.6 12l-5.3 5.3a1 1 0 0 0 1.4 1.4l5.3-5.3 5.3 5.3a1 1 0 1 0 1.4-1.4L13.4 12l5.3-5.3a1 1 0 0 0-1.4-1.4L12 10.6 6.7 5.3Z"/></svg>
            </button>
          </header>
          <form id="createFridgeForm" class="form-grid">
            <div class="field">
              <label for="createFridgeName">冰箱名称</label>
              <div class="voice-wrap">
                <input id="createFridgeName" name="createFridgeName" type="text" required maxlength="60" placeholder="主厨房冰箱" />
                <button type="button" class="voice-btn" data-voice-target="createFridgeName" aria-label="语音输入冰箱名称" aria-pressed="false">
                  <svg viewBox="0 0 24 24"><path d="M12 3a3 3 0 0 0-3 3v5a3 3 0 1 0 6 0V6a3 3 0 0 0-3-3Zm-7 8a1 1 0 1 0-2 0 9 9 0 0 0 8 8.94V22H8a1 1 0 1 0 0 2h8a1 1 0 1 0 0-2h-3v-2.06A9 9 0 0 0 21 11a1 1 0 1 0-2 0 7 7 0 1 1-14 0Z"/></svg>
                </button>
              </div>
            </div>
            <div class="field">
              <label for="createFridgeLocation">位置</label>
              <div class="voice-wrap">
                <input id="createFridgeLocation" name="createFridgeLocation" type="text" maxlength="60" placeholder="厨房 / 办公室 / 地下室" />
                <button type="button" class="voice-btn" data-voice-target="createFridgeLocation" aria-label="语音输入冰箱位置" aria-pressed="false">
                  <svg viewBox="0 0 24 24"><path d="M12 3a3 3 0 0 0-3 3v5a3 3 0 1 0 6 0V6a3 3 0 0 0-3-3Zm-7 8a1 1 0 1 0-2 0 9 9 0 0 0 8 8.94V22H8a1 1 0 1 0 0 2h8a1 1 0 1 0 0-2h-3v-2.06A9 9 0 0 0 21 11a1 1 0 1 0-2 0 7 7 0 1 1-14 0Z"/></svg>
                </button>
              </div>
            </div>
            <button type="submit" class="btn btn-primary">创建冰箱</button>
          </form>
        </section>

        <section id="modalEditFridge" class="modal-card hidden">
          <header class="modal-head">
            <h3 id="modalEditFridgeTitle">编辑当前冰箱</h3>
            <button type="button" class="modal-close" data-modal-close aria-label="关闭">
              <svg viewBox="0 0 24 24"><path d="M6.7 5.3a1 1 0 0 0-1.4 1.4L10.6 12l-5.3 5.3a1 1 0 0 0 1.4 1.4l5.3-5.3 5.3 5.3a1 1 0 1 0 1.4-1.4L13.4 12l5.3-5.3a1 1 0 0 0-1.4-1.4L12 10.6 6.7 5.3Z"/></svg>
            </button>
          </header>
          <form id="activeFridgeForm" class="form-grid">
            <div class="field">
              <label for="activeFridgeName">名称</label>
              <div class="voice-wrap">
                <input id="activeFridgeName" name="activeFridgeName" type="text" required maxlength="60" />
                <button type="button" class="voice-btn" data-voice-target="activeFridgeName" aria-label="语音输入当前冰箱名称" aria-pressed="false">
                  <svg viewBox="0 0 24 24"><path d="M12 3a3 3 0 0 0-3 3v5a3 3 0 1 0 6 0V6a3 3 0 0 0-3-3Zm-7 8a1 1 0 1 0-2 0 9 9 0 0 0 8 8.94V22H8a1 1 0 1 0 0 2h8a1 1 0 1 0 0-2h-3v-2.06A9 9 0 0 0 21 11a1 1 0 1 0-2 0 7 7 0 1 1-14 0Z"/></svg>
                </button>
              </div>
            </div>
            <div class="field">
              <label for="activeFridgeLocation">位置</label>
              <div class="voice-wrap">
                <input id="activeFridgeLocation" name="activeFridgeLocation" type="text" maxlength="60" />
                <button type="button" class="voice-btn" data-voice-target="activeFridgeLocation" aria-label="语音输入当前冰箱位置" aria-pressed="false">
                  <svg viewBox="0 0 24 24"><path d="M12 3a3 3 0 0 0-3 3v5a3 3 0 1 0 6 0V6a3 3 0 0 0-3-3Zm-7 8a1 1 0 1 0-2 0 9 9 0 0 0 8 8.94V22H8a1 1 0 1 0 0 2h8a1 1 0 1 0 0-2h-3v-2.06A9 9 0 0 0 21 11a1 1 0 1 0-2 0 7 7 0 1 1-14 0Z"/></svg>
                </button>
              </div>
            </div>
            <div class="field">
              <label for="activeFridgeTheme">冰箱颜色</label>
              <input id="activeFridgeTheme" name="activeFridgeTheme" type="hidden" value="arctic" />
              <div id="fridgeThemePicker" class="theme-picker" role="radiogroup" aria-label="选择冰箱颜色"></div>
            </div>
            <div class="action-row">
              <button type="submit" class="btn btn-primary">保存冰箱</button>
              <button id="deleteFridgeBtn" type="button" class="btn btn-danger">清空后删除</button>
            </div>
          </form>
        </section>

        <section id="modalCreateZone" class="modal-card hidden">
          <header class="modal-head">
            <h3 id="modalCreateZoneTitle">新增分区</h3>
            <button type="button" class="modal-close" data-modal-close aria-label="关闭">
              <svg viewBox="0 0 24 24"><path d="M6.7 5.3a1 1 0 0 0-1.4 1.4L10.6 12l-5.3 5.3a1 1 0 0 0 1.4 1.4l5.3-5.3 5.3 5.3a1 1 0 1 0 1.4-1.4L13.4 12l5.3-5.3a1 1 0 0 0-1.4-1.4L12 10.6 6.7 5.3Z"/></svg>
            </button>
          </header>
          <form id="createZoneForm" class="form-grid">
            <div class="field">
              <label for="createZoneName">分区名称</label>
              <div class="voice-wrap">
                <input id="createZoneName" name="createZoneName" type="text" required maxlength="50" placeholder="蔬菜抽屉 / 饮料层" />
                <button type="button" class="voice-btn" data-voice-target="createZoneName" aria-label="语音输入分区名称" aria-pressed="false">
                  <svg viewBox="0 0 24 24"><path d="M12 3a3 3 0 0 0-3 3v5a3 3 0 1 0 6 0V6a3 3 0 0 0-3-3Zm-7 8a1 1 0 1 0-2 0 9 9 0 0 0 8 8.94V22H8a1 1 0 1 0 0 2h8a1 1 0 1 0 0-2h-3v-2.06A9 9 0 0 0 21 11a1 1 0 1 0-2 0 7 7 0 1 1-14 0Z"/></svg>
                </button>
              </div>
            </div>
            <div class="grid-2">
              <div class="field">
                <label for="createZoneType">分区类型</label>
                <select id="createZoneType" name="createZoneType">
                  <option value="vegetable">蔬菜</option>
                  <option value="protein">蛋白</option>
                  <option value="dairy">乳制品</option>
                  <option value="drinking">饮品</option>
                  <option value="leftover">剩菜</option>
                  <option value="frozen">冷冻</option>
                  <option value="snack">零食</option>
                  <option value="other">其他</option>
                </select>
              </div>
              <div class="field">
                <label for="createZoneCapacity">容量上限</label>
                <input id="createZoneCapacity" name="createZoneCapacity" type="number" min="1" max="120" step="1" value="18" inputmode="numeric" />
              </div>
            </div>
            <button type="submit" class="btn btn-primary">创建分区</button>
          </form>
        </section>

        <section id="modalEditZone" class="modal-card hidden">
          <header class="modal-head">
            <h3 id="modalEditZoneTitle">编辑当前分区</h3>
            <button type="button" class="modal-close" data-modal-close aria-label="关闭">
              <svg viewBox="0 0 24 24"><path d="M6.7 5.3a1 1 0 0 0-1.4 1.4L10.6 12l-5.3 5.3a1 1 0 0 0 1.4 1.4l5.3-5.3 5.3 5.3a1 1 0 1 0 1.4-1.4L13.4 12l5.3-5.3a1 1 0 0 0-1.4-1.4L12 10.6 6.7 5.3Z"/></svg>
            </button>
          </header>
          <form id="editZoneForm" class="form-grid">
            <div class="field">
              <label for="editZoneName">当前分区名</label>
              <div class="voice-wrap">
                <input id="editZoneName" name="editZoneName" type="text" maxlength="50" required />
                <button type="button" class="voice-btn" data-voice-target="editZoneName" aria-label="语音输入当前分区名" aria-pressed="false">
                  <svg viewBox="0 0 24 24"><path d="M12 3a3 3 0 0 0-3 3v5a3 3 0 1 0 6 0V6a3 3 0 0 0-3-3Zm-7 8a1 1 0 1 0-2 0 9 9 0 0 0 8 8.94V22H8a1 1 0 1 0 0 2h8a1 1 0 1 0 0-2h-3v-2.06A9 9 0 0 0 21 11a1 1 0 1 0-2 0 7 7 0 1 1-14 0Z"/></svg>
                </button>
              </div>
            </div>
            <div class="grid-2">
              <div class="field">
                <label for="editZoneType">类型</label>
                <select id="editZoneType" name="editZoneType">
                  <option value="vegetable">蔬菜</option>
                  <option value="protein">蛋白</option>
                  <option value="dairy">乳制品</option>
                  <option value="drinking">饮品</option>
                  <option value="leftover">剩菜</option>
                  <option value="frozen">冷冻</option>
                  <option value="snack">零食</option>
                  <option value="other">其他</option>
                </select>
              </div>
              <div class="field">
                <label for="editZoneCapacity">容量上限</label>
                <input id="editZoneCapacity" name="editZoneCapacity" type="number" min="1" max="120" step="1" inputmode="numeric" />
              </div>
            </div>
            <div class="action-row">
              <button type="submit" class="btn btn-primary">保存分区</button>
              <button id="deleteZoneBtn" type="button" class="btn btn-danger">清空后删除</button>
            </div>
          </form>
        </section>

        <section id="modalLibrary" class="modal-card hidden">
          <header class="modal-head">
            <h3 id="modalLibraryTitle">食材库管理</h3>
            <button type="button" class="modal-close" data-modal-close aria-label="关闭">
              <svg viewBox="0 0 24 24"><path d="M6.7 5.3a1 1 0 0 0-1.4 1.4L10.6 12l-5.3 5.3a1 1 0 0 0 1.4 1.4l5.3-5.3 5.3 5.3a1 1 0 1 0 1.4-1.4L13.4 12l5.3-5.3a1 1 0 0 0-1.4-1.4L12 10.6 6.7 5.3Z"/></svg>
            </button>
          </header>
          <form id="libraryForm" class="form-grid">
            <input id="libraryItemId" name="libraryItemId" type="hidden" />
            <div class="field">
              <label for="libraryName">食材名</label>
              <input id="libraryName" name="libraryName" type="text" required maxlength="50" placeholder="如：鸡蛋 / 生菜 / 酸奶" />
            </div>
            <div class="grid-2">
              <div class="field">
                <label for="libraryUnit">默认单位</label>
                <input id="libraryUnit" name="libraryUnit" type="text" required maxlength="20" value="份" />
              </div>
              <div class="field">
                <label for="libraryCategory">默认品类</label>
                <select id="libraryCategory" name="libraryCategory">
                  <option value="vegetable">蔬菜</option>
                  <option value="fruit">水果</option>
                  <option value="protein">蛋白</option>
                  <option value="dairy">乳制品</option>
                  <option value="drink">饮品</option>
                  <option value="leftover">剩菜</option>
                  <option value="snack">零食</option>
                  <option value="other">其他</option>
                </select>
              </div>
            </div>
            <div class="grid-2">
              <div class="field">
                <label for="libraryDaysValid">默认保鲜天数</label>
                <input id="libraryDaysValid" name="libraryDaysValid" type="number" min="1" max="60" step="1" value="5" inputmode="numeric" />
              </div>
              <div class="field">
                <label for="libraryAliases">别名（逗号分隔）</label>
                <input id="libraryAliases" name="libraryAliases" type="text" maxlength="120" placeholder="如：鸡子,土鸡蛋" />
              </div>
            </div>
            <div class="field">
              <label for="libraryNote">备注</label>
              <textarea id="libraryNote" name="libraryNote" rows="2" maxlength="140" placeholder="如：适合早餐，优先常温蛋"></textarea>
            </div>
            <div class="action-row">
              <button id="saveLibraryItemBtn" type="submit" class="btn btn-primary">保存到食材库</button>
              <button id="resetLibraryFormBtn" type="button" class="btn btn-ghost">清空表单</button>
            </div>
          </form>
          <div class="library-meta-row">
            <h4>经典 + 自定义食材</h4>
            <span id="libraryCount" class="badge">0</span>
          </div>
          <div id="libraryList" class="library-list"></div>
        </section>

        <section id="modalManual" class="modal-card hidden">
          <header class="modal-head">
            <h3 id="modalManualTitle">使用手册</h3>
            <button type="button" class="modal-close" data-modal-close aria-label="关闭">
              <svg viewBox="0 0 24 24"><path d="M6.7 5.3a1 1 0 0 0-1.4 1.4L10.6 12l-5.3 5.3a1 1 0 0 0 1.4 1.4l5.3-5.3 5.3 5.3a1 1 0 1 0 1.4-1.4L13.4 12l5.3-5.3a1 1 0 0 0-1.4-1.4L12 10.6 6.7 5.3Z"/></svg>
            </button>
          </header>

          <div class="manual-toolbar">
            <p id="manualIntro" class="manual-intro">从“先处理临期”开始，用最少步骤管理冰箱。</p>
          </div>
          <div id="manualContent" class="manual-content"></div>
        </section>

        <section id="modalItem" class="modal-card hidden">
          <header class="modal-head">
            <h3 id="modalItemTitle">食材编辑卡</h3>
            <button type="button" class="modal-close" data-modal-close aria-label="关闭">
              <svg viewBox="0 0 24 24"><path d="M6.7 5.3a1 1 0 0 0-1.4 1.4L10.6 12l-5.3 5.3a1 1 0 0 0 1.4 1.4l5.3-5.3 5.3 5.3a1 1 0 1 0 1.4-1.4L13.4 12l5.3-5.3a1 1 0 0 0-1.4-1.4L12 10.6 6.7 5.3Z"/></svg>
            </button>
          </header>
          <form id="itemForm" class="form-grid">
            <input id="itemId" name="itemId" type="hidden" />
            <input id="itemSourceZoneId" name="itemSourceZoneId" type="hidden" />

            <div class="field">
              <label for="itemName">食材名</label>
              <div class="voice-wrap">
                <input id="itemName" name="itemName" type="text" maxlength="60" required placeholder="牛奶 / 鸡胸肉 / 西蓝花" />
                <button type="button" class="voice-btn" data-voice-target="itemName" aria-label="语音输入食材名" aria-pressed="false">
                  <svg viewBox="0 0 24 24"><path d="M12 3a3 3 0 0 0-3 3v5a3 3 0 1 0 6 0V6a3 3 0 0 0-3-3Zm-7 8a1 1 0 1 0-2 0 9 9 0 0 0 8 8.94V22H8a1 1 0 1 0 0 2h8a1 1 0 1 0 0-2h-3v-2.06A9 9 0 0 0 21 11a1 1 0 1 0-2 0 7 7 0 1 1-14 0Z"/></svg>
                </button>
              </div>
            </div>

            <div class="field">
              <label for="itemLibraryQuery">食材库快速引用</label>
              <div class="search-row">
                <input id="itemLibraryQuery" name="itemLibraryQuery" type="text" maxlength="60" list="librarySuggestions" placeholder="输入关键字，例如：鸡蛋 / milk / 番茄" />
                <button id="applyLibraryBtn" type="button" class="btn btn-secondary">引用</button>
              </div>
              <datalist id="librarySuggestions"></datalist>
              <div id="librarySuggestionChips" class="chip-suggestions"></div>
            </div>

            <div class="grid-2">
              <div class="field">
                <label for="itemAmount">数量</label>
                <input id="itemAmount" name="itemAmount" type="number" min="0" step="0.01" value="1" required inputmode="decimal" />
              </div>
              <div class="field">
                <label for="itemUnit">单位</label>
                <div class="voice-wrap">
                  <input id="itemUnit" name="itemUnit" type="text" maxlength="20" value="份" required list="unitList" />
                  <button type="button" class="voice-btn" data-voice-target="itemUnit" aria-label="语音输入单位" aria-pressed="false">
                    <svg viewBox="0 0 24 24"><path d="M12 3a3 3 0 0 0-3 3v5a3 3 0 1 0 6 0V6a3 3 0 0 0-3-3Zm-7 8a1 1 0 1 0-2 0 9 9 0 0 0 8 8.94V22H8a1 1 0 1 0 0 2h8a1 1 0 1 0 0-2h-3v-2.06A9 9 0 0 0 21 11a1 1 0 1 0-2 0 7 7 0 1 1-14 0Z"/></svg>
                  </button>
                </div>
                <datalist id="unitList">
                  <option value="份"></option>
                  <option value="个"></option>
                  <option value="盒"></option>
                  <option value="瓶"></option>
                  <option value="袋"></option>
                  <option value="kg"></option>
                  <option value="g"></option>
                  <option value="L"></option>
                  <option value="ml"></option>
                </datalist>
              </div>
            </div>

            <div class="grid-2">
              <div class="field">
                <label for="itemAddedDate">添加日期</label>
                <input id="itemAddedDate" name="itemAddedDate" type="date" required />
              </div>
              <div class="field">
                <label for="itemExpiryDate">到期日期</label>
                <input id="itemExpiryDate" name="itemExpiryDate" type="date" required />
              </div>
            </div>

            <div class="grid-2">
              <div class="field">
                <label for="itemStatus">状态</label>
                <select id="itemStatus" name="itemStatus">
                  <option value="Auto">自动判断</option>
                  <option value="Fresh">新鲜</option>
                  <option value="Watch">需关注</option>
                  <option value="Rescue Now">优先处理</option>
                  <option value="Critical">今天处理</option>
                  <option value="Expired">已过期</option>
                  <option value="Consumed">已用完</option>
                </select>
              </div>
              <div class="field">
                <label for="itemDaysLeft">剩余有效天数</label>
                <output id="itemDaysLeft" class="output-box">--</output>
              </div>
            </div>

            <div class="grid-2">
              <div class="field">
                <label for="itemCategory">品类</label>
                <select id="itemCategory" name="itemCategory">
                  <option value="vegetable">蔬菜</option>
                  <option value="fruit">水果</option>
                  <option value="protein">蛋白</option>
                  <option value="dairy">乳制品</option>
                  <option value="drink">饮品</option>
                  <option value="leftover">剩菜</option>
                  <option value="snack">零食</option>
                  <option value="other">其他</option>
                </select>
              </div>
              <div class="field">
                <label for="itemZoneId">目标分区</label>
                <select id="itemZoneId" name="itemZoneId"></select>
              </div>
            </div>

            <div class="field">
              <label for="itemNote">备注</label>
              <div class="voice-wrap">
                <textarea id="itemNote" name="itemNote" rows="2" maxlength="140" placeholder="建议：写下用途或计划菜谱"></textarea>
                <button type="button" class="voice-btn" data-voice-target="itemNote" aria-label="语音输入备注" aria-pressed="false">
                  <svg viewBox="0 0 24 24"><path d="M12 3a3 3 0 0 0-3 3v5a3 3 0 1 0 6 0V6a3 3 0 0 0-3-3Zm-7 8a1 1 0 1 0-2 0 9 9 0 0 0 8 8.94V22H8a1 1 0 1 0 0 2h8a1 1 0 1 0 0-2h-3v-2.06A9 9 0 0 0 21 11a1 1 0 1 0-2 0 7 7 0 1 1-14 0Z"/></svg>
                </button>
              </div>
            </div>

            <div class="action-row">
              <button id="itemSubmitBtn" type="submit" class="btn btn-primary">添加食材</button>
              <button id="cancelEditItemBtn" type="button" class="btn btn-ghost hidden">取消编辑</button>
            </div>
            <button id="saveCurrentItemToLibraryBtn" type="button" class="btn btn-ghost">将当前食材保存到食材库</button>
          </form>
        </section>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <script>
"use strict";

const APP_RELEASE_VERSION = "2.5.0";
const STORAGE_SCHEMA_VERSION = 4;
const STORAGE_NAMESPACE = "homeassistant-nova";
const STORAGE_KEY = `${STORAGE_NAMESPACE}:state`;
const STORAGE_META_KEY = `${STORAGE_NAMESPACE}:meta`;
const STORAGE_BACKUP_INDEX_KEY = `${STORAGE_NAMESPACE}:backup-index`;
const STORAGE_BACKUP_PREFIX = `${STORAGE_NAMESPACE}:backup:`;
const STORAGE_VIEW_KEY = `${STORAGE_NAMESPACE}:view`;
const LEGACY_STORAGE_KEYS = ["homeassistant-nova-v2"];
const MAX_STORAGE_BACKUPS = 8;
const UPGRADE_RELOAD_GUARD_KEY = `${STORAGE_NAMESPACE}:reloaded:${APP_RELEASE_VERSION}`;
const LOCALE_STORAGE_KEY = `${STORAGE_NAMESPACE}:locale`;
const SUPPORTED_LOCALES = ["zh", "en", "ja", "de", "fr", "es", "it"];
const DEFAULT_LOCALE = "zh";
const DAY_MS = 24 * 60 * 60 * 1000;

const I18N_TEXT_KEYS = [
  "app_title",
  "app_subtitle",
  "locale_label",
  "fleet_title",
  "btn_add",
  "btn_edit",
  "audit_title",
  "audit_complete",
  "risk_title",
  "rescue_title",
  "ideas_title",
  "quick_actions_title",
  "btn_create_zone",
  "btn_edit_zone",
  "btn_add_item",
  "btn_library",
  "btn_manual",
  "btn_export_txt",
  "zone_items_title",
  "ledger_title",
  "modal_create_fridge_title",
  "modal_edit_fridge_title",
  "modal_create_zone_title",
  "modal_edit_zone_title",
  "modal_library_title",
  "modal_manual_title",
  "modal_item_title",
  "toggle_close_door",
  "toggle_open_door",
  "kpi_items",
  "kpi_rescue",
  "kpi_expired",
  "kpi_wasted_30",
  "empty_no_fridge",
  "empty_no_zone",
  "empty_no_idea",
  "empty_no_log",
  "label_other",
  "label_default",
  "label_day",
  "manual_intro",
  "export_title",
  "export_generated_at",
  "export_no_data",
  "export_done",
  "export_fridge",
  "export_zone",
  "export_items",
  "export_empty_zone",
  "locale_option_zh",
  "locale_option_en",
  "locale_option_ja",
  "locale_option_de",
  "locale_option_fr",
  "locale_option_es",
  "locale_option_it",
];

const ZONE_TYPE_KEYS = ["vegetable", "protein", "dairy", "drinking", "leftover", "frozen", "snack", "other"];
const CATEGORY_KEYS = ["vegetable", "fruit", "protein", "dairy", "drink", "leftover", "snack", "other"];
const STATUS_KEYS = ["Auto", "Fresh", "Watch", "Rescue Now", "Critical", "Expired", "Consumed"];
const THEME_KEYS = ["arctic", "mint", "pearl", "sunset", "rose", "graphite"];
const LOCALE_FILE_BASE = "./locales";
const LOCALE_FETCH_TIMEOUT_MS = 4200;

function compactArrayToMap(keys, values) {
  const list = Array.isArray(values) ? values : [];
  const out = {};
  keys.forEach((key, index) => {
    out[key] = cleanText(list[index]) || "";
  });
  return out;
}

function compactManualToObject(rows, note) {
  const sections = Array.isArray(rows)
    ? rows
        .map((row) => {
          if (!Array.isArray(row) || !row.length) return null;
          const [title, orderedFlag, items] = row;
          return {
            title: cleanText(title),
            ordered: orderedFlag === 1,
            items: Array.isArray(items) ? items.map((item) => cleanText(item)).filter(Boolean) : [],
          };
        })
        .filter(Boolean)
    : [];

  return {
    sections,
    note: cleanText(note),
  };
}

const DEFAULT_COMPACT_LOCALE_ZH = {"v":1,"t":["RAVIS-冰箱助手","图标化操作 + 弹出式编辑卡片，减少界面噪音，专注“先处理临期食材”。","语言","我的冰箱","新增","编辑","每日检查","完成今日检查","保鲜概览","近期优先食材","用餐建议","快捷操作","新增分区","编辑分区","新增食材","食材库","使用手册","导出TXT清单","当前分区食材","使用记录（近30天）","新增冰箱","编辑当前冰箱","新增分区","编辑当前分区","食材库管理","使用手册 / Manual","食材编辑卡","关闭冰箱门","打开冰箱门","食材","临期","过期","30天丢弃","暂无冰箱，请先创建。","暂无分区。","暂无建议。","暂无记录。","其他","默认","天","从“先处理临期”开始，用最少步骤管理冰箱。","冰箱库存打印清单","导出时间","暂无可导出的库存数据。","TXT清单已导出。","冰箱","分区","食材数","该分区暂无食材","简体中文","English","日本語","Deutsch","Français","Español","Italiano"],"z":["蔬菜","蛋白","乳制品","饮品","剩菜","冷冻","零食","其他"],"c":["蔬菜","水果","蛋白","乳制品","饮品","剩菜","零食","其他"],"s":["自动判断","新鲜","需关注","优先处理","今天处理","已过期","已用完"],"th":["极地银","薄荷绿","珍珠白","暖杏橙","雾粉","石墨灰"],"m":[["1. 快速开始",1,["新建冰箱并确认默认分区。","点“新增食材”或从“食材库”快速引用。","每天查看“近期优先食材”，优先处理临期条目。"]],["2. 核心操作",0,["分区支持选中、编辑，且仅在清空后删除。","食材可跨分区移动，状态可自动判断或手动覆盖。","支持语音录入食材名、单位、备注。","可切换冰箱颜色主题，便于多冰箱辨识。"]],["3. 数据安全",0,["数据存储在本机浏览器 localStorage。","版本升级前自动写入备份区并迁移。","迁移异常时优先尝试最近备份恢复。"]]],"n":"提示：避免长期在隐私模式使用，清理浏览器存储会导致数据丢失。"};

const FRIDGE_THEME_OPTIONS = [
  { id: "arctic", preview: "#8bbcf7", label: "极地银" },
  { id: "mint", preview: "#7fa9dc", label: "薄荷绿" },
  { id: "pearl", preview: "#d8e6fa", label: "珍珠白" },
  { id: "sunset", preview: "#d8a873", label: "暖杏橙" },
  { id: "rose", preview: "#d39ab6", label: "雾粉" },
  { id: "graphite", preview: "#7d92b1", label: "石墨灰" },
];

const DEFAULT_FRIDGE_THEME = "arctic";

const I18N = {
  zh: compactArrayToMap(I18N_TEXT_KEYS, DEFAULT_COMPACT_LOCALE_ZH.t),
};

const MANUAL_CONTENT = {
  zh: compactManualToObject(DEFAULT_COMPACT_LOCALE_ZH.m, DEFAULT_COMPACT_LOCALE_ZH.n),
};

const ZONE_TYPE_LABEL = {
  zh: compactArrayToMap(ZONE_TYPE_KEYS, DEFAULT_COMPACT_LOCALE_ZH.z),
};

const CATEGORY_LABEL = {
  zh: compactArrayToMap(CATEGORY_KEYS, DEFAULT_COMPACT_LOCALE_ZH.c),
};

const STATUS_LABEL = {
  zh: compactArrayToMap(STATUS_KEYS, DEFAULT_COMPACT_LOCALE_ZH.s),
};

const FRIDGE_THEME_LABELS = {
  zh: compactArrayToMap(THEME_KEYS, DEFAULT_COMPACT_LOCALE_ZH.th),
};

const LOCALE_PACK_CACHE = {
  zh: true,
};

const LOCALE_PACK_LOADING = Object.create(null);

const DEFAULT_ZONE_TEMPLATES = [
  { name: "蔬菜抽屉", type: "vegetable", capacity: 20 },
  { name: "乳制品层", type: "dairy", capacity: 14 },
  { name: "剩菜层", type: "leftover", capacity: 10 },
  { name: "饮品层", type: "drinking", capacity: 16 },
  { name: "蛋白冷藏层", type: "protein", capacity: 12 },
];

const DEFAULT_ITEMS_BY_ZONE_TYPE = {
  vegetable: [
    { name: "菠菜", amount: 1, unit: "袋", category: "vegetable", daysValid: 2, note: "优先清炒" },
    { name: "西蓝花", amount: 1, unit: "颗", category: "vegetable", daysValid: 3, note: "可焯水备餐" },
  ],
  dairy: [
    { name: "鲜牛奶", amount: 2, unit: "瓶", category: "dairy", daysValid: 3, note: "早餐优先" },
    { name: "原味酸奶", amount: 3, unit: "杯", category: "dairy", daysValid: 5, note: "可搭配水果" },
  ],
  leftover: [
    { name: "昨晚熟食", amount: 1, unit: "盒", category: "leftover", daysValid: 1, note: "今天优先吃完" },
  ],
  drinking: [
    { name: "冷萃咖啡", amount: 1, unit: "瓶", category: "drink", daysValid: 2, note: "开封后尽快喝完" },
    { name: "气泡水", amount: 4, unit: "罐", category: "drink", daysValid: 10, note: "非紧急" },
  ],
  protein: [
    { name: "鸡胸肉", amount: 2, unit: "包", category: "protein", daysValid: 2, note: "可提前腌制" },
  ],
};

const DEFAULT_INGREDIENT_LIBRARY_TEMPLATES = [
  { name: "鸡蛋", aliases: ["蛋", "鸡子"], unit: "个", category: "protein", defaultDaysValid: 14, note: "早餐常备", locked: true },
  { name: "鲜牛奶", aliases: ["牛奶", "milk"], unit: "瓶", category: "dairy", defaultDaysValid: 4, note: "开封后优先喝完", locked: true },
  { name: "酸奶", aliases: ["yogurt"], unit: "杯", category: "dairy", defaultDaysValid: 6, note: "可搭配水果", locked: true },
  { name: "鸡胸肉", aliases: ["鸡肉"], unit: "包", category: "protein", defaultDaysValid: 2, note: "可提前分装", locked: true },
  { name: "猪里脊", aliases: ["里脊"], unit: "包", category: "protein", defaultDaysValid: 2, note: "建议冷冻备用", locked: true },
  { name: "生菜", aliases: ["lettuce"], unit: "颗", category: "vegetable", defaultDaysValid: 3, note: "优先凉拌", locked: true },
  { name: "菠菜", aliases: ["spinach"], unit: "袋", category: "vegetable", defaultDaysValid: 2, note: "易变质，尽快处理", locked: true },
  { name: "西蓝花", aliases: ["broccoli"], unit: "颗", category: "vegetable", defaultDaysValid: 4, note: "可焯水备餐", locked: true },
  { name: "番茄", aliases: ["西红柿", "tomato"], unit: "个", category: "vegetable", defaultDaysValid: 5, note: "沙拉/炒菜通用", locked: true },
  { name: "黄瓜", aliases: ["cucumber"], unit: "根", category: "vegetable", defaultDaysValid: 5, note: "可做凉拌", locked: true },
  { name: "苹果", aliases: ["apple"], unit: "个", category: "fruit", defaultDaysValid: 12, note: "常规水果", locked: true },
  { name: "香蕉", aliases: ["banana"], unit: "根", category: "fruit", defaultDaysValid: 4, note: "熟得快，注意临期", locked: true },
  { name: "蓝莓", aliases: ["blueberry"], unit: "盒", category: "fruit", defaultDaysValid: 4, note: "开盒后尽快吃", locked: true },
  { name: "豆腐", aliases: ["tofu"], unit: "盒", category: "protein", defaultDaysValid: 2, note: "可做汤或煎制", locked: true },
  { name: "冷萃咖啡", aliases: ["咖啡", "cold brew"], unit: "瓶", category: "drink", defaultDaysValid: 3, note: "开封后尽快饮用", locked: true },
  { name: "果汁", aliases: ["juice"], unit: "瓶", category: "drink", defaultDaysValid: 5, note: "开封后冷藏", locked: true },
  { name: "隔夜熟食", aliases: ["剩菜", "熟食"], unit: "盒", category: "leftover", defaultDaysValid: 1, note: "当天优先吃完", locked: true },
];

const MAX_RENDERED_RESCUE = 8;
const MAX_RENDERED_ZONE_ITEMS = 40;
const MAX_RENDERED_LEDGER = 20;
const MAX_INGREDIENT_LIBRARY = 240;
const MAX_LIBRARY_SUGGESTIONS = 8;
const MAX_LIBRARY_LIST = 120;
const MAX_FRIDGES = 12;
const MAX_ZONES_PER_FRIDGE = 28;
const MAX_ITEMS_PER_ZONE = 260;
const MAX_TOTAL_ITEMS = MAX_FRIDGES * MAX_ZONES_PER_FRIDGE * 80;
const DEFAULT_SAVE_DELAY_MS = 220;
const MAX_DAYS_LEFT_CACHE = 320;

const ui = {
  doorOpen: true,
  toastTimer: null,
  speech: null,
  recordingButton: null,
  libraryQueryTimer: null,
  deferredSaveTimer: null,
  deferredSaveIdleId: null,
  stateDirty: false,
  renderQueued: false,
  daysCacheDate: "",
  daysCacheTodayMs: 0,
  daysLeftCache: new Map(),
  sectionObserver: null,
  activeModalId: null,
  lastFocusedElement: null,
  startupNotice: "",
  needsUpgradeReload: false,
  locale: loadPreferredLocale(),
};

const els = {
  appTitle: document.getElementById("appTitle"),
  appSubtitle: document.getElementById("appSubtitle"),
  sectionNavigator: document.getElementById("sectionNavigator"),
  mobileDock: document.getElementById("mobileDock"),
  localeLabel: document.getElementById("localeLabel"),
  localeSwitcher: document.getElementById("localeSwitcher"),
  openCreateFridgeModalBtn: document.getElementById("openCreateFridgeModalBtn"),
  openEditFridgeModalBtn: document.getElementById("openEditFridgeModalBtn"),
  openCreateZoneModalBtn: document.getElementById("openCreateZoneModalBtn"),
  openEditZoneModalBtn: document.getElementById("openEditZoneModalBtn"),
  openAddItemModalBtn: document.getElementById("openAddItemModalBtn"),
  openLibraryModalBtn: document.getElementById("openLibraryModalBtn"),
  openManualModalBtn: document.getElementById("openManualModalBtn"),
  openExportTxtBtn: document.getElementById("openExportTxtBtn"),
  fleetTitle: document.getElementById("fleetTitle"),
  openCreateFridgeLabel: document.getElementById("openCreateFridgeLabel"),
  openEditFridgeLabel: document.getElementById("openEditFridgeLabel"),
  auditTitle: document.getElementById("auditTitle"),
  createFridgeForm: document.getElementById("createFridgeForm"),
  createFridgeName: document.getElementById("createFridgeName"),
  createFridgeLocation: document.getElementById("createFridgeLocation"),
  fridgeFleet: document.getElementById("fridgeFleet"),
  auditCard: document.getElementById("auditCard"),
  completeAuditBtn: document.getElementById("completeAuditBtn"),
  activeFridgeForm: document.getElementById("activeFridgeForm"),
  activeFridgeName: document.getElementById("activeFridgeName"),
  activeFridgeLocation: document.getElementById("activeFridgeLocation"),
  activeFridgeTheme: document.getElementById("activeFridgeTheme"),
  fridgeThemePicker: document.getElementById("fridgeThemePicker"),
  deleteFridgeBtn: document.getElementById("deleteFridgeBtn"),
  globalKpi: document.getElementById("globalKpi"),
  riskTitle: document.getElementById("riskTitle"),
  riskOverview: document.getElementById("riskOverview"),
  fridgeTitle: document.getElementById("fridgeTitle"),
  fridgeSubtitle: document.getElementById("fridgeSubtitle"),
  toggleDoorBtn: document.getElementById("toggleDoorBtn"),
  fridgeCabinet: document.getElementById("fridgeCabinet"),
  zoneGrid: document.getElementById("zoneGrid"),
  rescueTitle: document.getElementById("rescueTitle"),
  rescueList: document.getElementById("rescueList"),
  ideasTitle: document.getElementById("ideasTitle"),
  ideaList: document.getElementById("ideaList"),
  quickActionsTitle: document.getElementById("quickActionsTitle"),
  openCreateZoneLabel: document.getElementById("openCreateZoneLabel"),
  openEditZoneLabel: document.getElementById("openEditZoneLabel"),
  openAddItemLabel: document.getElementById("openAddItemLabel"),
  openLibraryLabel: document.getElementById("openLibraryLabel"),
  openManualLabel: document.getElementById("openManualLabel"),
  openExportTxtLabel: document.getElementById("openExportTxtLabel"),
  createZoneForm: document.getElementById("createZoneForm"),
  createZoneName: document.getElementById("createZoneName"),
  createZoneType: document.getElementById("createZoneType"),
  createZoneCapacity: document.getElementById("createZoneCapacity"),
  editZoneForm: document.getElementById("editZoneForm"),
  editZoneName: document.getElementById("editZoneName"),
  editZoneType: document.getElementById("editZoneType"),
  editZoneCapacity: document.getElementById("editZoneCapacity"),
  deleteZoneBtn: document.getElementById("deleteZoneBtn"),
  itemForm: document.getElementById("itemForm"),
  itemId: document.getElementById("itemId"),
  itemSourceZoneId: document.getElementById("itemSourceZoneId"),
  itemName: document.getElementById("itemName"),
  itemLibraryQuery: document.getElementById("itemLibraryQuery"),
  applyLibraryBtn: document.getElementById("applyLibraryBtn"),
  librarySuggestions: document.getElementById("librarySuggestions"),
  librarySuggestionChips: document.getElementById("librarySuggestionChips"),
  itemAmount: document.getElementById("itemAmount"),
  itemUnit: document.getElementById("itemUnit"),
  itemAddedDate: document.getElementById("itemAddedDate"),
  itemExpiryDate: document.getElementById("itemExpiryDate"),
  itemStatus: document.getElementById("itemStatus"),
  itemDaysLeft: document.getElementById("itemDaysLeft"),
  itemCategory: document.getElementById("itemCategory"),
  itemZoneId: document.getElementById("itemZoneId"),
  itemNote: document.getElementById("itemNote"),
  itemSubmitBtn: document.getElementById("itemSubmitBtn"),
  cancelEditItemBtn: document.getElementById("cancelEditItemBtn"),
  saveCurrentItemToLibraryBtn: document.getElementById("saveCurrentItemToLibraryBtn"),
  zoneItemsTitle: document.getElementById("zoneItemsTitle"),
  ledgerTitle: document.getElementById("ledgerTitle"),
  zoneItemsList: document.getElementById("zoneItemsList"),
  ledgerSummary: document.getElementById("ledgerSummary"),
  ledgerList: document.getElementById("ledgerList"),
  modalRoot: document.getElementById("modalRoot"),
  modalCreateFridge: document.getElementById("modalCreateFridge"),
  modalEditFridge: document.getElementById("modalEditFridge"),
  modalCreateZone: document.getElementById("modalCreateZone"),
  modalEditZone: document.getElementById("modalEditZone"),
  modalLibrary: document.getElementById("modalLibrary"),
  modalManual: document.getElementById("modalManual"),
  modalItem: document.getElementById("modalItem"),
  modalCreateFridgeTitle: document.getElementById("modalCreateFridgeTitle"),
  modalEditFridgeTitle: document.getElementById("modalEditFridgeTitle"),
  modalCreateZoneTitle: document.getElementById("modalCreateZoneTitle"),
  modalEditZoneTitle: document.getElementById("modalEditZoneTitle"),
  modalLibraryTitle: document.getElementById("modalLibraryTitle"),
  modalManualTitle: document.getElementById("modalManualTitle"),
  modalItemTitle: document.getElementById("modalItemTitle"),
  manualIntro: document.getElementById("manualIntro"),
  manualContent: document.getElementById("manualContent"),
  libraryForm: document.getElementById("libraryForm"),
  libraryItemId: document.getElementById("libraryItemId"),
  libraryName: document.getElementById("libraryName"),
  libraryUnit: document.getElementById("libraryUnit"),
  libraryCategory: document.getElementById("libraryCategory"),
  libraryDaysValid: document.getElementById("libraryDaysValid"),
  libraryAliases: document.getElementById("libraryAliases"),
  libraryNote: document.getElementById("libraryNote"),
  saveLibraryItemBtn: document.getElementById("saveLibraryItemBtn"),
  resetLibraryFormBtn: document.getElementById("resetLibraryFormBtn"),
  libraryCount: document.getElementById("libraryCount"),
  libraryList: document.getElementById("libraryList"),
  modalCloseTriggers: Array.from(document.querySelectorAll("[data-modal-close]")),
  toast: document.getElementById("toast"),
  voiceButtons: Array.from(document.querySelectorAll("[data-voice-target]")),
};

let state = loadState();

bindEvents();
setupSpeechRecognition();
bootstrapApp();

async function bootstrapApp() {
  const loaded = await ensureLocalePackLoaded(getCurrentLocale());
  if (!loaded) {
    ui.locale = DEFAULT_LOCALE;
    persistPreferredLocale(DEFAULT_LOCALE);
  }
  applyLocaleToUI();
  ensureSelectionIntegrity();
  resetItemForm();
  render();
  setupNavigatorObserver();
  runStartupSafetyFlow();
}

function bindEvents() {
  els.localeSwitcher.addEventListener("change", onLocaleChange);
  if (els.sectionNavigator) {
    els.sectionNavigator.addEventListener("click", onNavigatorAction);
  }
  if (els.mobileDock) {
    els.mobileDock.addEventListener("click", onNavigatorAction);
  }
  els.openCreateFridgeModalBtn.addEventListener("click", () => openModal("createFridge"));
  els.openEditFridgeModalBtn.addEventListener("click", () => openModal("editFridge"));
  els.openCreateZoneModalBtn.addEventListener("click", () => openModal("createZone"));
  els.openEditZoneModalBtn.addEventListener("click", () => openModal("editZone"));
  els.openAddItemModalBtn.addEventListener("click", () => openModal("item"));
  els.openLibraryModalBtn.addEventListener("click", () => openModal("library"));
  els.openManualModalBtn.addEventListener("click", () => openModal("manual"));
  els.openExportTxtBtn.addEventListener("click", onExportInventoryTxt);

  els.modalCloseTriggers.forEach((trigger) => {
    trigger.addEventListener("click", closeModal);
  });

  document.addEventListener("keydown", onGlobalKeydown);
  window.addEventListener("beforeunload", flushDeferredSaveState);

  els.createFridgeForm.addEventListener("submit", onCreateFridge);
  els.fridgeFleet.addEventListener("click", onSelectFridge);
  els.completeAuditBtn.addEventListener("click", onCompleteAudit);
  els.activeFridgeForm.addEventListener("submit", onSaveActiveFridge);
  els.fridgeThemePicker.addEventListener("click", onSelectFridgeTheme);
  els.deleteFridgeBtn.addEventListener("click", onDeleteFridge);
  els.toggleDoorBtn.addEventListener("click", onToggleDoor);

  els.createZoneForm.addEventListener("submit", onCreateZone);
  els.editZoneForm.addEventListener("submit", onSaveZone);
  els.deleteZoneBtn.addEventListener("click", onDeleteZone);

  els.zoneGrid.addEventListener("click", onSelectZone);
  els.rescueList.addEventListener("click", onActionFromList);
  els.zoneItemsList.addEventListener("click", onActionFromList);

  els.itemForm.addEventListener("submit", onSaveItem);
  els.cancelEditItemBtn.addEventListener("click", () => {
    resetItemForm(true);
    closeModal();
  });
  els.applyLibraryBtn.addEventListener("click", onApplyLibraryFromQuery);
  els.itemLibraryQuery.addEventListener("input", onLibraryQueryInput);
  els.librarySuggestionChips.addEventListener("click", onLibraryChipClick);
  els.saveCurrentItemToLibraryBtn.addEventListener("click", onSaveCurrentItemToLibrary);

  els.libraryForm.addEventListener("submit", onSaveLibraryItem);
  els.resetLibraryFormBtn.addEventListener("click", resetLibraryForm);
  els.libraryList.addEventListener("click", onLibraryListAction);

  ["input", "change"].forEach((evt) => {
    els.itemAmount.addEventListener(evt, refreshItemDerivedOutputs);
    els.itemExpiryDate.addEventListener(evt, refreshItemDerivedOutputs);
    els.itemAddedDate.addEventListener(evt, refreshItemDerivedOutputs);
  });

  els.voiceButtons.forEach((button) => {
    button.addEventListener("click", () => onToggleVoice(button));
  });
}

function onGlobalKeydown(event) {
  if (event.key === "Escape" && ui.activeModalId) {
    closeModal();
  }
}

function onNavigatorAction(event) {
  const button = event.target.closest("[data-nav-target], [data-nav-action]");
  if (!button) return;

  const navAction = cleanText(button.getAttribute("data-nav-action"));
  if (navAction === "open-item-modal") {
    openModal("item");
    return;
  }

  const targetId = cleanText(button.getAttribute("data-nav-target"));
  if (!targetId) return;
  const target = document.getElementById(targetId);
  if (!target) return;

  if (target instanceof HTMLDetailsElement) {
    target.open = true;
  }

  const prefersReducedMotion = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
  target.scrollIntoView({
    behavior: prefersReducedMotion ? "auto" : "smooth",
    block: "start",
  });

  setNavigatorActive(targetId);
}

function setNavigatorActive(targetId) {
  const normalized = cleanText(targetId);
  if (!normalized) return;

  const navButtons = document.querySelectorAll(".nav-chip[data-nav-target], .mobile-dock-btn[data-nav-target]");
  navButtons.forEach((button) => {
    const currentTarget = cleanText(button.getAttribute("data-nav-target"));
    button.classList.toggle("active", currentTarget === normalized);
  });
}

function setupNavigatorObserver() {
  if (typeof IntersectionObserver !== "function") return;
  if (ui.sectionObserver) {
    ui.sectionObserver.disconnect();
    ui.sectionObserver = null;
  }

  const trackIds = ["overviewSection", "fridgeSection", "rescueSection", "zoneItemsPanel", "fleetSection"];
  const targets = trackIds.map((id) => document.getElementById(id)).filter(Boolean);
  if (!targets.length) return;

  ui.sectionObserver = new IntersectionObserver(
    (entries) => {
      const visible = entries
        .filter((entry) => entry.isIntersecting)
        .sort((a, b) => b.intersectionRatio - a.intersectionRatio);
      if (!visible.length) return;
      const candidate = visible[0].target;
      if (candidate?.id) {
        setNavigatorActive(candidate.id);
      }
    },
    {
      root: null,
      rootMargin: "-28% 0px -52% 0px",
      threshold: [0.08, 0.22, 0.4, 0.6],
    }
  );

  targets.forEach((target) => ui.sectionObserver.observe(target));
}

function scheduleDeferredSaveState(delayMs = DEFAULT_SAVE_DELAY_MS) {
  const delay = clamp(Math.round(toNumber(delayMs, DEFAULT_SAVE_DELAY_MS)), 16, 3000);
  if (ui.deferredSaveTimer) {
    clearTimeout(ui.deferredSaveTimer);
  }

  if (ui.deferredSaveIdleId && typeof cancelIdleCallback === "function") {
    cancelIdleCallback(ui.deferredSaveIdleId);
    ui.deferredSaveIdleId = null;
  }

  ui.deferredSaveTimer = setTimeout(() => {
    ui.deferredSaveTimer = null;
    if (typeof requestIdleCallback === "function") {
      ui.deferredSaveIdleId = requestIdleCallback(() => {
        ui.deferredSaveIdleId = null;
        saveState();
      }, { timeout: 1200 });
      return;
    }
    saveState();
  }, delay);
}

function flushDeferredSaveState() {
  if (ui.deferredSaveTimer) {
    clearTimeout(ui.deferredSaveTimer);
    ui.deferredSaveTimer = null;
  }
  if (ui.deferredSaveIdleId && typeof cancelIdleCallback === "function") {
    cancelIdleCallback(ui.deferredSaveIdleId);
    ui.deferredSaveIdleId = null;
  }
  saveState();
}

function normalizeLocale(input) {
  const token = cleanText(input).toLowerCase();
  return SUPPORTED_LOCALES.includes(token) ? token : DEFAULT_LOCALE;
}

function loadPreferredLocale() {
  try {
    const saved = normalizeLocale(localStorage.getItem(LOCALE_STORAGE_KEY));
    if (saved !== DEFAULT_LOCALE || cleanText(localStorage.getItem(LOCALE_STORAGE_KEY)) === DEFAULT_LOCALE) {
      return saved;
    }
  } catch (_err) {
    // Ignore locale read errors.
  }

  const nav = cleanText(navigator.language || navigator.userLanguage).toLowerCase();
  if (!nav) return DEFAULT_LOCALE;
  if (nav.startsWith("zh")) return "zh";
  if (nav.startsWith("ja")) return "ja";
  if (nav.startsWith("de")) return "de";
  if (nav.startsWith("fr")) return "fr";
  if (nav.startsWith("es")) return "es";
  if (nav.startsWith("it")) return "it";
  if (nav.startsWith("en")) return "en";
  return DEFAULT_LOCALE;
}

function persistPreferredLocale(locale) {
  try {
    localStorage.setItem(LOCALE_STORAGE_KEY, locale);
  } catch (_err) {
    // Ignore locale save errors.
  }
}

function getCurrentLocale() {
  return normalizeLocale(ui.locale);
}

function localeBundleFromCompact(payload) {
  if (!payload || payload.v !== 1) return null;
  return {
    text: compactArrayToMap(I18N_TEXT_KEYS, payload.t),
    zone: compactArrayToMap(ZONE_TYPE_KEYS, payload.z),
    category: compactArrayToMap(CATEGORY_KEYS, payload.c),
    status: compactArrayToMap(STATUS_KEYS, payload.s),
    theme: compactArrayToMap(THEME_KEYS, payload.th),
    manual: compactManualToObject(payload.m, payload.n),
  };
}

function applyLocaleBundle(locale, bundle) {
  if (!bundle || !locale) return;
  I18N[locale] = bundle.text;
  ZONE_TYPE_LABEL[locale] = bundle.zone;
  CATEGORY_LABEL[locale] = bundle.category;
  STATUS_LABEL[locale] = bundle.status;
  FRIDGE_THEME_LABELS[locale] = bundle.theme;
  MANUAL_CONTENT[locale] = bundle.manual;
  LOCALE_PACK_CACHE[locale] = true;
}

async function fetchLocalePack(locale) {
  if (typeof fetch !== "function") {
    throw new Error("Fetch API unavailable.");
  }

  const controller = typeof AbortController !== "undefined" ? new AbortController() : null;
  const timer = controller
    ? setTimeout(() => {
        controller.abort();
      }, LOCALE_FETCH_TIMEOUT_MS)
    : null;

  try {
    const response = await fetch(`${LOCALE_FILE_BASE}/${locale}.json`, {
      cache: "force-cache",
      signal: controller?.signal,
    });
    if (!response.ok) {
      throw new Error(`Locale pack request failed: ${response.status}`);
    }
    const payload = await response.json();
    const bundle = localeBundleFromCompact(payload);
    if (!bundle) {
      throw new Error("Locale pack has invalid shape.");
    }
    return bundle;
  } finally {
    if (timer) clearTimeout(timer);
  }
}

async function ensureLocalePackLoaded(locale) {
  const target = normalizeLocale(locale);
  if (LOCALE_PACK_CACHE[target]) return true;
  if (LOCALE_PACK_LOADING[target]) return LOCALE_PACK_LOADING[target];

  LOCALE_PACK_LOADING[target] = fetchLocalePack(target)
    .then((bundle) => {
      applyLocaleBundle(target, bundle);
      return true;
    })
    .catch((err) => {
      console.warn(`[locale] Failed to load locale pack "${target}":`, err);
      return false;
    })
    .finally(() => {
      delete LOCALE_PACK_LOADING[target];
    });

  return LOCALE_PACK_LOADING[target];
}

function t(key, fallback = "") {
  const locale = getCurrentLocale();
  return I18N[locale]?.[key] || I18N.en?.[key] || I18N.zh?.[key] || fallback || key;
}

function localizedMapValue(map, key, fallback = "") {
  const locale = getCurrentLocale();
  return map[locale]?.[key] || map.en?.[key] || map.zh?.[key] || fallback;
}

function zoneTypeLabel(type) {
  return localizedMapValue(ZONE_TYPE_LABEL, type, t("label_other"));
}

function categoryLabel(category) {
  return localizedMapValue(CATEGORY_LABEL, category, t("label_other"));
}

function statusLabel(status) {
  return localizedMapValue(STATUS_LABEL, status, status);
}

function themeLabel(theme) {
  if (!theme) return "";
  return localizedMapValue(FRIDGE_THEME_LABELS, theme.id, theme.label || theme.id);
}

async function onLocaleChange(event) {
  const nextLocale = normalizeLocale(event.target.value);
  if (nextLocale === ui.locale) return;

  ui.locale = nextLocale;
  persistPreferredLocale(nextLocale);
  els.localeSwitcher.disabled = true;

  const loaded = await ensureLocalePackLoaded(nextLocale);
  els.localeSwitcher.disabled = false;
  if (!loaded) {
    ui.locale = DEFAULT_LOCALE;
    persistPreferredLocale(DEFAULT_LOCALE);
  }

  applyLocaleToUI();
  render();
}

function applyLocaleToUI() {
  const locale = getCurrentLocale();
  document.documentElement.lang = locale === "zh" ? "zh-CN" : locale;
  document.title = t("app_title");

  els.localeSwitcher.value = locale;
  els.localeLabel.textContent = t("locale_label");

  els.appTitle.textContent = t("app_title");
  els.appSubtitle.textContent = t("app_subtitle");

  els.fleetTitle.textContent = t("fleet_title");
  els.openCreateFridgeLabel.textContent = t("btn_add");
  els.openEditFridgeLabel.textContent = t("btn_edit");
  els.auditTitle.textContent = t("audit_title");
  els.completeAuditBtn.textContent = t("audit_complete");
  els.riskTitle.textContent = t("risk_title");
  els.rescueTitle.textContent = t("rescue_title");
  els.ideasTitle.textContent = t("ideas_title");
  els.quickActionsTitle.textContent = t("quick_actions_title");
  els.openCreateZoneLabel.textContent = t("btn_create_zone");
  els.openEditZoneLabel.textContent = t("btn_edit_zone");
  els.openAddItemLabel.textContent = t("btn_add_item");
  els.openLibraryLabel.textContent = t("btn_library");
  els.openManualLabel.textContent = t("btn_manual");
  els.openExportTxtLabel.textContent = t("btn_export_txt");
  els.zoneItemsTitle.textContent = t("zone_items_title");
  els.ledgerTitle.textContent = t("ledger_title");

  els.modalCreateFridgeTitle.textContent = t("modal_create_fridge_title");
  els.modalEditFridgeTitle.textContent = t("modal_edit_fridge_title");
  els.modalCreateZoneTitle.textContent = t("modal_create_zone_title");
  els.modalEditZoneTitle.textContent = t("modal_edit_zone_title");
  els.modalLibraryTitle.textContent = t("modal_library_title");
  els.modalManualTitle.textContent = t("modal_manual_title");
  els.modalItemTitle.textContent = t("modal_item_title");
  els.manualIntro.textContent = t("manual_intro");

  const localeOptionMap = {
    zh: "locale_option_zh",
    en: "locale_option_en",
    ja: "locale_option_ja",
    de: "locale_option_de",
    fr: "locale_option_fr",
    es: "locale_option_es",
    it: "locale_option_it",
  };
  Array.from(els.localeSwitcher.options).forEach((option) => {
    option.textContent = t(localeOptionMap[option.value] || "locale_option_en");
  });

  localizeSelectOptions(els.createZoneType, ZONE_TYPE_LABEL);
  localizeSelectOptions(els.editZoneType, ZONE_TYPE_LABEL);
  localizeSelectOptions(els.itemCategory, CATEGORY_LABEL);
  localizeSelectOptions(els.libraryCategory, CATEGORY_LABEL);
  localizeSelectOptions(els.itemStatus, STATUS_LABEL);

  renderManualContent();
}

function localizeSelectOptions(selectEl, labelMap) {
  if (!(selectEl instanceof HTMLSelectElement)) return;
  Array.from(selectEl.options).forEach((option) => {
    const key = cleanText(option.value);
    option.textContent = localizedMapValue(labelMap, key, option.textContent);
  });
}

function renderManualContent() {
  if (!els.manualContent) return;
  const locale = getCurrentLocale();
  const content = MANUAL_CONTENT[locale] || MANUAL_CONTENT.en || MANUAL_CONTENT.zh;
  if (!content) {
    els.manualContent.innerHTML = "";
    return;
  }

  const html = content.sections
    .map((section) => {
      const tag = section.ordered ? "ol" : "ul";
      const items = section.items.map((item) => `<li>${escapeHtml(item)}</li>`).join("");
      return `
        <article class="manual-card">
          <h4>${escapeHtml(section.title)}</h4>
          <${tag} class="manual-list">${items}</${tag}>
        </article>
      `;
    })
    .join("");

  const note = content.note ? `<p class="manual-note">${escapeHtml(content.note)}</p>` : "";
  els.manualContent.innerHTML = `${html}${note}`;
}

function runStartupSafetyFlow() {
  if (ui.startupNotice) {
    showToast(ui.startupNotice);
  }

  if (!ui.needsUpgradeReload) {
    return;
  }

  try {
    const hasReloaded = sessionStorage.getItem(UPGRADE_RELOAD_GUARD_KEY) === "1";
    if (!hasReloaded) {
      sessionStorage.setItem(UPGRADE_RELOAD_GUARD_KEY, "1");
      window.location.reload();
    }
  } catch (_err) {
    // Ignore session storage issues in restricted contexts.
  }
}

function openModal(modalId, options = {}) {
  const cards = {
    createFridge: els.modalCreateFridge,
    editFridge: els.modalEditFridge,
    createZone: els.modalCreateZone,
    editZone: els.modalEditZone,
    library: els.modalLibrary,
    manual: els.modalManual,
    item: els.modalItem,
  };

  const targetCard = cards[modalId];
  if (!targetCard) return;

  const fridge = getActiveFridge();
  const zone = getSelectedZone(fridge);
  if ((modalId === "editFridge" || modalId === "createZone" || modalId === "item") && !fridge) {
    showToast("请先创建或选择一个冰箱。");
    return;
  }
  if (modalId === "editZone" && !zone) {
    showToast("请先选择一个分区。");
    return;
  }
  if (modalId === "item" && (!fridge || !fridge.zones.length)) {
    showToast("请先创建至少一个分区。");
    return;
  }

  syncModalContext(modalId, options);
  ui.lastFocusedElement = document.activeElement instanceof HTMLElement ? document.activeElement : null;

  Object.values(cards).forEach((card) => {
    card.classList.add("hidden");
  });

  targetCard.classList.remove("hidden");
  els.modalRoot.classList.remove("hidden");
  els.modalRoot.setAttribute("aria-hidden", "false");
  document.body.classList.add("modal-open");
  ui.activeModalId = modalId;

  const firstField = targetCard.querySelector("input, select, textarea, button");
  if (firstField instanceof HTMLElement) {
    firstField.focus();
  }
}

function syncModalContext(modalId, options = {}) {
  if (modalId === "editFridge") {
    renderActiveFridgeSettings();
    return;
  }
  if (modalId === "editZone") {
    renderZoneEditor();
    return;
  }
  if (modalId === "item") {
    if (!options.preserveFormState) {
      resetItemForm(true);
    }
    renderItemZoneOptions();
    renderLibrarySuggestions(els.itemLibraryQuery.value);
    return;
  }
  if (modalId === "library") {
    resetLibraryForm();
    renderLibraryList();
    return;
  }
  if (modalId === "manual") {
    renderManualContent();
  }
}

function closeModal() {
  if (!ui.activeModalId) return;

  els.modalRoot.classList.add("hidden");
  els.modalRoot.setAttribute("aria-hidden", "true");
  els.modalCreateFridge.classList.add("hidden");
  els.modalEditFridge.classList.add("hidden");
  els.modalCreateZone.classList.add("hidden");
  els.modalEditZone.classList.add("hidden");
  els.modalLibrary.classList.add("hidden");
  els.modalManual.classList.add("hidden");
  els.modalItem.classList.add("hidden");
  document.body.classList.remove("modal-open");
  ui.activeModalId = null;

  if (ui.recordingButton) {
    try {
      ui.speech?.stop();
    } catch (_error) {
      // Ignore stop errors from browser speech engine.
    }
    stopVoiceUI();
  }

  if (ui.libraryQueryTimer) {
    clearTimeout(ui.libraryQueryTimer);
    ui.libraryQueryTimer = null;
  }

  if (ui.lastFocusedElement instanceof HTMLElement) {
    ui.lastFocusedElement.focus();
    ui.lastFocusedElement = null;
  }
}

function loadState() {
  const storageKeys = [STORAGE_KEY, ...LEGACY_STORAGE_KEYS];
  const uniqueKeys = Array.from(new Set(storageKeys));

  for (const key of uniqueKeys) {
    const entry = readStoredEntry(key);
    if (!entry) continue;

    const normalized = normalizeStatePayload(entry.payload);
    if (!normalized) continue;

    const schemaChanged = entry.schemaVersion !== STORAGE_SCHEMA_VERSION;
    const appChanged = cleanText(entry.appVersion) !== APP_RELEASE_VERSION;
    const movedFromLegacyKey = key !== STORAGE_KEY;

    if (schemaChanged || appChanged || movedFromLegacyKey || !entry.isEnvelope) {
      const backupKey = writeBackupSnapshot(entry.payload, {
        reason: "upgrade-transfer",
        fromSchemaVersion: entry.schemaVersion,
        fromAppVersion: entry.appVersion,
        sourceKey: key,
      });

      saveStateWithMeta(normalized, {
        reason: "upgrade-transfer",
        sourceKey: key,
        fromSchemaVersion: entry.schemaVersion,
        fromAppVersion: entry.appVersion,
        backupKey,
      });

      ui.startupNotice = "已完成版本升级迁移，并创建数据备份。";
      ui.needsUpgradeReload = true;
    } else {
      writeStorageMeta({
        currentSchemaVersion: STORAGE_SCHEMA_VERSION,
        currentAppVersion: APP_RELEASE_VERSION,
        lastSavedAt: entry.savedAt || new Date().toISOString(),
        lastLoadSource: key,
      });
      clearUpgradeReloadGuard();
    }

    return applyStoredViewState(normalized);
  }

  const recovered = tryRestoreFromBackup();
  if (recovered) {
    return applyStoredViewState(recovered);
  }

  const seeded = seedState();
  saveStateWithMeta(seeded, { reason: "seed" });
  clearUpgradeReloadGuard();
  return applyStoredViewState(seeded);
}

function applyStoredViewState(payload) {
  if (!payload || typeof payload !== "object") return payload;
  const view = readViewState();
  if (!view) return payload;

  return {
    ...payload,
    activeFridgeId: view.activeFridgeId || payload.activeFridgeId || null,
    selectedZoneId: view.selectedZoneId || payload.selectedZoneId || null,
  };
}

function readViewState() {
  let raw = null;
  try {
    raw = localStorage.getItem(STORAGE_VIEW_KEY);
  } catch (_err) {
    return null;
  }
  if (!raw) return null;

  try {
    const parsed = JSON.parse(raw);
    if (!parsed || typeof parsed !== "object") return null;
    return {
      activeFridgeId: cleanText(parsed.activeFridgeId),
      selectedZoneId: cleanText(parsed.selectedZoneId),
    };
  } catch (_err) {
    return null;
  }
}

function persistViewState(source) {
  if (!source || typeof source !== "object") return false;
  const payload = {
    activeFridgeId: cleanText(source.activeFridgeId),
    selectedZoneId: cleanText(source.selectedZoneId),
    savedAt: new Date().toISOString(),
  };
  return tryLocalStorageSetItem(STORAGE_VIEW_KEY, JSON.stringify(payload));
}

function normalizeStatePayload(payload) {
  if (!payload || typeof payload !== "object") return null;

  const fridges = Array.isArray(payload.fridges) ? payload.fridges.slice(0, MAX_FRIDGES) : [];
  let totalItems = 0;

  const normalized = {
    fridges: fridges
      .map((fridge) => normalizeFridge(fridge, (count) => {
        totalItems += count;
        return totalItems <= MAX_TOTAL_ITEMS;
      }))
      .filter(Boolean),
    activeFridgeId: payload.activeFridgeId || null,
    selectedZoneId: payload.selectedZoneId || null,
    logs: Array.isArray(payload.logs) ? payload.logs.slice(0, 600).map(normalizeLog).filter(Boolean) : [],
    ingredientLibrary: normalizeIngredientLibrary(payload.ingredientLibrary),
  };

  if (!normalized.fridges.length) return null;
  return normalized;
}

function readStoredEntry(key) {
  let raw = null;
  try {
    raw = localStorage.getItem(key);
  } catch (_err) {
    return null;
  }
  if (!raw) return null;

  let parsed = null;
  try {
    parsed = JSON.parse(raw);
  } catch (_err) {
    return null;
  }

  const isEnvelope =
    parsed &&
    typeof parsed === "object" &&
    !Array.isArray(parsed) &&
    parsed.payload &&
    typeof parsed.payload === "object";

  if (isEnvelope) {
    return {
      key,
      payload: parsed.payload,
      schemaVersion: clamp(Math.round(toNumber(parsed.__schemaVersion, 1)), 1, 999),
      appVersion: cleanText(parsed.__appVersion),
      savedAt: cleanText(parsed.savedAt) || null,
      isEnvelope: true,
    };
  }

  return {
    key,
    payload: parsed,
    schemaVersion: inferLegacySchemaVersion(key),
    appVersion: "",
    savedAt: null,
    isEnvelope: false,
  };
}

function inferLegacySchemaVersion(key) {
  if (key === "homeassistant-nova-v2") return 2;
  return 1;
}

function tryRestoreFromBackup() {
  const backups = readBackupIndex();
  for (const entry of backups) {
    if (!entry || !entry.key) continue;

    let raw = null;
    try {
      raw = localStorage.getItem(entry.key);
    } catch (_err) {
      continue;
    }
    if (!raw) continue;

    let parsed = null;
    try {
      parsed = JSON.parse(raw);
    } catch (_err) {
      continue;
    }

    const payload = parsed && typeof parsed === "object" ? parsed.payload : null;
    const normalized = normalizeStatePayload(payload);
    if (!normalized) continue;

    saveStateWithMeta(normalized, {
      reason: "backup-restore",
      sourceKey: entry.key,
      fromSchemaVersion: toNumber(parsed.fromSchemaVersion, 0),
      fromAppVersion: cleanText(parsed.fromAppVersion),
      backupKey: entry.key,
    });

    ui.startupNotice = "已从升级备份恢复数据并重新加载。";
    ui.needsUpgradeReload = true;
    return normalized;
  }

  return null;
}

function writeBackupSnapshot(payload, context = {}) {
  if (!payload || typeof payload !== "object") return "";

  const key = `${STORAGE_BACKUP_PREFIX}${Date.now()}-${Math.random().toString(16).slice(2, 8)}`;
  const createdAt = new Date().toISOString();
  const backup = {
    createdAt,
    reason: cleanText(context.reason) || "upgrade-transfer",
    sourceKey: cleanText(context.sourceKey) || STORAGE_KEY,
    fromSchemaVersion: toNumber(context.fromSchemaVersion, 0),
    fromAppVersion: cleanText(context.fromAppVersion),
    payload,
  };

  const serialized = JSON.stringify(backup);
  if (!tryLocalStorageSetItem(key, serialized)) {
    pruneBackupStorage(Math.max(1, Math.floor(MAX_STORAGE_BACKUPS / 2)));
    if (!tryLocalStorageSetItem(key, serialized)) {
      return "";
    }
  }

  const index = readBackupIndex();
  const next = [{ key, createdAt, reason: backup.reason }, ...index.filter((item) => item && item.key !== key)];
  const trimmed = next.slice(0, MAX_STORAGE_BACKUPS);
  writeBackupIndex(trimmed);
  pruneBackupStorage(MAX_STORAGE_BACKUPS);
  return key;
}

function readBackupIndex() {
  let raw = null;
  try {
    raw = localStorage.getItem(STORAGE_BACKUP_INDEX_KEY);
  } catch (_err) {
    return [];
  }
  if (!raw) return [];

  try {
    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) return [];
    return parsed.filter((entry) => entry && typeof entry === "object" && typeof entry.key === "string");
  } catch (_err) {
    return [];
  }
}

function writeBackupIndex(index) {
  const safeIndex = Array.isArray(index) ? index.slice(0, MAX_STORAGE_BACKUPS) : [];
  tryLocalStorageSetItem(STORAGE_BACKUP_INDEX_KEY, JSON.stringify(safeIndex));
}

function pruneBackupStorage(keepCount) {
  const safeKeep = clamp(Math.round(toNumber(keepCount, MAX_STORAGE_BACKUPS)), 0, 100);
  const index = readBackupIndex();
  const keep = index.slice(0, safeKeep);
  const remove = index.slice(safeKeep);

  for (const entry of remove) {
    if (!entry || !entry.key) continue;
    try {
      localStorage.removeItem(entry.key);
    } catch (_err) {
      // Ignore remove failures.
    }
  }

  writeBackupIndex(keep);
}

function readStorageMeta() {
  let raw = null;
  try {
    raw = localStorage.getItem(STORAGE_META_KEY);
  } catch (_err) {
    return {};
  }
  if (!raw) return {};

  try {
    const parsed = JSON.parse(raw);
    return parsed && typeof parsed === "object" ? parsed : {};
  } catch (_err) {
    return {};
  }
}

function writeStorageMeta(patch = {}) {
  const current = readStorageMeta();
  const next = {
    ...current,
    ...patch,
    updatedAt: new Date().toISOString(),
  };
  tryLocalStorageSetItem(STORAGE_META_KEY, JSON.stringify(next));
}

function tryLocalStorageSetItem(key, value) {
  try {
    localStorage.setItem(key, value);
    return true;
  } catch (_err) {
    return false;
  }
}

function clearUpgradeReloadGuard() {
  try {
    sessionStorage.removeItem(UPGRADE_RELOAD_GUARD_KEY);
  } catch (_err) {
    // Ignore session storage issues in restricted contexts.
  }
}

function seedState() {
  const kitchen = createFridge("主厨房冰箱", "厨房", { withStarterItems: true });
  const office = createFridge("办公室小冰箱", "书房", { withStarterItems: true });

  kitchen.lastAuditDate = dayOffsetISO(-1);
  kitchen.auditStreak = 2;
  office.lastAuditDate = dayOffsetISO(-2);
  office.auditStreak = 1;

  const kitchenLeftover = kitchen.zones.find((zone) => zone.type === "leftover");
  if (kitchenLeftover?.items[0]) {
    kitchenLeftover.items[0].expiryDate = dayOffsetISO(0);
  }

  const kitchenDrink = kitchen.zones.find((zone) => zone.type === "drinking");
  if (kitchenDrink?.items[0]) {
    kitchenDrink.items[0].expiryDate = dayOffsetISO(-1);
  }

  return {
    fridges: [kitchen, office],
    activeFridgeId: kitchen.id,
    selectedZoneId: kitchen.zones[0]?.id || null,
    logs: [],
    ingredientLibrary: buildDefaultIngredientLibrary(),
  };
}

function normalizeFridgeTheme(value) {
  const token = cleanText(value);
  const exists = FRIDGE_THEME_OPTIONS.some((theme) => theme.id === token);
  return exists ? token : DEFAULT_FRIDGE_THEME;
}

function createFridge(name, location, options = {}) {
  const withStarterItems = options.withStarterItems !== false;
  const theme = normalizeFridgeTheme(options.theme);
  const now = new Date().toISOString();
  return {
    id: makeId(),
    name: cleanText(name) || "未命名冰箱",
    location: cleanText(location),
    theme,
    createdAt: now,
    updatedAt: now,
    lastAuditDate: null,
    auditStreak: 0,
    zones: createDefaultZones(withStarterItems),
  };
}

function createDefaultZones(withStarterItems = true) {
  return DEFAULT_ZONE_TEMPLATES.map((template) => {
    const zone = createZone(template.name, template.type, template.capacity);
    if (withStarterItems) {
      zone.items = buildStarterItemsForZone(template.type);
    }
    return zone;
  });
}

function buildStarterItemsForZone(zoneType) {
  const templates = DEFAULT_ITEMS_BY_ZONE_TYPE[zoneType] || [];
  return templates.map((template, index) =>
    createItem({
      name: template.name,
      amount: template.amount,
      unit: template.unit,
      addedDate: dayOffsetISO(-(index + 1)),
      expiryDate: dayOffsetISO(template.daysValid),
      status: "Auto",
      category: template.category,
      note: template.note,
    })
  );
}

function createZone(name, type, capacity) {
  const now = new Date().toISOString();
  return {
    id: makeId(),
    name: cleanText(name) || "新分区",
    type: ZONE_TYPE_LABEL.zh[type] ? type : "other",
    capacity: clamp(Math.round(toNumber(capacity, 18)), 1, 120),
    createdAt: now,
    updatedAt: now,
    items: [],
  };
}

function createItem(input) {
  const now = new Date().toISOString();
  const amount = toNumber(input.amount, 0);
  return {
    id: makeId(),
    name: cleanText(input.name) || "未命名食材",
    amount,
    unit: cleanText(input.unit) || "份",
    addedDate: normalizeDate(input.addedDate) || todayISO(),
    expiryDate: normalizeDate(input.expiryDate) || todayISO(),
    status: cleanText(input.status) || "Auto",
    category: CATEGORY_LABEL.zh[input.category] ? input.category : "other",
    note: cleanText(input.note),
    createdAt: now,
    updatedAt: now,
  };
}

function normalizeFridge(fridge, itemGuard = null) {
  if (!fridge || typeof fridge !== "object") return null;
  const rawZones = Array.isArray(fridge.zones) ? fridge.zones.slice(0, MAX_ZONES_PER_FRIDGE) : [];
  const zones = rawZones.map((zone) => normalizeZone(zone, itemGuard)).filter(Boolean);
  return {
    id: fridge.id || makeId(),
    name: cleanText(fridge.name) || "未命名冰箱",
    location: cleanText(fridge.location),
    theme: normalizeFridgeTheme(fridge.theme),
    createdAt: fridge.createdAt || new Date().toISOString(),
    updatedAt: fridge.updatedAt || new Date().toISOString(),
    lastAuditDate: normalizeDate(fridge.lastAuditDate),
    auditStreak: clamp(Math.round(toNumber(fridge.auditStreak, 0)), 0, 9999),
    zones,
  };
}

function normalizeZone(zone, itemGuard = null) {
  if (!zone || typeof zone !== "object") return null;
  const rawItems = Array.isArray(zone.items) ? zone.items.slice(0, MAX_ITEMS_PER_ZONE) : [];
  const items = [];
  for (const rawItem of rawItems) {
    if (typeof itemGuard === "function" && !itemGuard(1)) break;
    const item = normalizeItem(rawItem);
    if (item) items.push(item);
  }
  return {
    id: zone.id || makeId(),
    name: cleanText(zone.name) || "分区",
    type: ZONE_TYPE_LABEL.zh[zone.type] ? zone.type : "other",
    capacity: clamp(Math.round(toNumber(zone.capacity, 18)), 1, 120),
    createdAt: zone.createdAt || new Date().toISOString(),
    updatedAt: zone.updatedAt || new Date().toISOString(),
    items,
  };
}

function normalizeItem(item) {
  if (!item || typeof item !== "object") return null;
  const amount = toNumber(item.amount, 0);
  return {
    id: item.id || makeId(),
    name: cleanText(item.name) || "食材",
    amount,
    unit: cleanText(item.unit) || "份",
    addedDate: normalizeDate(item.addedDate) || todayISO(),
    expiryDate: normalizeDate(item.expiryDate) || todayISO(),
    status: cleanText(item.status) || "Auto",
    category: CATEGORY_LABEL.zh[item.category] ? item.category : "other",
    note: cleanText(item.note),
    createdAt: item.createdAt || new Date().toISOString(),
    updatedAt: item.updatedAt || new Date().toISOString(),
  };
}

function normalizeLog(log) {
  if (!log || typeof log !== "object") return null;
  const action = cleanText(log.action);
  if (!action) return null;
  return {
    id: log.id || makeId(),
    fridgeId: cleanText(log.fridgeId),
    fridgeName: cleanText(log.fridgeName),
    zoneName: cleanText(log.zoneName),
    itemName: cleanText(log.itemName),
    action,
    daysLeftAtAction: toNumber(log.daysLeftAtAction, 0),
    at: log.at || new Date().toISOString(),
  };
}

function buildDefaultIngredientLibrary() {
  return DEFAULT_INGREDIENT_LIBRARY_TEMPLATES.map((template) => ({
    id: makeId(),
    name: cleanText(template.name),
    aliases: normalizeAliases(template.aliases),
    unit: cleanText(template.unit) || "份",
    category: CATEGORY_LABEL.zh[template.category] ? template.category : "other",
    defaultDaysValid: clamp(Math.round(toNumber(template.defaultDaysValid, 5)), 1, 60),
    note: cleanText(template.note),
    locked: Boolean(template.locked),
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
  }));
}

function normalizeIngredientLibrary(library) {
  const defaults = buildDefaultIngredientLibrary();
  const incoming = Array.isArray(library) ? library.map(normalizeIngredient).filter(Boolean) : [];

  if (!incoming.length) return defaults;

  const map = new Map();
  for (const entry of defaults) {
    map.set(searchToken(entry.name), entry);
  }
  for (const entry of incoming) {
    const key = searchToken(entry.name);
    if (!key) continue;
    map.set(key, {
      ...entry,
      locked: map.get(key)?.locked ? true : Boolean(entry.locked),
    });
  }
  return trimIngredientCollection(Array.from(map.values()));
}

function normalizeIngredient(item) {
  if (!item || typeof item !== "object") return null;
  const name = cleanText(item.name);
  if (!name) return null;
  return {
    id: item.id || makeId(),
    name,
    aliases: normalizeAliases(item.aliases),
    unit: cleanText(item.unit) || "份",
    category: CATEGORY_LABEL.zh[item.category] ? item.category : "other",
    defaultDaysValid: clamp(Math.round(toNumber(item.defaultDaysValid, 5)), 1, 60),
    note: cleanText(item.note),
    locked: Boolean(item.locked),
    createdAt: item.createdAt || new Date().toISOString(),
    updatedAt: item.updatedAt || new Date().toISOString(),
  };
}

function normalizeAliases(value) {
  const source = Array.isArray(value) ? value : typeof value === "string" ? value.split(/[,，;；、/|]/g) : [];
  const aliases = [];
  const seen = new Set();

  for (const raw of source) {
    const alias = cleanText(raw);
    const token = searchToken(alias);
    if (!alias || !token || seen.has(token)) continue;
    seen.add(token);
    aliases.push(alias);
  }

  return aliases.slice(0, 12);
}

function searchToken(value) {
  return cleanText(value)
    .toLowerCase()
    .replace(/[^a-z0-9\u4e00-\u9fff]/g, "");
}

function sortIngredientLibrary(a, b) {
  if (a.locked !== b.locked) return a.locked ? -1 : 1;
  if (!a.locked && !b.locked) {
    const timeA = new Date(a.updatedAt || a.createdAt || 0).getTime();
    const timeB = new Date(b.updatedAt || b.createdAt || 0).getTime();
    if (timeA !== timeB) return timeB - timeA;
  }
  return a.name.localeCompare(b.name, getCurrentLocale());
}

function trimIngredientCollection(collection) {
  const map = new Map();

  for (const raw of collection) {
    const item = normalizeIngredient(raw);
    if (!item) continue;

    const key = searchToken(item.name);
    if (!key) continue;

    const existing = map.get(key);
    if (!existing) {
      map.set(key, item);
      continue;
    }

    if (existing.locked && !item.locked) continue;
    if (!existing.locked && item.locked) {
      map.set(key, item);
      continue;
    }

    const existingTime = new Date(existing.updatedAt || existing.createdAt || 0).getTime();
    const currentTime = new Date(item.updatedAt || item.createdAt || 0).getTime();
    if (currentTime >= existingTime) {
      map.set(key, {
        ...item,
        locked: existing.locked || item.locked,
      });
    }
  }

  const sorted = Array.from(map.values()).sort(sortIngredientLibrary);
  const locked = sorted.filter((item) => item.locked);
  const custom = sorted.filter((item) => !item.locked);

  if (locked.length >= MAX_INGREDIENT_LIBRARY) {
    return locked.slice(0, MAX_INGREDIENT_LIBRARY);
  }

  const maxCustom = Math.max(0, MAX_INGREDIENT_LIBRARY - locked.length);
  return [...locked, ...custom.slice(0, maxCustom)];
}

function trimIngredientLibrary() {
  state.ingredientLibrary = trimIngredientCollection(state.ingredientLibrary);
}

function saveState() {
  if (!ui.stateDirty) return true;
  const ok = saveStateWithMeta(state, { reason: "save" });
  if (ok) {
    ui.stateDirty = false;
  }
  return ok;
}

function saveStateWithMeta(payload, context = {}) {
  const savedAt = new Date().toISOString();
  const envelope = {
    __schemaVersion: STORAGE_SCHEMA_VERSION,
    __appVersion: APP_RELEASE_VERSION,
    savedAt,
    payload,
  };

  const ok = tryLocalStorageSetItem(STORAGE_KEY, JSON.stringify(envelope));
  if (!ok) {
    showToast("本地存储空间不足，保存失败。请清理部分历史数据。");
    return false;
  }

  writeStorageMeta({
    currentSchemaVersion: STORAGE_SCHEMA_VERSION,
    currentAppVersion: APP_RELEASE_VERSION,
    lastSavedAt: savedAt,
    lastReason: cleanText(context.reason) || "save",
    lastLoadSource: cleanText(context.sourceKey) || STORAGE_KEY,
    lastMigrationFromSchema: toNumber(context.fromSchemaVersion, 0),
    lastMigrationFromApp: cleanText(context.fromAppVersion),
    lastBackupKey: cleanText(context.backupKey),
  });
  persistViewState(payload);
  return true;
}

function persistAndRender(options = {}) {
  const immediate = Boolean(options.immediate);
  ui.stateDirty = true;
  if (immediate) {
    flushDeferredSaveState();
  } else {
    scheduleDeferredSaveState();
  }
  render();
}

function ensureSelectionIntegrity() {
  if (!state.fridges.length) {
    const fallback = createFridge("主厨房冰箱", "厨房", { withStarterItems: false });
    state.fridges.push(fallback);
  }

  let active = getActiveFridge();
  if (!active) {
    state.activeFridgeId = state.fridges[0].id;
    active = getActiveFridge();
  }

  if (!active) {
    state.selectedZoneId = null;
    return;
  }

  if (!active.zones.length) {
    active.zones = createDefaultZones(false).slice(0, 1);
  }

  const selectedExists = active.zones.some((zone) => zone.id === state.selectedZoneId);
  if (!selectedExists) {
    state.selectedZoneId = active.zones[0]?.id || null;
  }
}

function getActiveFridge() {
  return state.fridges.find((fridge) => fridge.id === state.activeFridgeId) || null;
}

function getSelectedZone(fridge) {
  if (!fridge) return null;
  return fridge.zones.find((zone) => zone.id === state.selectedZoneId) || null;
}

function onCreateFridge(event) {
  event.preventDefault();
  if (state.fridges.length >= MAX_FRIDGES) {
    showToast(`冰箱数量已达上限（${MAX_FRIDGES}）。`);
    return;
  }
  const name = cleanText(els.createFridgeName.value);
  if (!name) {
    showToast("冰箱名称不能为空。");
    return;
  }
  const location = cleanText(els.createFridgeLocation.value);
  const fridge = createFridge(name, location, { withStarterItems: false });
  state.fridges.unshift(fridge);
  state.activeFridgeId = fridge.id;
  state.selectedZoneId = fridge.zones[0]?.id || null;
  els.createFridgeForm.reset();
  resetItemForm();
  persistAndRender();
  closeModal();
  showToast("已创建新冰箱。");
}

function onSelectFridge(event) {
  const button = event.target.closest("[data-fridge-id]");
  if (!button) return;
  const fridgeId = button.getAttribute("data-fridge-id");
  if (!fridgeId || fridgeId === state.activeFridgeId) return;
  state.activeFridgeId = fridgeId;
  ensureSelectionIntegrity();
  resetItemForm();
  persistViewState(state);
  render();
}

function onSaveActiveFridge(event) {
  event.preventDefault();
  const fridge = getActiveFridge();
  if (!fridge) return;

  const name = cleanText(els.activeFridgeName.value);
  if (!name) {
    showToast("当前冰箱名称不能为空。");
    return;
  }

  fridge.name = name;
  fridge.location = cleanText(els.activeFridgeLocation.value);
  fridge.theme = normalizeFridgeTheme(els.activeFridgeTheme.value);
  fridge.updatedAt = new Date().toISOString();
  persistAndRender();
  closeModal();
  showToast("冰箱设置已保存。");
}

function onSelectFridgeTheme(event) {
  const button = event.target.closest("[data-theme-id]");
  if (!button) return;
  const themeId = normalizeFridgeTheme(button.getAttribute("data-theme-id"));
  els.activeFridgeTheme.value = themeId;
  renderFridgeThemePicker(themeId);
}

function onDeleteFridge() {
  const fridge = getActiveFridge();
  if (!fridge) return;

  if (countItemsInFridge(fridge) > 0) {
    showToast("删除失败：请先清空该冰箱所有食材。");
    return;
  }

  const ok = window.confirm(`确认删除冰箱「${fridge.name}」？`);
  if (!ok) return;

  state.fridges = state.fridges.filter((entry) => entry.id !== fridge.id);
  if (!state.fridges.length) {
    state.fridges.push(createFridge("主厨房冰箱", "厨房", { withStarterItems: false }));
  }
  state.activeFridgeId = state.fridges[0].id;
  state.selectedZoneId = state.fridges[0].zones[0]?.id || null;
  resetItemForm();
  persistAndRender();
  closeModal();
  showToast("冰箱已删除。");
}

function onCompleteAudit() {
  const fridge = getActiveFridge();
  if (!fridge) return;

  const today = todayISO();
  if (fridge.lastAuditDate === today) {
    showToast("今天已完成检查。");
    return;
  }

  const last = normalizeDate(fridge.lastAuditDate);
  if (!last) {
    fridge.auditStreak = 1;
  } else {
    const gap = daysBetween(last, today);
    fridge.auditStreak = gap === 1 ? fridge.auditStreak + 1 : 1;
  }

  fridge.lastAuditDate = today;
  fridge.updatedAt = new Date().toISOString();
  persistAndRender();
  showToast("已记录今日检查。");
}

function onToggleDoor() {
  ui.doorOpen = !ui.doorOpen;
  renderDoorState();
}

function onCreateZone(event) {
  event.preventDefault();
  const fridge = getActiveFridge();
  if (!fridge) return;
  if (fridge.zones.length >= MAX_ZONES_PER_FRIDGE) {
    showToast(`分区数量已达上限（${MAX_ZONES_PER_FRIDGE}）。`);
    return;
  }

  const name = cleanText(els.createZoneName.value);
  if (!name) {
    showToast("分区名称不能为空。");
    return;
  }

  const type = ZONE_TYPE_LABEL.zh[els.createZoneType.value] ? els.createZoneType.value : "other";
  const capacity = clamp(Math.round(toNumber(els.createZoneCapacity.value, 18)), 1, 120);
  const zone = createZone(name, type, capacity);
  fridge.zones.push(zone);
  fridge.updatedAt = new Date().toISOString();
  state.selectedZoneId = zone.id;

  els.createZoneForm.reset();
  els.createZoneCapacity.value = "18";
  resetItemForm();
  persistAndRender();
  closeModal();
  showToast("新分区已创建。");
}

function onSaveZone(event) {
  event.preventDefault();
  const fridge = getActiveFridge();
  const zone = getSelectedZone(fridge);
  if (!fridge || !zone) return;

  const name = cleanText(els.editZoneName.value);
  if (!name) {
    showToast("分区名称不能为空。");
    return;
  }

  zone.name = name;
  zone.type = ZONE_TYPE_LABEL.zh[els.editZoneType.value] ? els.editZoneType.value : "other";
  zone.capacity = clamp(Math.round(toNumber(els.editZoneCapacity.value, zone.capacity)), 1, 120);
  zone.updatedAt = new Date().toISOString();
  fridge.updatedAt = new Date().toISOString();
  persistAndRender();
  closeModal();
  showToast("分区已更新。");
}

function onDeleteZone() {
  const fridge = getActiveFridge();
  const zone = getSelectedZone(fridge);
  if (!fridge || !zone) return;

  if (zone.items.length > 0) {
    showToast("删除失败：请先清空该分区食材。");
    return;
  }

  if (fridge.zones.length <= 1) {
    showToast("至少保留一个分区。");
    return;
  }

  const ok = window.confirm(`确认删除分区「${zone.name}」？`);
  if (!ok) return;

  fridge.zones = fridge.zones.filter((entry) => entry.id !== zone.id);
  fridge.updatedAt = new Date().toISOString();
  state.selectedZoneId = fridge.zones[0]?.id || null;
  resetItemForm();
  persistAndRender();
  closeModal();
  showToast("分区已删除。");
}

function onSelectZone(event) {
  const button = event.target.closest("[data-zone-id]");
  if (!button) return;
  const zoneId = button.getAttribute("data-zone-id");
  if (!zoneId || zoneId === state.selectedZoneId) return;

  state.selectedZoneId = zoneId;
  persistViewState(state);
  render();
}

function onSaveItem(event) {
  event.preventDefault();
  const fridge = getActiveFridge();
  if (!fridge) return;

  if (!fridge.zones.length) {
    showToast("请先创建至少一个分区。");
    return;
  }

  const name = cleanText(els.itemName.value);
  const amount = toNumber(els.itemAmount.value, NaN);
  const unit = cleanText(els.itemUnit.value);
  const addedDate = normalizeDate(els.itemAddedDate.value);
  const expiryDate = normalizeDate(els.itemExpiryDate.value);
  const status = cleanText(els.itemStatus.value) || "Auto";
  const category = CATEGORY_LABEL.zh[els.itemCategory.value] ? els.itemCategory.value : "other";
  const note = cleanText(els.itemNote.value);
  const targetZoneId = cleanText(els.itemZoneId.value);

  if (!name || Number.isNaN(amount) || amount < 0 || !unit || !addedDate || !expiryDate || !targetZoneId) {
    showToast("请完整填写食材信息。");
    return;
  }

  const targetZone = fridge.zones.find((zone) => zone.id === targetZoneId);
  if (!targetZone) {
    showToast("目标分区不存在。");
    return;
  }

  const now = new Date().toISOString();
  const payload = {
    name,
    amount,
    unit,
    addedDate,
    expiryDate,
    status,
    category,
    note,
  };

  const itemId = cleanText(els.itemId.value);
  const sourceZoneId = cleanText(els.itemSourceZoneId.value);

  if (itemId && sourceZoneId) {
    const sourceZone = fridge.zones.find((zone) => zone.id === sourceZoneId);
    if (!sourceZone) {
      showToast("原始分区不存在，请重新编辑。");
      return;
    }

    const oldIndex = sourceZone.items.findIndex((item) => item.id === itemId);
    if (oldIndex < 0) {
      showToast("该食材已不存在。");
      return;
    }

    const isCrossZoneMove = sourceZone.id !== targetZone.id;
    if (isCrossZoneMove && targetZone.items.length >= MAX_ITEMS_PER_ZONE) {
      showToast(`目标分区已达容量上限（${MAX_ITEMS_PER_ZONE}）。`);
      return;
    }

    const old = sourceZone.items[oldIndex];
    sourceZone.items.splice(oldIndex, 1);
    const updated = {
      ...old,
      ...payload,
      updatedAt: now,
    };

    targetZone.items.push(updated);
    sourceZone.updatedAt = now;
    targetZone.updatedAt = now;
    fridge.updatedAt = now;
    state.selectedZoneId = targetZone.id;

    resetItemForm();
    persistAndRender();
    closeModal();
    showToast("食材已更新。");
    return;
  }

  if (targetZone.items.length >= MAX_ITEMS_PER_ZONE) {
    showToast(`该分区已达容量上限（${MAX_ITEMS_PER_ZONE}）。`);
    return;
  }

  if (countTotalItems(state.fridges) >= MAX_TOTAL_ITEMS) {
    showToast(`库存总量已达系统上限（${MAX_TOTAL_ITEMS}），请先清理后再添加。`);
    return;
  }

  const item = createItem(payload);
  targetZone.items.push(item);
  targetZone.updatedAt = now;
  fridge.updatedAt = now;
  state.selectedZoneId = targetZone.id;

  resetItemForm();
  persistAndRender();
  closeModal();
  showToast("食材已添加。");
}

function onLibraryQueryInput() {
  if (ui.libraryQueryTimer) {
    clearTimeout(ui.libraryQueryTimer);
  }
  ui.libraryQueryTimer = setTimeout(() => {
    ui.libraryQueryTimer = null;
    renderLibrarySuggestions(els.itemLibraryQuery.value);
  }, 90);
}

function onApplyLibraryFromQuery() {
  const query = cleanText(els.itemLibraryQuery.value);
  const target = findBestLibraryMatch(query);
  if (!target) {
    showToast("未找到匹配食材，请尝试更短关键词。");
    return;
  }
  applyLibraryTemplate(target);
}

function onExportInventoryTxt() {
  const content = buildPrintableInventoryText();
  if (!content) {
    showToast(t("export_no_data"));
    return;
  }

  const now = new Date();
  const stamp = [
    now.getFullYear(),
    String(now.getMonth() + 1).padStart(2, "0"),
    String(now.getDate()).padStart(2, "0"),
    "-",
    String(now.getHours()).padStart(2, "0"),
    String(now.getMinutes()).padStart(2, "0"),
  ].join("");
  const fileName = `ravis-inventory-${stamp}.txt`;

  downloadTextFile(fileName, content);
  showToast(t("export_done"));
}

function buildPrintableInventoryText() {
  if (!Array.isArray(state.fridges) || !state.fridges.length) return "";

  const locale = getCurrentLocale();
  const nowText = new Date().toLocaleString(locale);
  const lines = [];
  const divider = "=".repeat(84);
  const subDivider = "-".repeat(68);

  lines.push(`${t("app_title")} | ${t("export_title")}`);
  lines.push(`${t("export_generated_at")}: ${nowText}`);
  lines.push(`Locale: ${locale}`);
  lines.push(divider);

  state.fridges.forEach((fridge, index) => {
    const zoneCount = Array.isArray(fridge.zones) ? fridge.zones.length : 0;
    const totalItems = countItemsInFridge(fridge);

    lines.push(`[${index + 1}] ${t("export_fridge")}: ${fridge.name}${fridge.location ? ` (${fridge.location})` : ""}`);
    lines.push(`    ${t("export_zone")}: ${zoneCount} | ${t("export_items")}: ${totalItems}`);
    lines.push(`    ${subDivider}`);

    if (!zoneCount) {
      lines.push(`    - ${t("empty_no_zone")}`);
      lines.push("");
      return;
    }

    fridge.zones.forEach((zone, zoneIndex) => {
      const zoneItems = Array.isArray(zone.items) ? zone.items.slice() : [];
      lines.push(`    (${zoneIndex + 1}) ${t("export_zone")}: ${zone.name} [${zoneTypeLabel(zone.type)}]`);
      lines.push(`        ${t("export_items")}: ${zoneItems.length} / ${zone.capacity}`);

      if (!zoneItems.length) {
        lines.push(`        - ${t("export_empty_zone")}`);
        lines.push("");
        return;
      }

      zoneItems
        .sort((a, b) => computeDaysLeft(a.expiryDate) - computeDaysLeft(b.expiryDate))
        .forEach((item, itemIndex) => {
          const days = computeDaysLeft(item.expiryDate);
          const status = deriveStatus(item, days);
          lines.push(
            `        ${itemIndex + 1}. ${item.name} | ${item.amount}${item.unit} | ${categoryLabel(item.category)} | ${getStatusLabel(status)}`
          );
          lines.push(`           + ${formatDate(item.addedDate)} -> ${formatDate(item.expiryDate)} | ${formatDaysLeft(days)}`);
          if (item.note) {
            lines.push(`           + note: ${item.note}`);
          }
        });
      lines.push("");
    });
    lines.push(divider);
  });

  return lines.join("\n");
}

function downloadTextFile(fileName, content) {
  const bom = "\uFEFF";
  const blob = new Blob([bom, content], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = fileName;
  link.style.display = "none";
  document.body.appendChild(link);
  link.click();
  link.remove();
  setTimeout(() => {
    URL.revokeObjectURL(url);
  }, 1000);
}

function onLibraryChipClick(event) {
  const button = event.target.closest("[data-library-id]");
  if (!button) return;
  const id = button.getAttribute("data-library-id");
  if (!id) return;
  const item = state.ingredientLibrary.find((entry) => entry.id === id);
  if (!item) return;
  applyLibraryTemplate(item);
}

function onSaveCurrentItemToLibrary() {
  const name = cleanText(els.itemName.value);
  if (!name) {
    showToast("请先填写食材名，再保存到食材库。");
    return;
  }
  const unit = cleanText(els.itemUnit.value) || "份";
  const category = CATEGORY_LABEL.zh[els.itemCategory.value] ? els.itemCategory.value : "other";
  const added = normalizeDate(els.itemAddedDate.value) || todayISO();
  const expiry = normalizeDate(els.itemExpiryDate.value) || todayISO();
  const days = Math.max(1, daysBetween(added, expiry));
  const note = cleanText(els.itemNote.value);

  const existing = findIngredientByExactName(name);
  const now = new Date().toISOString();
  if (existing) {
    if (existing.locked) {
      showToast("经典食材已存在，可直接引用。");
      return;
    }
    existing.unit = unit;
    existing.category = category;
    existing.defaultDaysValid = clamp(days, 1, 60);
    existing.note = note;
    existing.updatedAt = now;
    persistAndRender();
    renderLibrarySuggestions(els.itemLibraryQuery.value || name);
    showToast("已更新到食材库。");
    return;
  }

  state.ingredientLibrary.push({
    id: makeId(),
    name,
    aliases: [],
    unit,
    category,
    defaultDaysValid: clamp(days, 1, 60),
    note,
    locked: false,
    createdAt: now,
    updatedAt: now,
  });
  trimIngredientLibrary();
  persistAndRender();
  renderLibrarySuggestions(name);
  showToast("已保存到食材库。");
}

function onSaveLibraryItem(event) {
  event.preventDefault();
  const id = cleanText(els.libraryItemId.value);
  const name = cleanText(els.libraryName.value);
  const unit = cleanText(els.libraryUnit.value) || "份";
  const category = CATEGORY_LABEL.zh[els.libraryCategory.value] ? els.libraryCategory.value : "other";
  const defaultDaysValid = clamp(Math.round(toNumber(els.libraryDaysValid.value, 5)), 1, 60);
  const aliases = normalizeAliases(els.libraryAliases.value);
  const note = cleanText(els.libraryNote.value);

  if (!name) {
    showToast("食材名不能为空。");
    return;
  }

  const now = new Date().toISOString();
  if (id) {
    const target = state.ingredientLibrary.find((entry) => entry.id === id);
    if (!target) {
      showToast("未找到要编辑的食材库条目。");
      return;
    }
    if (target.locked) {
      showToast("经典食材不支持直接编辑，可新建自定义版本。");
      return;
    }
    target.name = name;
    target.unit = unit;
    target.category = category;
    target.defaultDaysValid = defaultDaysValid;
    target.aliases = aliases;
    target.note = note;
    target.updatedAt = now;
    trimIngredientLibrary();
    persistAndRender();
    resetLibraryForm();
    renderLibraryList();
    renderLibrarySuggestions(name);
    showToast("食材库已更新。");
    return;
  }

  const sameName = findIngredientByExactName(name);
  if (sameName) {
    if (sameName.locked) {
      showToast("经典食材已存在，建议使用别名区分。");
      return;
    }
    sameName.unit = unit;
    sameName.category = category;
    sameName.defaultDaysValid = defaultDaysValid;
    sameName.aliases = aliases;
    sameName.note = note;
    sameName.updatedAt = now;
    trimIngredientLibrary();
    persistAndRender();
    resetLibraryForm();
    renderLibraryList();
    renderLibrarySuggestions(name);
    showToast("已按同名覆盖自定义食材。");
    return;
  }

  state.ingredientLibrary.push({
    id: makeId(),
    name,
    aliases,
    unit,
    category,
    defaultDaysValid,
    note,
    locked: false,
    createdAt: now,
    updatedAt: now,
  });
  trimIngredientLibrary();
  persistAndRender();
  resetLibraryForm();
  renderLibraryList();
  renderLibrarySuggestions(name);
  showToast("已添加到食材库。");
}

function onLibraryListAction(event) {
  const actionNode = event.target.closest("[data-library-action]");
  if (!actionNode) return;
  const id = actionNode.getAttribute("data-library-id");
  const action = actionNode.getAttribute("data-library-action");
  if (!id || !action) return;

  const entry = state.ingredientLibrary.find((item) => item.id === id);
  if (!entry) return;

  if (action === "use") {
    applyLibraryTemplate(entry);
    openModal("item", { preserveFormState: true });
    return;
  }

  if (action === "edit") {
    if (entry.locked) {
      showToast("经典食材建议保留，可新增自定义版本。");
      return;
    }
    els.libraryItemId.value = entry.id;
    els.libraryName.value = entry.name;
    els.libraryUnit.value = entry.unit;
    els.libraryCategory.value = entry.category;
    els.libraryDaysValid.value = String(entry.defaultDaysValid);
    els.libraryAliases.value = entry.aliases.join(", ");
    els.libraryNote.value = entry.note || "";
    els.saveLibraryItemBtn.textContent = "更新食材";
    els.libraryName.focus();
    return;
  }

  if (action === "delete") {
    if (entry.locked) {
      showToast("经典食材不可删除。");
      return;
    }
    const ok = window.confirm(`删除食材库条目「${entry.name}」？`);
    if (!ok) return;
    state.ingredientLibrary = state.ingredientLibrary.filter((item) => item.id !== id);
    persistAndRender();
    resetLibraryForm();
    renderLibraryList();
    renderLibrarySuggestions(els.itemLibraryQuery.value);
    showToast("已删除食材库条目。");
  }
}

function findIngredientByExactName(name) {
  const token = searchToken(name);
  if (!token) return null;
  return state.ingredientLibrary.find((entry) => searchToken(entry.name) === token) || null;
}

function scoreLibraryMatch(entry, token) {
  if (!token) return entry.locked ? 8 : 6;

  const nameToken = searchToken(entry.name);
  let score = 0;

  if (nameToken === token) {
    score = 120;
  } else if (nameToken.startsWith(token)) {
    score = 98;
  } else if (nameToken.includes(token)) {
    score = 80;
  }

  for (const alias of entry.aliases) {
    const aliasToken = searchToken(alias);
    if (!aliasToken) continue;
    if (aliasToken === token) {
      score = Math.max(score, 114);
    } else if (aliasToken.startsWith(token)) {
      score = Math.max(score, 94);
    } else if (aliasToken.includes(token)) {
      score = Math.max(score, 76);
    }
  }

  if (score > 0 && entry.locked) {
    score += 2;
  }

  return score;
}

function findLibraryMatches(query, limit = MAX_LIBRARY_SUGGESTIONS) {
  const safeLimit = clamp(Math.round(toNumber(limit, MAX_LIBRARY_SUGGESTIONS)), 1, 40);
  const token = searchToken(query);
  const library = Array.isArray(state.ingredientLibrary) ? state.ingredientLibrary : [];
  if (!library.length) return [];

  if (!token) {
    return library.slice().sort(sortIngredientLibrary).slice(0, safeLimit);
  }

  return library
    .map((entry) => ({
      entry,
      score: scoreLibraryMatch(entry, token),
    }))
    .filter((row) => row.score > 0)
    .sort((a, b) => {
      if (a.score !== b.score) return b.score - a.score;
      if (a.entry.locked !== b.entry.locked) return a.entry.locked ? -1 : 1;
      if (a.entry.name.length !== b.entry.name.length) return a.entry.name.length - b.entry.name.length;
      return a.entry.name.localeCompare(b.entry.name, getCurrentLocale());
    })
    .slice(0, safeLimit)
    .map((row) => row.entry);
}

function findBestLibraryMatch(query) {
  const token = searchToken(query);
  if (!token) return null;
  const exact = state.ingredientLibrary.find((entry) => searchToken(entry.name) === token);
  if (exact) return exact;
  return findLibraryMatches(query, 1)[0] || null;
}

function applyLibraryTemplate(entry) {
  if (!entry) return;
  const template = normalizeIngredient(entry);
  if (!template) return;

  const added = normalizeDate(els.itemAddedDate.value) || todayISO();
  const expiry = dayOffsetFrom(added, template.defaultDaysValid);

  els.itemLibraryQuery.value = template.name;
  els.itemName.value = template.name;
  els.itemUnit.value = template.unit;
  els.itemCategory.value = template.category;
  els.itemAddedDate.value = added;
  els.itemExpiryDate.value = expiry;
  if (!cleanText(els.itemAmount.value) || toNumber(els.itemAmount.value, 0) <= 0) {
    els.itemAmount.value = "1";
  }
  if (!cleanText(els.itemNote.value) && template.note) {
    els.itemNote.value = template.note;
  }

  refreshItemDerivedOutputs();
  renderLibrarySuggestions(template.name);
  showToast(`已引用食材库：${template.name}`);
}

function resetLibraryForm() {
  els.libraryForm.reset();
  els.libraryItemId.value = "";
  els.libraryName.value = "";
  els.libraryUnit.value = "份";
  els.libraryCategory.value = "vegetable";
  els.libraryDaysValid.value = "5";
  els.libraryAliases.value = "";
  els.libraryNote.value = "";
  els.saveLibraryItemBtn.textContent = "保存到食材库";
}

function renderLibrarySuggestions(query = "") {
  const matches = findLibraryMatches(query, MAX_LIBRARY_SUGGESTIONS);
  els.librarySuggestions.innerHTML = matches
    .map(
      (entry) =>
        `<option value="${escapeHtml(entry.name)}">${escapeHtml(
          `${categoryLabel(entry.category)} · ${entry.unit} · ${entry.defaultDaysValid}${t("label_day")}`
        )}</option>`
    )
    .join("");

  if (!matches.length) {
    els.librarySuggestionChips.innerHTML = `<span class="chip-suggestion-tip">未命中，继续输入更短关键词。</span>`;
    return;
  }

  els.librarySuggestionChips.innerHTML = matches
    .map(
      (entry) => `
      <button type="button" class="chip-suggestion-btn" data-library-id="${entry.id}" aria-label="引用 ${escapeHtml(entry.name)}">
        <span class="chip-name">${escapeHtml(entry.name)}</span>
        <span class="chip-meta">${escapeHtml(entry.unit)} · ${entry.defaultDaysValid}天</span>
      </button>
    `
    )
    .join("");
}

function renderLibraryList() {
  const library = Array.isArray(state.ingredientLibrary) ? state.ingredientLibrary.slice().sort(sortIngredientLibrary) : [];
  els.libraryCount.textContent = String(library.length);

  if (!library.length) {
    els.libraryList.innerHTML = `<div class="empty-state">食材库为空，先新增一个常用食材。</div>`;
    return;
  }

  const visible = library.slice(0, MAX_LIBRARY_LIST);
  const html = visible
    .map((entry) => {
      const aliases = entry.aliases.length ? `别名：${entry.aliases.join(" / ")}` : "";
      const note = entry.note ? `备注：${entry.note}` : "";

      return `
        <article class="library-card ${entry.locked ? "locked" : ""}">
          <div class="library-head-row">
            <div>
              <div class="library-name-row">
                <strong>${escapeHtml(entry.name)}</strong>
                ${entry.locked ? `<span class="badge">经典</span>` : `<span class="badge">自定义</span>`}
              </div>
              <div class="library-base-meta">${categoryLabel(entry.category)} · ${escapeHtml(entry.unit)} · ${t("label_default")} ${entry.defaultDaysValid} ${t("label_day")}</div>
            </div>
            <div class="library-actions">
              ${libraryActionButtonMarkup("use", "引用", entry.id)}
              ${libraryActionButtonMarkup("edit", "编辑", entry.id, false, entry.locked)}
              ${libraryActionButtonMarkup("delete", "删除", entry.id, true, entry.locked)}
            </div>
          </div>
          ${aliases ? `<div class="library-extra">${escapeHtml(aliases)}</div>` : ""}
          ${note ? `<div class="library-extra">${escapeHtml(note)}</div>` : ""}
        </article>
      `;
    })
    .join("");

  const tail =
    library.length > MAX_LIBRARY_LIST
      ? `<div class="empty-state">已显示前 ${MAX_LIBRARY_LIST} 条，建议清理不常用自定义食材。</div>`
      : "";

  els.libraryList.innerHTML = html + tail;
}

function libraryActionButtonMarkup(action, label, id, danger = false, disabled = false) {
  return `
    <button
      type="button"
      class="mini-btn mini-btn-compact ${danger ? "danger" : ""}"
      data-library-action="${action}"
      data-library-id="${id}"
      aria-label="${label}"
      title="${label}"
      ${disabled ? "disabled" : ""}
    >
      <span class="mini-icon" aria-hidden="true">${libraryActionIcon(action)}</span>
      <span>${label}</span>
    </button>
  `;
}

function libraryActionIcon(action) {
  if (action === "use") {
    return '<svg viewBox="0 0 24 24"><path d="M11 4a1 1 0 1 1 2 0v6h6a1 1 0 1 1 0 2h-6v6a1 1 0 1 1-2 0v-6H5a1 1 0 1 1 0-2h6V4Z"/></svg>';
  }
  if (action === "edit") {
    return '<svg viewBox="0 0 24 24"><path d="M15.73 3.15a3 3 0 0 1 4.24 4.24l-9.7 9.7a1 1 0 0 1-.45.26l-4 1a1 1 0 0 1-1.21-1.21l1-4a1 1 0 0 1 .26-.45l9.86-9.54ZM6.1 14.6l-.54 2.15 2.15-.54 8.9-8.9-1.6-1.6-8.9 8.9Z"/></svg>';
  }
  return '<svg viewBox="0 0 24 24"><path d="M9 3a1 1 0 0 0-1 1v1H5a1 1 0 1 0 0 2h.07l1.1 12.11A3 3 0 0 0 9.16 22h5.68a3 3 0 0 0 2.99-2.89L18.93 7H19a1 1 0 1 0 0-2h-3V4a1 1 0 1 0-2 0v1h-4V4a1 1 0 0 0-1-1Zm-.92 4h7.84l-1.07 11.93a1 1 0 0 1-1 .92H10.15a1 1 0 0 1-1-.92L8.08 7Z"/></svg>';
}

function onActionFromList(event) {
  const button = event.target.closest("[data-item-action]");
  if (!button) return;

  const action = button.getAttribute("data-item-action");
  const zoneId = button.getAttribute("data-zone-id");
  const itemId = button.getAttribute("data-item-id");

  if (!action || !zoneId || !itemId) return;
  handleItemAction(action, zoneId, itemId);
}

function handleItemAction(action, zoneId, itemId) {
  const fridge = getActiveFridge();
  if (!fridge) return;

  const zone = fridge.zones.find((entry) => entry.id === zoneId);
  if (!zone) return;

  const item = zone.items.find((entry) => entry.id === itemId);
  if (!item) return;

  if (action === "edit") {
    startEditItem(zone, item);
    return;
  }

  if (action === "extend") {
    quickExtendExpiry(fridge, zone, item);
    return;
  }

  if (action === "consume") {
    completeItem(fridge, zone, item, "consumed");
    return;
  }

  if (action === "discard") {
    const ok = window.confirm(`确认丢弃「${item.name}」并移除？`);
    if (!ok) return;
    completeItem(fridge, zone, item, "wasted");
  }
}

function startEditItem(zone, item) {
  state.selectedZoneId = zone.id;

  els.itemId.value = item.id;
  els.itemSourceZoneId.value = zone.id;
  els.itemName.value = item.name;
  els.itemAmount.value = String(item.amount);
  els.itemUnit.value = item.unit;
  els.itemAddedDate.value = normalizeDate(item.addedDate) || todayISO();
  els.itemExpiryDate.value = normalizeDate(item.expiryDate) || todayISO();
  els.itemStatus.value = item.status || "Auto";
  els.itemCategory.value = CATEGORY_LABEL.zh[item.category] ? item.category : "other";
  els.itemNote.value = item.note || "";
  renderItemZoneOptions();
  els.itemZoneId.value = zone.id;

  els.itemSubmitBtn.textContent = "保存食材";
  els.cancelEditItemBtn.classList.remove("hidden");
  refreshItemDerivedOutputs();
  render();
  openModal("item", { preserveFormState: true });
  showToast(`正在编辑：${item.name}`);
}

function quickExtendExpiry(fridge, zone, item) {
  const days = computeDaysLeft(item.expiryDate);
  const add = days < 0 ? 1 : 2;
  const nextDate = dayOffsetFrom(item.expiryDate, add);
  item.expiryDate = nextDate;
  item.updatedAt = new Date().toISOString();
  zone.updatedAt = item.updatedAt;
  fridge.updatedAt = item.updatedAt;
  persistAndRender();
  showToast(`已将 ${item.name} 的到期日延后 ${add} 天。`);
}

function completeItem(fridge, zone, item, action) {
  zone.items = zone.items.filter((entry) => entry.id !== item.id);

  const now = new Date().toISOString();
  const daysLeft = computeDaysLeft(item.expiryDate);

  state.logs.unshift({
    id: makeId(),
    fridgeId: fridge.id,
    fridgeName: fridge.name,
    zoneName: zone.name,
    itemName: item.name,
    action,
    daysLeftAtAction: daysLeft,
    at: now,
  });

  if (state.logs.length > 500) {
    state.logs = state.logs.slice(0, 500);
  }

  zone.updatedAt = now;
  fridge.updatedAt = now;

  if (els.itemId.value === item.id) {
    resetItemForm();
  }

  persistAndRender();
  if (action === "consumed") {
    showToast(`已记录用完：${item.name}`);
  } else {
    showToast(`已记录丢弃：${item.name}`);
  }
}

function resetItemForm(keepTargetZone = false) {
  const fridge = getActiveFridge();
  const selectedZone = getSelectedZone(fridge);
  const preservedZoneId = keepTargetZone ? els.itemZoneId.value : selectedZone?.id;

  els.itemForm.reset();
  els.itemId.value = "";
  els.itemSourceZoneId.value = "";
  els.itemLibraryQuery.value = "";

  els.itemAmount.value = "1";
  els.itemUnit.value = "份";
  els.itemAddedDate.value = todayISO();
  els.itemExpiryDate.value = todayISO();
  els.itemStatus.value = "Auto";
  els.itemCategory.value = "vegetable";
  els.itemNote.value = "";

  renderItemZoneOptions();
  if (preservedZoneId && optionExists(els.itemZoneId, preservedZoneId)) {
    els.itemZoneId.value = preservedZoneId;
  }

  els.itemSubmitBtn.textContent = "添加食材";
  els.cancelEditItemBtn.classList.add("hidden");
  renderLibrarySuggestions("");
  refreshItemDerivedOutputs();
}

function refreshItemDerivedOutputs() {
  const amount = toNumber(els.itemAmount.value, 0);
  const days = computeDaysLeft(els.itemExpiryDate.value);
  const manualStatus = cleanText(els.itemStatus.value) || "Auto";
  const autoStatus = deriveStatus({ amount, status: "Auto" }, days);
  const displayStatus = manualStatus === "Auto" ? autoStatus : manualStatus;
  els.itemDaysLeft.textContent = `${formatDaysLeft(days)} | ${getStatusLabel(displayStatus)}`;
}

function computeStateMetrics() {
  const fridgeStats = new Map();
  let totalItems = 0;
  let totalExpired = 0;
  let totalRescue = 0;

  for (const fridge of state.fridges) {
    let fridgeItems = 0;
    let fridgeExpired = 0;
    let fridgeRescue = 0;

    for (const zone of fridge.zones) {
      for (const item of zone.items) {
        const days = computeDaysLeft(item.expiryDate);
        fridgeItems += 1;
        totalItems += 1;
        if (typeof days === "number" && days < 0) {
          fridgeExpired += 1;
          totalExpired += 1;
        } else if (typeof days === "number" && days <= 2) {
          fridgeRescue += 1;
          totalRescue += 1;
        }
      }
    }

    fridgeStats.set(fridge.id, { items: fridgeItems, expired: fridgeExpired, rescue: fridgeRescue });
  }

  return {
    totalItems,
    totalExpired,
    totalRescue,
    fridgeStats,
    logs30: getLogsInLastDays(30),
  };
}

function render() {
  if (ui.renderQueued) return;
  ui.renderQueued = true;

  const run = () => {
    ui.renderQueued = false;
    doRender();
  };

  if (typeof requestAnimationFrame === "function") {
    requestAnimationFrame(run);
    return;
  }

  setTimeout(run, 0);
}

function doRender() {
  ensureSelectionIntegrity();
  const metrics = computeStateMetrics();
  const activeFridge = getActiveFridge();
  const rescueQueue = activeFridge ? buildRescueQueue(activeFridge) : [];
  renderDoorState();
  renderGlobalKpi(metrics);
  renderActionButtons();
  renderFleet(metrics);
  renderAuditCard(rescueQueue);
  renderActiveFridgeSettings();
  renderRiskOverview(metrics);
  renderFridgeVisual();
  renderRescueList(rescueQueue);
  renderIdeaList(rescueQueue);
  renderZoneEditor();
  renderItemZoneOptions();
  renderZoneItemsList();
  renderLedger(metrics.logs30);
  if (ui.activeModalId === "item") {
    renderLibrarySuggestions(els.itemLibraryQuery.value);
  }
  if (ui.activeModalId === "library") {
    renderLibraryList();
  }
  if (ui.activeModalId === "manual") {
    renderManualContent();
  }
  refreshItemDerivedOutputs();
}

function renderActionButtons() {
  const fridge = getActiveFridge();
  const zone = getSelectedZone(fridge);

  els.openEditFridgeModalBtn.disabled = !fridge;
  els.openCreateZoneModalBtn.disabled = !fridge;
  els.openEditZoneModalBtn.disabled = !zone;
  els.openAddItemModalBtn.disabled = !fridge || !fridge.zones.length;
  els.openLibraryModalBtn.disabled = false;
  els.openManualModalBtn.disabled = false;
  els.openExportTxtBtn.disabled = !state.fridges.length;
}

function renderDoorState() {
  els.fridgeCabinet.classList.toggle("door-open", ui.doorOpen);
  els.toggleDoorBtn.textContent = ui.doorOpen ? t("toggle_close_door") : t("toggle_open_door");
}

function renderGlobalKpi(metrics) {
  const wastedCount = metrics.logs30.filter((log) => log.action === "wasted").length;

  els.globalKpi.innerHTML = `
    <span class="kpi-pill">${t("kpi_items")} ${metrics.totalItems}</span>
    <span class="kpi-pill">${t("kpi_rescue")} ${metrics.totalRescue}</span>
    <span class="kpi-pill">${t("kpi_expired")} ${metrics.totalExpired}</span>
    <span class="kpi-pill">${t("kpi_wasted_30")} ${wastedCount}</span>
  `;
}

function renderFleet(metrics) {
  if (!state.fridges.length) {
    els.fridgeFleet.innerHTML = `<div class="empty-state">${escapeHtml(t("empty_no_fridge"))}</div>`;
    return;
  }

  const html = state.fridges
    .map((fridge) => {
      const isActive = fridge.id === state.activeFridgeId;
      const stats = metrics.fridgeStats.get(fridge.id) || { items: 0, expired: 0, rescue: 0 };

      return `
        <button type="button" class="fleet-card ${isActive ? "active" : ""}" data-fridge-id="${fridge.id}" aria-label="切换到${escapeHtml(fridge.name)}">
          <div class="name">${escapeHtml(fridge.name)}</div>
          <div class="meta">${escapeHtml(fridge.location || "未设置位置")}</div>
          <div class="badge-row">
            <span class="badge">食材 ${stats.items}</span>
            <span class="badge">临期 ${stats.rescue}</span>
            <span class="badge">过期 ${stats.expired}</span>
          </div>
        </button>
      `;
    })
    .join("");

  els.fridgeFleet.innerHTML = html;
}

function renderAuditCard(rescueQueue = []) {
  const fridge = getActiveFridge();
  if (!fridge) {
    els.auditCard.innerHTML = `<div class="empty-state">请选择一个冰箱。</div>`;
    return;
  }

  const last = fridge.lastAuditDate ? fridge.lastAuditDate : "未检查";
  const streak = fridge.auditStreak || 0;
  const queue = rescueQueue.length;

  els.auditCard.innerHTML = `
    <div class="audit-main">连续检查 ${streak} 天</div>
    <div class="audit-sub">上次检查：${last}</div>
    <div class="audit-sub">当前待处理食材：${queue} 个</div>
  `;
}

function renderActiveFridgeSettings() {
  const fridge = getActiveFridge();
  if (!fridge) {
    els.activeFridgeName.value = "";
    els.activeFridgeLocation.value = "";
    els.activeFridgeTheme.value = DEFAULT_FRIDGE_THEME;
    renderFridgeThemePicker(DEFAULT_FRIDGE_THEME);
    els.deleteFridgeBtn.disabled = true;
    return;
  }

  if (els.activeFridgeName.value !== fridge.name) {
    els.activeFridgeName.value = fridge.name;
  }

  if (els.activeFridgeLocation.value !== (fridge.location || "")) {
    els.activeFridgeLocation.value = fridge.location || "";
  }

  const theme = normalizeFridgeTheme(fridge.theme);
  if (els.activeFridgeTheme.value !== theme) {
    els.activeFridgeTheme.value = theme;
  }
  renderFridgeThemePicker(theme);

  els.deleteFridgeBtn.disabled = countItemsInFridge(fridge) > 0;
}

function renderFridgeThemePicker(selectedTheme) {
  const activeTheme = normalizeFridgeTheme(selectedTheme);
  els.fridgeThemePicker.innerHTML = FRIDGE_THEME_OPTIONS.map((theme) => {
    const active = theme.id === activeTheme;
    return `
      <button
        type="button"
        class="theme-chip ${active ? "active" : ""}"
        data-theme-id="${theme.id}"
        role="radio"
        aria-checked="${active ? "true" : "false"}"
        aria-label="${themeLabel(theme)}"
        title="${themeLabel(theme)}"
      >
        <span class="theme-dot" style="--theme-color:${theme.preview}"></span>
        <span>${themeLabel(theme)}</span>
      </button>
    `;
  }).join("");
}

function renderRiskOverview(metrics) {
  const fridge = getActiveFridge();
  if (!fridge) {
    els.riskOverview.innerHTML = `<div class="empty-state">${escapeHtml(t("empty_no_fridge"))}</div>`;
    return;
  }

  const stats = metrics.fridgeStats.get(fridge.id) || { expired: 0, rescue: 0 };
  const zonesAtRisk = fridge.zones.filter((zone) =>
    zone.items.some((item) => {
      const days = computeDaysLeft(item.expiryDate);
      return typeof days === "number" && days <= 2;
    })
  ).length;

  els.riskOverview.innerHTML = `
    <article class="risk-card critical">
      <div class="label">${escapeHtml(statusLabel("Expired"))}</div>
      <div class="value">${stats.expired}</div>
      <div class="desc">立即处理，避免误食</div>
    </article>
    <article class="risk-card rescue">
      <div class="label">${escapeHtml(statusLabel("Rescue Now"))}</div>
      <div class="value">${stats.rescue}</div>
      <div class="desc">优先安排进餐或预处理</div>
    </article>
    <article class="risk-card value">
      <div class="label">${escapeHtml(t("btn_create_zone"))}</div>
      <div class="value">${zonesAtRisk}</div>
      <div class="desc">优先清空这些分区的临期食材</div>
    </article>
  `;
}

function renderFridgeVisual() {
  const fridge = getActiveFridge();
  if (!fridge) {
    applyFridgeTheme(DEFAULT_FRIDGE_THEME);
    els.fridgeTitle.textContent = t("fleet_title");
    els.fridgeSubtitle.textContent = t("empty_no_fridge");
    els.zoneGrid.innerHTML = `<div class="empty-state">${escapeHtml(t("empty_no_zone"))}</div>`;
    return;
  }

  applyFridgeTheme(fridge.theme);
  const selectedZone = getSelectedZone(fridge);
  els.fridgeTitle.textContent = fridge.name;
  els.fridgeSubtitle.textContent = `${fridge.location || "未设置位置"} · 当前分区：${selectedZone ? selectedZone.name : "无"}`;

  if (!fridge.zones.length) {
    els.zoneGrid.innerHTML = `<div class="empty-state">${escapeHtml(t("empty_no_zone"))}</div>`;
    return;
  }

  const html = fridge.zones
    .map((zone) => {
      const selected = zone.id === state.selectedZoneId;
      const occupancy = zone.capacity ? Math.min(100, Math.round((zone.items.length / zone.capacity) * 100)) : 0;
      const expired = zone.items.filter((item) => computeDaysLeft(item.expiryDate) < 0).length;
      const rescue = zone.items.filter((item) => {
        const days = computeDaysLeft(item.expiryDate);
        return days >= 0 && days <= 2;
      }).length;

      let riskClass = "risk-fresh";
      if (expired > 0) {
        riskClass = "risk-expired";
      } else if (rescue > 0) {
        riskClass = "risk-rescue";
      }

      return `
        <button type="button" class="zone-card ${riskClass} ${selected ? "selected" : ""}" data-zone-id="${zone.id}" aria-label="选择分区 ${escapeHtml(zone.name)}">
          <div class="zone-head">
            <span class="zone-name">${escapeHtml(zone.name)}</span>
            <span class="zone-type">${zoneTypeLabel(zone.type)}</span>
          </div>
          <div class="zone-meta">${zone.items.length} / ${zone.capacity} 占用</div>
          <div class="capacity-track"><div class="capacity-fill" style="width:${occupancy}%"></div></div>
          <div class="zone-foot">
            <span>过期 ${expired}</span>
            <span>优先 ${rescue}</span>
          </div>
        </button>
      `;
    })
    .join("");

  els.zoneGrid.innerHTML = html;
}

function applyFridgeTheme(themeId) {
  const targetTheme = normalizeFridgeTheme(themeId);
  for (const option of FRIDGE_THEME_OPTIONS) {
    els.fridgeCabinet.classList.remove(`theme-${option.id}`);
  }
  els.fridgeCabinet.classList.add(`theme-${targetTheme}`);
}

function renderRescueList(rescueQueue = []) {
  const fridge = getActiveFridge();
  if (!fridge) {
    els.rescueList.innerHTML = `<div class="empty-state">${escapeHtml(t("empty_no_fridge"))}</div>`;
    return;
  }

  if (!rescueQueue.length) {
    els.rescueList.innerHTML = `<div class="empty-state">${escapeHtml(t("empty_no_idea"))}</div>`;
    return;
  }

  const html = rescueQueue
    .slice(0, MAX_RENDERED_RESCUE)
    .map((entry) => {
      const days = computeDaysLeft(entry.item.expiryDate);
      const status = deriveStatus(entry.item, days);
      const severity = severityClass(status, days);
      const recommendation = getRecommendation(entry.item, status, days);

      return `
        <article class="rescue-card">
          <div class="rescue-head">
            <div>
              <div class="rescue-item">${escapeHtml(entry.item.name)}</div>
              <div class="rescue-meta">${escapeHtml(entry.zone.name)} · ${entry.item.amount}${escapeHtml(entry.item.unit)}</div>
            </div>
            <span class="severity-chip ${severity}">${escapeHtml(getStatusLabel(status))}</span>
          </div>
          <div class="recommend">${escapeHtml(recommendation)} · 剩余 ${formatDaysLeft(days)}</div>
          <div class="mini-actions">
            ${actionButtonMarkup("edit", "编辑", entry.zone.id, entry.item.id)}
            ${actionButtonMarkup("consume", "用完", entry.zone.id, entry.item.id)}
            ${actionButtonMarkup("discard", "丢弃", entry.zone.id, entry.item.id, true)}
          </div>
        </article>
      `;
    })
    .join("");

  els.rescueList.innerHTML = html;
}

function renderIdeaList(rescueQueue = []) {
  const fridge = getActiveFridge();
  if (!fridge) {
    els.ideaList.innerHTML = `<div class="empty-state">${escapeHtml(t("empty_no_fridge"))}</div>`;
    return;
  }

  const ideas = buildMealIdeas(fridge, rescueQueue);
  if (!ideas.length) {
    els.ideaList.innerHTML = `<div class="empty-state">${escapeHtml(t("empty_no_idea"))}</div>`;
    return;
  }

  els.ideaList.innerHTML = ideas
    .map(
      (idea) => `
      <article class="idea-card">
        <div class="idea-title">${escapeHtml(idea.title)}</div>
        <div class="idea-desc">${escapeHtml(idea.desc)}</div>
      </article>
    `
    )
    .join("");
}

function renderZoneEditor() {
  const fridge = getActiveFridge();
  const zone = getSelectedZone(fridge);

  const hasZone = Boolean(zone);
  els.editZoneName.disabled = !hasZone;
  els.editZoneType.disabled = !hasZone;
  els.editZoneCapacity.disabled = !hasZone;
  els.deleteZoneBtn.disabled = !hasZone || zone.items.length > 0 || fridge.zones.length <= 1;

  if (!hasZone) {
    els.editZoneName.value = "";
    els.editZoneType.value = "other";
    els.editZoneCapacity.value = "18";
    return;
  }

  if (els.editZoneName.value !== zone.name) {
    els.editZoneName.value = zone.name;
  }
  els.editZoneType.value = zone.type;
  els.editZoneCapacity.value = String(zone.capacity);
}

function renderItemZoneOptions() {
  const fridge = getActiveFridge();
  if (!fridge || !fridge.zones.length) {
    els.itemZoneId.innerHTML = "";
    els.itemSubmitBtn.disabled = true;
    return;
  }

  const previous = els.itemZoneId.value;
  els.itemZoneId.innerHTML = fridge.zones
    .map((zone) => `<option value="${zone.id}">${escapeHtml(zone.name)} (${zoneTypeLabel(zone.type)})</option>`)
    .join("");

  if (previous && optionExists(els.itemZoneId, previous)) {
    els.itemZoneId.value = previous;
  } else if (state.selectedZoneId && optionExists(els.itemZoneId, state.selectedZoneId)) {
    els.itemZoneId.value = state.selectedZoneId;
  } else {
    els.itemZoneId.value = fridge.zones[0].id;
  }

  els.itemSubmitBtn.disabled = false;
}

function renderZoneItemsList() {
  const fridge = getActiveFridge();
  const zone = getSelectedZone(fridge);

  if (!zone) {
    els.zoneItemsTitle.textContent = t("zone_items_title");
    els.zoneItemsList.innerHTML = `<div class="empty-state">请选择一个分区查看食材。</div>`;
    return;
  }

  els.zoneItemsTitle.textContent = `${t("zone_items_title")}：${zone.name}`;

  if (!zone.items.length) {
    els.zoneItemsList.innerHTML = `<div class="empty-state">该分区为空，建议先录入最近购买的食材。</div>`;
    return;
  }

  const html = zone.items
    .slice()
    .sort((a, b) => computeDaysLeft(a.expiryDate) - computeDaysLeft(b.expiryDate))
    .slice(0, MAX_RENDERED_ZONE_ITEMS)
    .map((item) => {
      const days = computeDaysLeft(item.expiryDate);
      const status = deriveStatus(item, days);
      const sev = severityClass(status, days);

      return `
        <article class="item-card">
          <div class="item-head">
            <div>
              <div class="item-name">${escapeHtml(item.name)}</div>
              <div class="item-meta">${item.amount}${escapeHtml(item.unit)} · ${categoryLabel(item.category)}</div>
            </div>
            <span class="severity-chip ${sev}">${escapeHtml(getStatusLabel(status))}</span>
          </div>
          <div class="item-grid">
            <div>添加：${formatDate(item.addedDate)}</div>
            <div>到期：${formatDate(item.expiryDate)}</div>
            <div>剩余：${formatDaysLeft(days)}</div>
            <div>状态：${escapeHtml(getStatusLabel(status))}</div>
          </div>
          <div class="mini-actions">
            ${actionButtonMarkup("edit", "编辑", zone.id, item.id)}
            ${actionButtonMarkup("consume", "用完", zone.id, item.id)}
            ${actionButtonMarkup("extend", "延期", zone.id, item.id)}
            ${actionButtonMarkup("discard", "丢弃", zone.id, item.id, true)}
          </div>
        </article>
      `;
    })
    .join("");

  els.zoneItemsList.innerHTML = html;
}

function renderLedger(logs30) {
  const safeLogs = Array.isArray(logs30) ? logs30 : getLogsInLastDays(30);
  const wasted = safeLogs.filter((log) => log.action === "wasted");
  const consumed = safeLogs.filter((log) => log.action === "consumed");

  const rescueConsumed = consumed.filter((log) => log.daysLeftAtAction <= 2).length;

  els.ledgerSummary.innerHTML = `
    近30天丢弃次数：<strong>${wasted.length}</strong><br />
    近30天优先处理：<strong>${rescueConsumed}</strong> 次
  `;

  if (!safeLogs.length) {
    els.ledgerList.innerHTML = `<div class="empty-state">${escapeHtml(t("empty_no_log"))}</div>`;
    return;
  }

  els.ledgerList.innerHTML = safeLogs
    .slice(0, MAX_RENDERED_LEDGER)
    .map((log) => {
      const actionText = log.action === "wasted" ? "丢弃" : "用完";
      return `
        <article class="ledger-entry">
          <div class="left">${escapeHtml(log.itemName)} · ${actionText}<br />${escapeHtml(log.fridgeName || "冰箱")} / ${escapeHtml(log.zoneName || "分区")}</div>
          <div class="right">${formatDaysLeft(log.daysLeftAtAction)}<br />${formatDate(log.at)}</div>
        </article>
      `;
    })
    .join("");
}

function buildRescueQueue(fridge) {
  const entries = flattenFridgeItems(fridge)
    .map((entry) => {
      const days = computeDaysLeft(entry.item.expiryDate);
      const status = deriveStatus(entry.item, days);
      return {
        ...entry,
        days,
        status,
        score: rescueScore(entry.item, days),
      };
    })
    .filter((entry) => {
      if (entry.status === "Consumed") return false;
      if (typeof entry.days !== "number") return false;
      return entry.days <= 2;
    })
    .sort((a, b) => b.score - a.score);

  return entries;
}

function buildMealIdeas(fridge, rescueQueue = []) {
  const queue = rescueQueue.length ? rescueQueue : buildRescueQueue(fridge);
  const rescueItems = queue.map((entry) => entry.item);
  const has = (category) => rescueItems.some((item) => item.category === category);
  const picks = pickNames(rescueItems, 3);

  const ideas = [];

  if (has("vegetable") && has("protein")) {
    ideas.push({
      title: "快手炒菜组合",
      desc: "把临期蔬菜和蛋白一起快炒，优先处理两天内到期食材。",
    });
  }

  if (has("dairy") && (has("fruit") || has("drink"))) {
    ideas.push({
      title: "早餐奶昔组合",
      desc: "把乳制品和水果/饮品组合成早餐，减少开封后继续变质。",
    });
  }

  if (has("leftover")) {
    ideas.push({
      title: "剩菜翻新餐",
      desc: "先处理剩菜分区，今天加热后搭配主食优先吃完。",
    });
  }

  if (has("drink")) {
    ideas.push({
      title: "饮品优先日",
      desc: "把临期饮品集中安排在今天，避免零散放到过期。",
    });
  }

  if (queue.length) {
    ideas.push({
      title: "今晚必清单",
      desc: `优先处理：${picks.join("、")}。按先到期先使用的顺序安排。`,
    });
  } else {
    ideas.push({
      title: "维持好状态",
      desc: "当前无高风险食材。建议保持每日检查，继续执行先进先出。",
    });
  }

  return ideas.slice(0, 4);
}

function rescueScore(item, daysLeft) {
  const urgency = daysLeft < 0 ? 100 : Math.max(0, 85 - daysLeft * 20);
  const volume = Math.min(12, item.amount * 1.2);
  return urgency + volume;
}

function deriveStatus(item, daysLeft) {
  if (item.status && item.status !== "Auto") {
    return item.status;
  }

  if (item.amount <= 0) return "Consumed";
  if (typeof daysLeft !== "number") return "Watch";
  if (daysLeft < 0) return "Expired";
  if (daysLeft === 0) return "Critical";
  if (daysLeft <= 2) return "Rescue Now";
  if (daysLeft <= 5) return "Watch";
  return "Fresh";
}

function severityClass(status, daysLeft) {
  if (status === "Expired" || status === "Critical" || daysLeft < 0) {
    return "severity-critical";
  }
  if (status === "Rescue Now") {
    return "severity-rescue";
  }
  if (status === "Watch") {
    return "severity-watch";
  }
  return "severity-fresh";
}

function getRecommendation(item, status, daysLeft) {
  if (status === "Expired") {
    return "已过期，立即处理并记录原因";
  }
  if (status === "Critical") {
    return "建议今天优先使用或进行分装保存";
  }
  if (status === "Rescue Now") {
    return "建议在48小时内安排使用";
  }
  if (status === "Watch") {
    return "建议本周内使用，避免进入高风险";
  }
  return `保持先进先出，${categoryLabel(item.category) || "食材"}状态稳定`;
}

function getStatusLabel(status) {
  return statusLabel(status);
}

function actionButtonMarkup(action, label, zoneId, itemId, danger = false) {
  return `
    <button
      type="button"
      class="mini-btn ${danger ? "danger" : ""}"
      data-item-action="${action}"
      data-zone-id="${zoneId}"
      data-item-id="${itemId}"
      aria-label="${label}"
      title="${label}"
    >
      <span class="mini-icon" aria-hidden="true">${actionIcon(action)}</span>
      <span>${label}</span>
    </button>
  `;
}

function actionIcon(action) {
  if (action === "edit") {
    return '<svg viewBox="0 0 24 24"><path d="M15.73 3.15a3 3 0 0 1 4.24 4.24l-9.7 9.7a1 1 0 0 1-.45.26l-4 1a1 1 0 0 1-1.21-1.21l1-4a1 1 0 0 1 .26-.45l9.86-9.54ZM6.1 14.6l-.54 2.15 2.15-.54 8.9-8.9-1.6-1.6-8.9 8.9Z"/></svg>';
  }
  if (action === "consume") {
    return '<svg viewBox="0 0 24 24"><path d="M20.7 5.3a1 1 0 0 0-1.4 0L9.75 14.84 5.7 10.8a1 1 0 1 0-1.4 1.4l4.75 4.76a1 1 0 0 0 1.4 0L20.7 6.7a1 1 0 0 0 0-1.4Z"/></svg>';
  }
  if (action === "extend") {
    return '<svg viewBox="0 0 24 24"><path d="M12 2a1 1 0 0 1 1 1v1.06a8 8 0 1 1-6.32 2.6 1 1 0 0 1 1.5 1.32A6 6 0 1 0 12 6V7a1 1 0 1 1-2 0V3a1 1 0 0 1 1-1h1Zm0 5a1 1 0 0 1 1 1v3h2a1 1 0 1 1 0 2h-3a1 1 0 0 1-1-1V8a1 1 0 0 1 1-1Z"/></svg>';
  }
  return '<svg viewBox="0 0 24 24"><path d="M9 3a1 1 0 0 0-1 1v1H5a1 1 0 1 0 0 2h.07l1.1 12.11A3 3 0 0 0 9.16 22h5.68a3 3 0 0 0 2.99-2.89L18.93 7H19a1 1 0 1 0 0-2h-3V4a1 1 0 1 0-2 0v1h-4V4a1 1 0 0 0-1-1Zm-.92 4h7.84l-1.07 11.93a1 1 0 0 1-1 .92H10.15a1 1 0 0 1-1-.92L8.08 7Z"/></svg>';
}

function countItemsInFridge(fridge) {
  return fridge.zones.reduce((sum, zone) => sum + zone.items.length, 0);
}

function countTotalItems(fridges) {
  const source = Array.isArray(fridges) ? fridges : [];
  let total = 0;
  for (const fridge of source) {
    if (!fridge || !Array.isArray(fridge.zones)) continue;
    for (const zone of fridge.zones) {
      if (!zone || !Array.isArray(zone.items)) continue;
      total += zone.items.length;
    }
  }
  return total;
}

function flattenFridgeItems(fridge) {
  return fridge.zones.flatMap((zone) => zone.items.map((item) => ({ zone, item })));
}

function flattenAllItems(fridges) {
  return fridges.flatMap((fridge) =>
    fridge.zones.flatMap((zone) => zone.items.map((item) => ({ fridge, zone, item })))
  );
}

function getLogsInLastDays(days) {
  const threshold = Date.now() - days * DAY_MS;
  return state.logs.filter((log) => new Date(log.at).getTime() >= threshold);
}

function pickNames(items, limit) {
  return items
    .slice(0, limit)
    .map((item) => item.name)
    .filter(Boolean);
}

function getCachedTodayBaseMs() {
  const today = todayISO();
  if (ui.daysCacheDate !== today) {
    ui.daysCacheDate = today;
    ui.daysCacheTodayMs = parseISODate(today).getTime();
    ui.daysLeftCache.clear();
  }
  return ui.daysCacheTodayMs;
}

function computeDaysLeft(dateLike) {
  const normalized = normalizeDate(dateLike);
  if (!normalized) return null;

  const baseMs = getCachedTodayBaseMs();
  const cached = ui.daysLeftCache.get(normalized);
  if (typeof cached === "number") {
    return cached;
  }

  const expiryMs = parseISODate(normalized).getTime();
  const days = Math.ceil((expiryMs - baseMs) / DAY_MS);

  if (ui.daysLeftCache.size >= MAX_DAYS_LEFT_CACHE) {
    ui.daysLeftCache.clear();
  }
  ui.daysLeftCache.set(normalized, days);
  return days;
}

function daysBetween(startISO, endISO) {
  const start = parseISODate(startISO);
  const end = parseISODate(endISO);
  return Math.round((end.getTime() - start.getTime()) / DAY_MS);
}

function dayOffsetISO(offset) {
  const base = parseISODate(todayISO());
  base.setDate(base.getDate() + offset);
  return normalizeDate(base);
}

function dayOffsetFrom(dateLike, offset) {
  const base = parseISODate(normalizeDate(dateLike) || todayISO());
  base.setDate(base.getDate() + offset);
  return normalizeDate(base);
}

function todayISO() {
  const now = new Date();
  return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}-${String(now.getDate()).padStart(2, "0")}`;
}

function normalizeDate(value) {
  if (!value) return null;

  if (typeof value === "string" && /^\d{4}-\d{2}-\d{2}$/.test(value.trim())) {
    return value.trim();
  }

  const date = new Date(value);
  if (Number.isNaN(date.getTime())) return null;

  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
}

function parseISODate(iso) {
  const normalized = normalizeDate(iso) || todayISO();
  const [y, m, d] = normalized.split("-").map(Number);
  return new Date(y, m - 1, d);
}

function formatDate(value) {
  return normalizeDate(value) || "--";
}

function formatDaysLeft(days) {
  if (typeof days !== "number") return "--";
  if (days < 0) return `超期 ${Math.abs(days)} 天`;
  if (days === 0) return "今天到期";
  return `${days} 天`;
}

function clamp(value, min, max) {
  return Math.min(max, Math.max(min, value));
}

function toNumber(value, fallback) {
  const num = Number(value);
  return Number.isFinite(num) ? num : fallback;
}

function cleanText(value) {
  return String(value ?? "")
    .replace(/\s+/g, " ")
    .trim();
}

function optionExists(selectEl, value) {
  return Array.from(selectEl.options).some((option) => option.value === value);
}

function escapeHtml(value) {
  return String(value ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
}

function makeId() {
  if (window.crypto?.randomUUID) return window.crypto.randomUUID();
  return `id-${Date.now()}-${Math.random().toString(16).slice(2)}`;
}

function showToast(message) {
  els.toast.textContent = message;
  els.toast.classList.add("show");

  if (ui.toastTimer) {
    clearTimeout(ui.toastTimer);
  }

  ui.toastTimer = setTimeout(() => {
    els.toast.classList.remove("show");
  }, 2000);
}

function setupSpeechRecognition() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    els.voiceButtons.forEach((button) => {
      button.disabled = true;
      button.setAttribute("aria-label", "当前浏览器不支持语音输入");
    });
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  recognition.lang = navigator.language || "zh-CN";

  recognition.addEventListener("result", (event) => {
    const transcript = (event.results?.[0]?.[0]?.transcript || "").trim();
    if (!transcript || !ui.recordingButton) return;

    const targetId = ui.recordingButton.getAttribute("data-voice-target");
    const target = document.getElementById(targetId);
    if (!target) return;

    target.value = transcript;
    target.dispatchEvent(new Event("input", { bubbles: true }));
    showToast("语音输入成功。");
  });

  recognition.addEventListener("error", (event) => {
    const message = event.error === "not-allowed" ? "麦克风权限被拒绝。" : `语音输入失败：${event.error}`;
    showToast(message);
  });

  recognition.addEventListener("end", () => {
    stopVoiceUI();
  });

  ui.speech = recognition;
}

function onToggleVoice(button) {
  if (!ui.speech) {
    showToast("当前浏览器不支持语音输入。");
    return;
  }

  if (ui.recordingButton && ui.recordingButton !== button) {
    try {
      ui.speech.stop();
    } catch (_err) {
      // ignore
    }
    stopVoiceUI();
  }

  if (ui.recordingButton === button) {
    ui.speech.stop();
    return;
  }

  ui.recordingButton = button;
  button.classList.add("recording");
  button.setAttribute("aria-pressed", "true");

  showToast("开始语音输入...");
  try {
    ui.speech.start();
  } catch (_err) {
    stopVoiceUI();
    showToast("无法启动语音，请重试。");
  }
}

function stopVoiceUI() {
  if (!ui.recordingButton) return;
  ui.recordingButton.classList.remove("recording");
  ui.recordingButton.setAttribute("aria-pressed", "false");
  ui.recordingButton = null;
}

    </script>
      <script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js").catch(() => {
      // Ignore service worker registration failure.
    });
  });
}
    </script>
  </body>
</html>
